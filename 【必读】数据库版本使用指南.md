# 沐梧AI解题系统 - 数据库版本使用指南 V25.2

## 🎯 版本特点

**数据库版本 (mode=db)** 是在**本地版本 (mode=old)** 的基础上，添加了：
- ✅ **用户登录注册系统**（账号密码认证）
- ✅ **MySQL云端数据存储**（错题、会话历史）
- ✅ **多用户数据隔离**（每个用户独立数据）
- ✅ **自动错题保存**（批改模式自动识别并保存错题）

**保持不变的功能**（与本地版本完全一致）：
- ✅ AI智能解题 + AI批改作业
- ✅ 图片裁剪 + 三种解题模式（单题/整页/指定题目）
- ✅ MathJax公式渲染
- ✅ 快捷按钮（继续回答/检查错误）
- ✅ 连续对话
- ✅ 历史会话管理
- ✅ 智能错题本 + AI出题

---

## 🚀 快速开始

### 1. 启动系统

**双击运行：** `【启动】数据库版本系统.bat`

启动脚本会自动：
1. 启动后端服务（FastAPI + MySQL）
2. 启动前端服务（React + Vite）
3. 打开浏览器窗口

### 2. 访问地址

```
http://localhost:5173/?mode=db
```

> 💡 **提示**：首次访问会看到登录界面

---

## 🔐 用户认证

### 注册新账号

1. 点击"还没有账号？立即注册"
2. 输入：
   - **账号**（必填，唯一标识）
   - **密码**（必填，至少6位）
   - **昵称**（可选，默认使用账号）
3. 点击"注册"
4. 注册成功后，自动跳转到登录界面

### 登录账号

1. 输入账号和密码
2. 点击"登录"
3. 成功后进入功能模式选择界面

### 退出登录

- 在任何界面点击右上角"退出登录"按钮
- 退出后回到登录界面，数据已自动保存到数据库

---

## 📚 三大功能模式

登录后，选择以下三种模式之一：

### 1. 🧠 AI 智能解题

- **功能**：上传题目图片，AI详细解答
- **适用场景**：不会做的难题、想看完整解题过程
- **操作步骤**：
  1. 选择解题模式（单题/整页/指定题目）
  2. 上传题目图片
  3. （可选）裁剪特定区域
  4. 点击"解析"
  5. 查看AI解答 + 连续追问

### 2. 📝 AI 批改作业

- **功能**：上传包含题目与答案的图片，AI批改并指出对错
- **✨ 特色**：**自动识别错题并保存到数据库**
- **操作步骤**：
  1. 选择批改模式（单题/整页/指定题目）
  2. 上传包含答案的图片
  3. 点击"批改"
  4. AI会指出：
     - ✅ 答案正确：简单确认
     - ❌ 答案错误：详细说明 + 正确解法 + **自动保存到错题本**
  5. 错题自动包含知识点标签

### 3. 📚 智能错题本

- **功能**：管理所有错题 + AI智能出题
- **数据来源**：
  - 批改模式自动保存的错题
  - 手动添加的错题
- **核心功能**：
  - 查看错题列表（按科目/知识点筛选）
  - AI智能出题（基于错题生成练习）
  - PDF导出试卷
  - 编辑/删除错题

---

## 💬 连续对话功能

### 快捷按钮

AI首次回答后，会出现两个快捷按钮：

- **💬 请继续回答**：AI继续补充内容
- **🔍 请检查回答是否有误**：AI自查并修正

### 自由追问

在输入框输入任何问题：
- "请解释一下第3步"
- "还有其他方法吗？"
- "这道题的考点是什么？"

AI会基于上下文回答，无需重新上传图片！

---

## 📋 历史会话管理

### 查看历史

点击顶部"📚 历史记录"按钮，侧边栏显示：
- 会话缩略图（题目图片）
- 会话标题（自动提取）
- 创建时间

### 恢复会话

点击历史记录中的任一会话，立即恢复：
- 原题目图片
- 完整对话历史
- 可继续追问（需后端服务未重启）

### 删除会话

点击会话右侧的"🗑️"按钮，确认后删除（数据库同步删除）

### 新建会话

点击"➕ 新对话"按钮，开始新的解题对话

---

## 🧮 公式渲染

系统自动识别并渲染：

- **LaTeX公式**：`$公式$` 或 `$$公式$$`
- **行内公式**：`\(公式\)`
- **块级公式**：`\[公式\]`

例如：
```
$x^2 + y^2 = r^2$
\[ \int_{a}^{b} f(x) dx \]
```

会自动渲染为精美的数学公式！

---

## 🎯 错题本高级功能

### 1. 查看错题列表

- 按**知识点**筛选
- 按**科目**筛选
- 显示错题图片、AI分析、知识点标签

### 2. AI智能出题

基于错题生成针对性练习题：

**四种生成模式**：

#### (1) 基础模式（纯文本）
- 快速生成类似题目
- 纯文字 + LaTeX公式
- 适合简单知识点

#### (2) SVG图形模式
- 生成带矢量图的题目
- 适合几何题、函数图像
- AI生成SVG代码

#### (3) 网络辅助模式 ⭐
- 从互联网搜索真实题目
- 爬取教育网站（菁优网、组卷网等）
- 包含真实图片和结构化题目
- **推荐用于需要精确图形的题目**

#### (4) 混合模式
- 结合以上三种方式
- 先尝试网络搜索
- 失败则降级为SVG/文本
- 最智能的选择

### 3. PDF导出

生成的试卷可以导出为PDF：
- 保留完整格式
- 公式正确渲染
- 包含题目图片
- 适合打印

---

## ⚙️ 技术架构

### 前端技术栈
- React 18 + TypeScript
- Vite（开发服务器）
- MathJax（公式渲染）
- react-image-crop（图片裁剪）
- marked（Markdown解析）

### 后端技术栈
- FastAPI（Python Web框架）
- MySQL（数据库）
- JWT（用户认证）
- 通义千问VL-Max（多模态AI）
- 通义千问Turbo（文本AI）
- Beautiful Soup 4（网页爬取）

### 数据库设计
- **user**：用户表（账号、密码、昵称）
- **subject**：题目表（题目内容、解答、知识点）
- **exam**：试卷表（错题本、练习题集）
- **user_exam**：用户-题目关联表（答题记录、状态）

---

## 🔧 常见问题

### Q1: 登录后提示"401 Unauthorized"？

**原因**：JWT令牌过期或无效

**解决**：
1. 退出登录
2. 重新登录即可

### Q2: 公式显示为LaTeX源代码？

**原因**：MathJax未加载完成

**解决**：
1. 刷新页面（F5）
2. 等待3-5秒让MathJax加载
3. 检查浏览器控制台是否有MathJax加载错误

### Q3: 历史对话恢复后无法继续追问？

**原因**：后端服务重启，内存中的会话丢失

**解决**：
- 查看历史对话内容（完整保存在数据库）
- 开启新对话重新上传图片
- *未来版本*：会话持久化到数据库

### Q4: 批改模式下错题没有自动保存？

**检查**：
1. AI回答中是否包含"错误"关键词？
2. 是否上传了图片？（只有图片批改才会保存）
3. 查看浏览器控制台日志

**提示**：系统通过关键词识别错题，AI必须明确指出"答案错误"

### Q5: 网络辅助出题找不到题目？

**原因**：
- 搜索关键词不精确
- 目标网站未收录相关题目
- 网络连接问题

**解决**：
- 选择"混合模式"（自动降级）
- 调整知识点描述（更具体）
- 使用基础模式（不依赖网络）

### Q6: PDF导出失败？

**检查**：
1. 是否已生成题目？
2. 浏览器是否阻止弹窗/下载？
3. 后端日志是否有错误？

**解决**：
- 允许浏览器弹窗/下载
- 检查后端日志（Pyppeteer错误）
- 重启后端服务

---

## 📊 数据安全

### 用户数据隔离
- 每个用户只能访问自己的数据
- JWT令牌验证所有请求
- 数据库层面user_id隔离

### 密码安全
- 使用bcrypt加密存储
- 不明文传输或存储
- JWT令牌有效期24小时

### 数据备份
- 建议定期备份MySQL数据库
- 错题本数据永久保存
- 会话历史可随时恢复

---

## 🎓 最佳实践

### 1. 解题模式选择

| 场景 | 推荐模式 | 理由 |
|------|---------|------|
| 单道难题 | 单题模式 + 裁剪 | 精确识别，减少干扰 |
| 整页作业 | 整页模式 | 一次性处理，效率高 |
| 只做某几题 | 指定题目模式 | AI精准定位目标题目 |

### 2. 批改模式使用

- **上传清晰图片**：包含题目 + 你的答案
- **写完整答案**：AI才能准确判断对错
- **手写字迹清晰**：提升OCR识别率

### 3. 错题本管理

- **及时添加知识点标签**：方便筛选
- **定期复习错题**：巩固薄弱环节
- **AI出题练习**：举一反三

### 4. 公式输入技巧

追问时需要输入公式：
```
行内公式：$x^2$
块级公式：$$\frac{a}{b}$$
```

---

## 🔄 版本对比

| 功能 | 本地版本 (mode=old) | 数据库版本 (mode=db) |
|------|---------------------|----------------------|
| 用户认证 | ❌ | ✅ 登录注册 |
| 数据存储 | localStorage（浏览器本地） | MySQL（云端） |
| 多用户支持 | ❌ | ✅ 数据隔离 |
| 解题/批改 | ✅ | ✅ |
| 错题本 | ✅ JSON文件 | ✅ MySQL |
| AI出题 | ✅ | ✅ |
| 公式渲染 | ✅ | ✅ |
| 历史会话 | ✅ localStorage | ✅ MySQL |
| 自动保存错题 | ❌ | ✅ |

---

## 📞 技术支持

### 问题反馈
- GitHub Issues（如有仓库）
- 邮件联系项目负责人

### 日志查看
- **前端日志**：浏览器控制台（F12）
- **后端日志**：终端/命令行窗口

### 调试模式
打开浏览器控制台（F12），查看详细日志：
```
[MathJax] 渲染成功
[会话保存] 成功
[消息更新] 追问模式
```

---

## 🎉 开始使用

1. ✅ **双击启动脚本** `【启动】数据库版本系统.bat`
2. ✅ **注册账号** → **登录**
3. ✅ **选择功能模式** → **上传图片**
4. ✅ **享受AI解题** → **管理错题本**

**祝你学习愉快！🚀**

---

## 📝 更新日志

### V25.2 (2025-01-XX)
- ✅ 完全复制本地版本的UI和交互逻辑
- ✅ 添加用户登录注册系统
- ✅ 集成MySQL数据库存储
- ✅ 自动错题保存（批改模式）
- ✅ 会话管理API（云端同步）
- ✅ 修复公式渲染问题（marked配置）
- ✅ 修复快捷按钮显示逻辑
- ✅ 完善错误处理和日志

### V25.1
- 初始数据库版本
- 基础认证和错题本功能

---

**© 2025 沐梧AI解题系统 - 数据库版本 | 让学习更高效**

