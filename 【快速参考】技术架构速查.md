# 沐梧AI解题系统 - 技术架构速查表

> 快速了解项目的核心技术和架构设计

---

## 🎯 一句话介绍

**基于AI的智能教育辅助平台**，集成解题、批改、错题管理、智能出题功能，采用混合输入架构（OCR+视觉AI），本地化轻量级部署。

---

## 📊 技术栈总览

```
前端：React 18 + TypeScript + Vite + MathJax + Marked
后端：FastAPI + Pix2Text + OpenCV + 通义千问AI
存储：JSON文件（本地化，无数据库）
部署：Uvicorn + Vite Dev Server（一键启动）
```

---

## 🏗️ 架构图（简化版）

```
┌─────────────┐
│   用户界面   │ (React + TypeScript)
└──────┬──────┘
       │ HTTP/JSON
┌──────▼──────┐
│  FastAPI    │ (Python后端)
│             │
│  ├─ OCR引擎 │ (Pix2Text)
│  ├─ 图像增强 │ (OpenCV)
│  ├─ AI调用  │ (通义千问)
│  └─ JSON存储│ (mistakes.json, questions.json)
└─────────────┘
```

---

## 🔑 核心技术特性

### 1. 混合输入架构

**问题**：单纯OCR识别手写字迹不准确

**解决方案**：OCR文本 + 原始图片 → 同时发送给AI
```
OCR识别文本 ─┐
             ├─→ AI分析 → 回答
原始图片 ────┘
```

**效果**：识别准确率显著提升

---

### 2. 自动错题保存

**触发条件**：批改模式 + AI回答包含 `[MISTAKE_DETECTED]` 标记

**保存流程**：
```
AI批改 → 检测错误 → AI提取知识点 → 推测学科 → 保存JSON
```

**数据结构**：
```json
{
  "id": "uuid",
  "image_base64": "原图",
  "ai_analysis": "解析",
  "subject": "数学",
  "knowledge_points": ["二项式定理", "组合数"],
  "created_at": "2025-10-20T..."
}
```

---

### 3. LaTeX公式渲染

**流程**：
```
AI生成Markdown → marked.parse() → HTML → MathJax渲染 → 数学公式
```

**示例**：
```
$(1+x)^{2n+1}$  →  (1+x)²ⁿ⁺¹
```

---

### 4. 四层错误防护

```
1. ErrorBoundary    → 捕获React渲染错误
2. try-catch        → 捕获函数逻辑错误
3. 全局监听器       → 捕获未处理错误
4. 优雅降级         → Markdown失败用纯文本
```

**效果**：不会白屏，总能看到内容或错误提示

---

## 📁 关键文件说明

### 前端
```
frontend/vite-project/src/
├── App.tsx                    # 解题/批改主界面
├── SimpleMistakeBook.tsx      # 错题本/出题界面  
├── main.tsx                   # 入口 + 全局错误监听
└── index.html                 # MathJax CDN引入
```

### 后端
```
backend/
├── main_simple.py             # FastAPI主应用
├── mistakes.json              # 错题数据
├── questions.json             # 题目数据
├── requirements.txt           # Python依赖
└── venv/                      # 虚拟环境
```

---

## 🔄 核心API接口

```
POST   /chat                          # 解题/批改
GET    /mistakes/                     # 获取错题列表
POST   /mistakes/                     # 手动添加错题
DELETE /mistakes/{id}                 # 删除错题
GET    /mistakes/stats/summary        # 统计分析
GET    /questions/                    # 获取题目列表
POST   /questions/generate            # AI生成题目
DELETE /questions/{id}                # 删除题目
```

---

## ⚙️ 关键配置参数

### 超时配置
```typescript
// 生成题目超时
generateQuestions: 300000ms  (5分钟)
generatePaper: 600000ms      (10分钟)
```

### AI配置
```python
model = 'qwen-vl-max'        # 通义千问多模态大模型
max_output_tokens = 8192     # 最大输出长度
```

### 图像处理
```python
sharpen_amount = 1.5         # 锐化强度
clahe_clip_limit = 2.0       # 对比度增强
max_dimension = 2000         # 最大图片尺寸
```

---

## 🚀 快速启动

### Windows一键启动
```bash
双击：【启动】简化版错题本系统.bat
```

### 手动启动
```bash
# 后端
cd backend
.\venv\Scripts\activate
uvicorn main_simple:app --reload --port 8000

# 前端  
cd frontend/vite-project
npm run dev
```

### 访问地址
- **前端**：http://localhost:5173
- **后端API文档**：http://127.0.0.1:8000/docs

---

## 🐛 故障排查速查

### 问题1：白屏
- ✅ 打开F12查看控制台
- ✅ 查找 🔴 红色错误
- ✅ 刷新页面（Ctrl+F5）

### 问题2：LaTeX不显示
- ✅ 检查网络（MathJax从CDN加载）
- ✅ 等待页面完全加载
- ✅ 查看控制台MathJax渲染日志

### 问题3：生成超时
- ✅ 减少题目数量
- ✅ 等待更长时间（已延长到10分钟）
- ✅ 检查网络连接

### 问题4：OCR识别不准
- ✅ 确保图片清晰
- ✅ 避免手写过于潦草
- ✅ 使用扫描件

---

## 📊 性能参考

| 操作 | 时间 | 说明 |
|------|------|------|
| 图片上传 | <1s | - |
| OCR识别 | 2-5s | 取决于复杂度 |
| AI解题 | 10-30s | 取决于难度 |
| 生成题目 | 30-60s | 单题 |
| 生成试卷 | 3-5分钟 | 10题左右 |

---

## 🔐 安全要点

- ✅ 数据本地存储，不上传云端
- ✅ API Key存储在 `.env` 文件
- ⚠️ CORS配置生产环境需限制域名
- ⚠️ 建议添加速率限制

---

## 📝 关键依赖版本

### Python
```
fastapi==0.104.1
uvicorn==0.24.0
pix2text==1.1
opencv-python==4.8.1
dashscope==1.14.0
pillow==10.1.0
```

### Node
```
react==18.2.0
typescript==5.2.2
vite==5.0.8
marked==11.1.1
axios==1.6.2
```

---

## 📞 文档索引

| 文档 | 用途 |
|------|------|
| **沐梧AI解题系统_技术文档.md** | 完整技术文档（本文的详细版） |
| **V24.6_生成题目超时与LaTeX渲染修复.md** | 最新修复 |
| **V24.5_全面错误捕获与日志增强.md** | 错误处理 |
| **【必看】V24.5白屏调试指南.md** | 用户指南 |

---

## 🎯 开发规范

### Git提交规范
```
feat: 新功能
fix: 修复bug
docs: 文档更新
refactor: 代码重构
perf: 性能优化
```

### 代码风格
- **Python**：PEP 8
- **TypeScript**：ESLint + Prettier
- **注释**：关键逻辑必须有中文注释

---

## ✅ 快速检查清单

### 新部署检查
- [ ] Python虚拟环境已创建
- [ ] 依赖已安装（pip install -r requirements.txt）
- [ ] .env文件已配置API Key
- [ ] 前端依赖已安装（npm install）
- [ ] 后端启动成功（端口8000）
- [ ] 前端启动成功（端口5173）
- [ ] 测试上传图片解题

### 功能测试检查
- [ ] 解题功能正常
- [ ] 批改功能正常
- [ ] 错题自动保存
- [ ] LaTeX公式正确渲染
- [ ] 生成题目成功
- [ ] 历史记录可恢复

---

**版本**：V24.6  
**更新**：2025-10-20  
**状态**：✅ 稳定运行


