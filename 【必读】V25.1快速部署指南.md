# 🚀 沐梧AI V25.1 - MySQL数据库版本快速部署

## ✅ 当前进度

### 已完成 (2/8)
1. ✅ 数据库连接模块 (`database.py`)
2. ✅ 用户认证API (`auth_api.py`)
3. ✅ SQL表结构扩展脚本 (`database_schema_upgrade.sql`)
4. ✅ 完整使用文档 (`V25.1_MySQL数据库集成指南.md`)

### 待完成 (6/8)
- ⏳ 数据迁移工具
- ⏳ API端点集成
- ⏳ 前端登录界面
- ⏳ 完整测试

---

## 📋 立即执行（按顺序）

### ✨ 步骤1：安装Python依赖

**双击运行：**
```
【安装】MySQL数据库依赖.bat
```

**或手动执行：**
```bash
cd backend
venv\Scripts\activate
pip install pymysql cryptography pyjwt
```

---

### ✨ 步骤2：执行数据库表结构升级

**在Navicat中执行SQL脚本：**

1. 打开Navicat Premium
2. 连接数据库：
   - **主机：** 14.103.127.20
   - **端口：** 3306
   - **用户：** root
   - **密码：** Jiuzhi#2024
   - **数据库：** edu

3. 打开查询窗口，找到并执行文件：
   ```
   backend/database_schema_upgrade.sql
   ```

4. 执行后，验证表结构：
   ```sql
   USE edu;
   DESC subject;
   DESC exam;
   DESC user_exam;
   DESC user;
   ```

**关键新增字段：**
- `subject表`: subject_type, difficulty, knowledge_points, subject_name, grade, answer, explanation
- `exam表`: exam_type, created_at
- `user_exam表`: answered_at, user_answer, status

---

### ✨ 步骤3：测试数据库连接

```bash
cd backend
venv\Scripts\activate
python database.py
```

**预期看到：**
```
======================================================================
【数据库连接测试】
======================================================================
✅ 数据库连接池初始化成功 (5个连接)
✅ MySQL版本: {'VERSION()': '8.0.x'}
✅ 数据库表: ['exam', 'subject', 'user', 'user_exam']

✅ 数据库模块正常
```

---

### ✨ 步骤4：测试用户认证

```bash
python auth_api.py
```

**预期看到：**
```
生成的令牌: eyJ0eXAiOiJKV1QiLCJhbGc...
令牌验证成功: {'user_id': 'test_user_123', ...}
```

---

## 🎯 核心功能演示

### 1. 用户注册
```python
from database import UserManager

result = UserManager.register("张三", "password123")
print(result)
# {'success': True, 'user_id': '...', 'message': '注册成功'}
```

### 2. 用户登录
```python
result = UserManager.login("张三", "password123")
print(result)
# {'success': True, 'user_id': '...', 'account': '张三', 'message': '登录成功'}
```

### 3. 创建题目
```python
from database import SubjectManager

subject_id = SubjectManager.create_subject(
    subject_title="如图所示，椭圆C: x²/a² + y²/b² = 1...",
    subject_desc="解析几何 - 离心率",
    image_url="http://example.com/ellipse.jpg",
    solve="详细解答..."
)
```

### 4. 创建试卷并关联题目
```python
from database import ExamManager

# 创建错题本
exam_id = ExamManager.create_exam(
    exam_title="张三的数学错题本",
    exam_content="记录学生的数学错题"
)

# 关联用户-试卷-题目
ExamManager.link_user_exam_subject(
    user_id="...",
    exam_id=exam_id,
    subject_id=subject_id
)
```

### 5. 获取用户数据
```python
# 获取用户的所有题目
subjects = SubjectManager.get_user_subjects(user_id)

# 获取用户的所有试卷
exams = ExamManager.get_user_exams(user_id)

# 获取特定试卷的题目
subjects = SubjectManager.get_user_subjects(user_id, exam_id)
```

---

## 📊 数据关系图

```
┌──────────┐
│   user   │
│  (用户)   │
└────┬─────┘
     │
     │ 1:N
     ▼
┌─────────────┐      N:M      ┌──────────┐
│  user_exam  │◄──────────────►│  subject │
│ (答题记录)   │                │  (题目)   │
└──────┬──────┘                └──────────┘
       │
       │ N:1
       ▼
┌─────────┐
│   exam  │
│ (试卷)   │
└─────────┘
```

---

## 🔐 安全配置

### 当前配置（开发环境）
```python
# JWT密钥
JWT_SECRET_KEY = "muwu_ai_solver_secret_key_2024"

# 密码盐值
SALT = "muwu_ai_solver_2024"
```

### ⚠️ 生产环境必须修改
在 `auth_api.py` 和 `database.py` 中，将密钥和盐值改为环境变量：

```python
import os
JWT_SECRET_KEY = os.getenv("JWT_SECRET_KEY", "默认值")
SALT = os.getenv("PASSWORD_SALT", "默认值")
```

---

## 📝 后续开发清单

### 下一步：数据迁移工具
创建脚本将现有JSON数据导入MySQL：
- `simple_data/mistakes.json` → `subject` 表（subject_type='mistake'）
- `simple_data/generated_questions.json` → `subject` 表（subject_type='generated'）

### 再下一步：API集成
在 `main_simple.py` 中：
1. 导入 `auth_router`，注册认证路由
2. 所有API端点添加 `user: dict = Depends(get_current_user)`
3. 将JSON读写改为数据库操作

### 最后：前端登录界面
在 `SimpleMistakeBook.tsx` 中：
1. 添加登录/注册表单
2. 登录成功后保存JWT令牌
3. 所有请求携带 `Authorization: Bearer <token>`

---

## 🛠️ 常用命令

### 数据库操作
```bash
# 测试连接
python database.py

# 测试认证
python auth_api.py

# 查看表结构
mysql -h 14.103.127.20 -u root -p edu
> DESC subject;
```

### 启动服务
```bash
# 启动后端（暂时还是JSON版本）
cd backend
venv\Scripts\activate
python -m uvicorn main_simple:app --reload --host 127.0.0.1 --port 8000

# 启动前端
cd frontend\vite-project
npm run dev
```

---

## 🐛 问题排查

### 1. pymysql导入错误
```bash
pip install pymysql cryptography
```

### 2. 数据库连接超时
检查网络，确保能访问 14.103.127.20:3306

### 3. JWT令牌验证失败
检查前端请求头：
```javascript
headers: {
    'Authorization': `Bearer ${token}`
}
```

---

## 📞 下一步操作

**完成上述4个步骤后，告诉我：**
1. ✅ 依赖是否安装成功？
2. ✅ SQL脚本是否执行成功？（DESC subject 看到新字段）
3. ✅ 数据库连接测试是否通过？
4. ✅ 认证测试是否通过？

**全部通过后，我会继续开发：**
- 数据迁移工具
- API集成
- 前端登录界面

---

**版本：V25.1**  
**更新时间：2025年10月25日**  
**状态：🟡 基础模块完成，待集成测试**

