# ğŸ—„ï¸ æ²æ¢§AIè§£é¢˜ç³»ç»Ÿ V25.1 - MySQLæ•°æ®åº“é›†æˆæŒ‡å—

## ğŸ“‹ æ›´æ–°æ—¥æœŸ
2025å¹´10æœˆ25æ—¥

---

## ğŸ¯ V25.1æ ¸å¿ƒåŠŸèƒ½

### âœ… å·²å®Œæˆ
1. **MySQLæ•°æ®åº“è¿æ¥æ¨¡å—** (`database.py`)
   - è¿æ¥æ± ç®¡ç†
   - ç”¨æˆ·ç®¡ç†ç±»ï¼ˆæ³¨å†Œ/ç™»å½•ï¼‰
   - é¢˜ç›®ç®¡ç†ç±»
   - è¯•å·ç®¡ç†ç±»

2. **ç”¨æˆ·è®¤è¯API** (`auth_api.py`)
   - JWTä»¤ç‰Œç”Ÿæˆä¸éªŒè¯
   - æ³¨å†Œ/ç™»å½•æ¥å£
   - è®¤è¯ä¸­é—´ä»¶

3. **æ•°æ®åº“è¡¨ç»“æ„æ‰©å±•** (`database_schema_upgrade.sql`)
   - subjectè¡¨æ‰©å±•ï¼ˆéš¾åº¦ã€çŸ¥è¯†ç‚¹ã€ç±»å‹ç­‰ï¼‰
   - examè¡¨æ‰©å±•ï¼ˆç±»å‹ã€åˆ›å»ºæ—¶é—´ç­‰ï¼‰
   - user_examè¡¨æ‰©å±•ï¼ˆç­”é¢˜çŠ¶æ€ã€ç”¨æˆ·ç­”æ¡ˆç­‰ï¼‰
   - æ€§èƒ½ä¼˜åŒ–ç´¢å¼•

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤1ï¼šå®‰è£…ä¾èµ–

åŒå‡»è¿è¡Œï¼š
```
ã€å®‰è£…ã€‘MySQLæ•°æ®åº“ä¾èµ–.bat
```

æˆ–æ‰‹åŠ¨æ‰§è¡Œï¼š
```bash
cd backend
venv\Scripts\activate
pip install pymysql==1.1.0 cryptography==41.0.7 pyjwt==2.8.0
```

### æ­¥éª¤2ï¼šæ‰§è¡Œæ•°æ®åº“è¡¨ç»“æ„å‡çº§

1. æ‰“å¼€Navicat Premium
2. è¿æ¥åˆ°æ•°æ®åº“ï¼š
   - ä¸»æœºï¼š14.103.127.20
   - ç«¯å£ï¼š3306
   - ç”¨æˆ·ï¼šroot
   - å¯†ç ï¼šJiuzhi#2024
   - æ•°æ®åº“ï¼šedu

3. æ‰“å¼€æŸ¥è¯¢çª—å£ï¼Œæ‰§è¡Œï¼š
   ```sql
   \-- æ–‡ä»¶è·¯å¾„: backend/database_schema_upgrade.sql
   ```

4. éªŒè¯è¡¨ç»“æ„ï¼š
   ```sql
   DESC subject;
   DESC exam;
   DESC user_exam;
   ```

### æ­¥éª¤3ï¼šæµ‹è¯•æ•°æ®åº“è¿æ¥

```bash
cd backend
venv\Scripts\activate
python database.py
```

**é¢„æœŸè¾“å‡ºï¼š**
```
======================================================================
ã€æ•°æ®åº“è¿æ¥æµ‹è¯•ã€‘
======================================================================
âœ… æ•°æ®åº“è¿æ¥æ± åˆå§‹åŒ–æˆåŠŸ (5ä¸ªè¿æ¥)
âœ… MySQLç‰ˆæœ¬: {'VERSION()': '8.0.x'}
âœ… æ•°æ®åº“è¡¨: ['exam', 'subject', 'user', 'user_exam']

âœ… æ•°æ®åº“æ¨¡å—æ­£å¸¸
```

### æ­¥éª¤4ï¼šæµ‹è¯•ç”¨æˆ·è®¤è¯

```bash
python auth_api.py
```

**é¢„æœŸè¾“å‡ºï¼š**
```
ç”Ÿæˆçš„ä»¤ç‰Œ: eyJ0eXAiOiJKV1QiLCJhbGc...
ä»¤ç‰ŒéªŒè¯æˆåŠŸ: {'user_id': 'test_user_123', 'account': 'testuser', 'exp': ...}
```

---

## ğŸ“¦ æ¨¡å—è¯´æ˜

### 1. `database.py` - æ•°æ®åº“è¿æ¥æ¨¡å—

**æ ¸å¿ƒç±»ï¼š**

#### DatabasePool
è¿æ¥æ± ç®¡ç†ï¼Œæä¾›é«˜æ•ˆçš„æ•°æ®åº“è¿æ¥å¤ç”¨ã€‚

#### UserManager
```python
from database import UserManager

# ç”¨æˆ·æ³¨å†Œ
result = UserManager.register("username", "password")
# è¿”å›: {"success": True, "user_id": "...", "message": "æ³¨å†ŒæˆåŠŸ"}

# ç”¨æˆ·ç™»å½•
result = UserManager.login("username", "password")
# è¿”å›: {"success": True, "user_id": "...", "account": "...", "message": "ç™»å½•æˆåŠŸ"}

# è·å–ç”¨æˆ·ä¿¡æ¯
user = UserManager.get_user_info("user_id")
# è¿”å›: {"user_id": "...", "account": "..."}
```

#### SubjectManager
```python
from database import SubjectManager

# åˆ›å»ºé¢˜ç›®
subject_id = SubjectManager.create_subject(
    subject_title="æ¤­åœ†çš„ç¦»å¿ƒç‡è®¡ç®—",
    subject_desc="è¿™æ˜¯ä¸€é“è§£æå‡ ä½•é¢˜",
    image_url="http://example.com/image.jpg",
    solve="è¯¦ç»†è§£ç­”æ­¥éª¤..."
)

# è·å–é¢˜ç›®
subject = SubjectManager.get_subject(subject_id)

# è·å–ç”¨æˆ·çš„æ‰€æœ‰é¢˜ç›®
subjects = SubjectManager.get_user_subjects(user_id)

# è·å–ç‰¹å®šè¯•å·çš„é¢˜ç›®
subjects = SubjectManager.get_user_subjects(user_id, exam_id)
```

#### ExamManager
```python
from database import ExamManager

# åˆ›å»ºè¯•å·
exam_id = ExamManager.create_exam(
    exam_title="é«˜ä¸€æ•°å­¦é”™é¢˜æœ¬",
    exam_content="æ”¶å½•äº†å­¦ç”Ÿçš„æ•°å­¦é”™é¢˜"
)

# è·å–ç”¨æˆ·çš„æ‰€æœ‰è¯•å·
exams = ExamManager.get_user_exams(user_id)

# å…³è”ç”¨æˆ·-è¯•å·-é¢˜ç›®
record_id = ExamManager.link_user_exam_subject(user_id, exam_id, subject_id)
```

---

### 2. `auth_api.py` - ç”¨æˆ·è®¤è¯æ¨¡å—

**æ ¸å¿ƒåŠŸèƒ½ï¼š**

#### JWTä»¤ç‰Œç”Ÿæˆ
```python
from auth_api import create_access_token

token = create_access_token(user_id="123", account="user")
```

#### JWTä»¤ç‰ŒéªŒè¯
```python
from auth_api import verify_access_token

payload = verify_access_token(token)
# è¿”å›: {"user_id": "123", "account": "user", "exp": ...}
```

#### ä¾èµ–æ³¨å…¥ï¼ˆè·å–å½“å‰ç”¨æˆ·ï¼‰
```python
from fastapi import Depends
from auth_api import get_current_user

@app.get("/protected")
async def protected_route(user: dict = Depends(get_current_user)):
    # user = {"user_id": "...", "account": "..."}
    return {"message": f"æ¬¢è¿, {user['account']}!"}
```

**APIç«¯ç‚¹ï¼š**

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/auth/register` | POST | ç”¨æˆ·æ³¨å†Œ |
| `/auth/login` | POST | ç”¨æˆ·ç™»å½• |
| `/auth/verify` | GET | éªŒè¯ä»¤ç‰Œ |
| `/auth/me` | GET | è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ |

---

## ğŸ”„ æ•°æ®è¿ç§»

### ä»JSONè¿ç§»åˆ°MySQL

**å¾…å¼€å‘åŠŸèƒ½**ï¼ˆä¸‹ä¸€æ­¥å®ç°ï¼‰ï¼š
- è‡ªåŠ¨å°† `simple_data/mistakes.json` è¿ç§»åˆ° `subject` è¡¨
- è‡ªåŠ¨å°† `simple_data/generated_questions.json` è¿ç§»åˆ° `subject` è¡¨
- ä¸ºæ¯ä¸ªç”¨æˆ·åˆ›å»ºé»˜è®¤è¯•å·ï¼ˆé”™é¢˜æœ¬ã€ç»ƒä¹ é¢˜é›†ï¼‰

---

## ğŸ” å®‰å…¨è¯´æ˜

### å¯†ç åŠ å¯†
- ä½¿ç”¨SHA256 + ç›å€¼
- ç›å€¼ï¼š`muwu_ai_solver_2024`
- ç”Ÿäº§ç¯å¢ƒåº”ä¸ºæ¯ä¸ªç”¨æˆ·ä½¿ç”¨ç‹¬ç«‹ç›å€¼

### JWTä»¤ç‰Œ
- å¯†é’¥ï¼š`muwu_ai_solver_secret_key_2024`
- ç®—æ³•ï¼šHS256
- æœ‰æ•ˆæœŸï¼š7å¤©
- **ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨å¯†é’¥ï¼**

---

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„

### userè¡¨ï¼ˆç”¨æˆ·è¡¨ï¼‰
```sql
user_id VARCHAR(100) PK     -- ç”¨æˆ·ID
account VARCHAR(255)         -- è´¦å·
pwd VARCHAR(255)             -- å¯†ç ï¼ˆåŠ å¯†åï¼‰
temp_uuid VARCHAR(255)       -- ä¸´æ—¶UUID
```

### subjectè¡¨ï¼ˆé¢˜ç›®è¡¨ï¼‰ - å·²æ‰©å±•
```sql
subject_id VARCHAR(100) PK   -- é¢˜ç›®ID
subject_title TEXT           -- é¢˜ç›®æ ‡é¢˜/é¢˜å¹²
subject_desc TEXT            -- é¢˜ç›®æè¿°
image_url VARCHAR(255)       -- å›¾ç‰‡URL
solve TEXT                   -- è§£ç­”
-- V25.1æ–°å¢å­—æ®µï¼š
subject_type VARCHAR(50)     -- é¢˜ç›®ç±»å‹ï¼ˆmistake/generated/practiceï¼‰
difficulty VARCHAR(20)       -- éš¾åº¦ï¼ˆç®€å•/ä¸­ç­‰/å›°éš¾ï¼‰
knowledge_points TEXT        -- çŸ¥è¯†ç‚¹ï¼ˆJSONæ ¼å¼ï¼‰
subject_name VARCHAR(50)     -- å­¦ç§‘ï¼ˆæ•°å­¦/ç‰©ç†/åŒ–å­¦ï¼‰
grade VARCHAR(20)            -- å¹´çº§ï¼ˆé«˜ä¸€/é«˜äºŒ/é«˜ä¸‰ï¼‰
created_at DATETIME          -- åˆ›å»ºæ—¶é—´
updated_at DATETIME          -- æ›´æ–°æ—¶é—´
answer TEXT                  -- ç­”æ¡ˆ
explanation TEXT             -- è§£æ
```

### examè¡¨ï¼ˆè¯•å·è¡¨ï¼‰ - å·²æ‰©å±•
```sql
exam_id VARCHAR(100) PK      -- è¯•å·ID
exam_title VARCHAR(255)      -- è¯•å·æ ‡é¢˜
exam_content TEXT            -- è¯•å·å†…å®¹
-- V25.1æ–°å¢å­—æ®µï¼š
created_at DATETIME          -- åˆ›å»ºæ—¶é—´
exam_type VARCHAR(50)        -- è¯•å·ç±»å‹ï¼ˆmistake_book/practice_set/test_paperï¼‰
```

### user_examè¡¨ï¼ˆç”¨æˆ·è€ƒè¯•è®°å½•è¡¨ï¼‰ - å·²æ‰©å±•
```sql
id VARCHAR(100) PK           -- è®°å½•ID
user_info VARCHAR(100) FK    -- ç”¨æˆ·ID
subject_id VARCHAR(100) FK   -- é¢˜ç›®ID
exam_id VARCHAR(100) FK      -- è¯•å·ID
-- V25.1æ–°å¢å­—æ®µï¼š
answered_at DATETIME         -- ç­”é¢˜æ—¶é—´
user_answer TEXT             -- ç”¨æˆ·ç­”æ¡ˆ
status VARCHAR(20)           -- ç­”é¢˜çŠ¶æ€ï¼ˆcorrect/incorrect/unansweredï¼‰
```

---

## ğŸ› ï¸ é›†æˆåˆ°ç°æœ‰ç³»ç»Ÿ

### åœ¨main_simple.pyä¸­é›†æˆè®¤è¯

1. **å¯¼å…¥è®¤è¯æ¨¡å—**
```python
from auth_api import router as auth_router, get_current_user
from database import init_database_pool

# åˆå§‹åŒ–æ•°æ®åº“è¿æ¥æ± 
init_database_pool()

# æ³¨å†Œè®¤è¯è·¯ç”±
app.include_router(auth_router)
```

2. **ä¿æŠ¤APIç«¯ç‚¹**
```python
from fastapi import Depends

@app.get("/mistakes/")
async def get_mistakes(user: dict = Depends(get_current_user)):
    user_id = user["user_id"]
    # ä»æ•°æ®åº“è¯»å–è¯¥ç”¨æˆ·çš„é”™é¢˜...
```

3. **å‰ç«¯è¯·æ±‚ç¤ºä¾‹**
```javascript
// ç™»å½•
const response = await axios.post('/auth/login', {
    account: 'username',
    password: 'password'
});

// ä¿å­˜ä»¤ç‰Œ
localStorage.setItem('token', response.data.token);

// æºå¸¦ä»¤ç‰Œè¯·æ±‚
axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
```

---

## ğŸ“ ä¸‹ä¸€æ­¥å¼€å‘è®¡åˆ’

1. âœ… æ•°æ®åº“è¿æ¥æ¨¡å—
2. âœ… ç”¨æˆ·è®¤è¯API
3. âœ… è¡¨ç»“æ„æ‰©å±•
4. â³ ä¿®æ”¹ç°æœ‰APIæ”¯æŒæ•°æ®åº“
5. â³ å‰ç«¯ç™»å½•ç•Œé¢
6. â³ æ•°æ®è¿ç§»å·¥å…·
7. â³ å®Œæ•´æµ‹è¯•

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: æ•°æ®åº“è¿æ¥å¤±è´¥
**A:** æ£€æŸ¥ç½‘ç»œæ˜¯å¦èƒ½è®¿é—® 14.103.127.20:3306ï¼Œç¡®è®¤æ•°æ®åº“å‡­æ®æ­£ç¡®ã€‚

### Q2: JWTä»¤ç‰ŒéªŒè¯å¤±è´¥
**A:** æ£€æŸ¥å‰ç«¯æ˜¯å¦æ­£ç¡®æºå¸¦ `Authorization: Bearer <token>` è¯·æ±‚å¤´ã€‚

### Q3: è¡¨ç»“æ„å‡çº§å¤±è´¥
**A:** ç¡®ä¿ä½¿ç”¨çš„MySQLç‰ˆæœ¬æ”¯æŒ `ALTER TABLE ... ADD COLUMN IF NOT EXISTS` è¯­æ³•ï¼ˆMySQL 5.7+ï¼‰ã€‚

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- æ•°æ®åº“è¿æ¥æ—¥å¿—ï¼š`backend/database.py` æµ‹è¯•è¾“å‡º
- APIæ–‡æ¡£ï¼šhttp://127.0.0.1:8000/docs
- è®¤è¯æµ‹è¯•ï¼š`python auth_api.py`

---

**ç‰ˆæœ¬ï¼šV25.1**  
**æ›´æ–°æ—¶é—´ï¼š2025å¹´10æœˆ25æ—¥**

