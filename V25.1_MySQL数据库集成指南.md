# 🗄️ 沐梧AI解题系统 V25.1 - MySQL数据库集成指南

## 📋 更新日期
2025年10月25日

---

## 🎯 V25.1核心功能

### ✅ 已完成
1. **MySQL数据库连接模块** (`database.py`)
   - 连接池管理
   - 用户管理类（注册/登录）
   - 题目管理类
   - 试卷管理类

2. **用户认证API** (`auth_api.py`)
   - JWT令牌生成与验证
   - 注册/登录接口
   - 认证中间件

3. **数据库表结构扩展** (`database_schema_upgrade.sql`)
   - subject表扩展（难度、知识点、类型等）
   - exam表扩展（类型、创建时间等）
   - user_exam表扩展（答题状态、用户答案等）
   - 性能优化索引

---

## 🚀 快速开始

### 步骤1：安装依赖

双击运行：
```
【安装】MySQL数据库依赖.bat
```

或手动执行：
```bash
cd backend
venv\Scripts\activate
pip install pymysql==1.1.0 cryptography==41.0.7 pyjwt==2.8.0
```

### 步骤2：执行数据库表结构升级

1. 打开Navicat Premium
2. 连接到数据库：
   - 主机：14.103.127.20
   - 端口：3306
   - 用户：root
   - 密码：Jiuzhi#2024
   - 数据库：edu

3. 打开查询窗口，执行：
   ```sql
   \-- 文件路径: backend/database_schema_upgrade.sql
   ```

4. 验证表结构：
   ```sql
   DESC subject;
   DESC exam;
   DESC user_exam;
   ```

### 步骤3：测试数据库连接

```bash
cd backend
venv\Scripts\activate
python database.py
```

**预期输出：**
```
======================================================================
【数据库连接测试】
======================================================================
✅ 数据库连接池初始化成功 (5个连接)
✅ MySQL版本: {'VERSION()': '8.0.x'}
✅ 数据库表: ['exam', 'subject', 'user', 'user_exam']

✅ 数据库模块正常
```

### 步骤4：测试用户认证

```bash
python auth_api.py
```

**预期输出：**
```
生成的令牌: eyJ0eXAiOiJKV1QiLCJhbGc...
令牌验证成功: {'user_id': 'test_user_123', 'account': 'testuser', 'exp': ...}
```

---

## 📦 模块说明

### 1. `database.py` - 数据库连接模块

**核心类：**

#### DatabasePool
连接池管理，提供高效的数据库连接复用。

#### UserManager
```python
from database import UserManager

# 用户注册
result = UserManager.register("username", "password")
# 返回: {"success": True, "user_id": "...", "message": "注册成功"}

# 用户登录
result = UserManager.login("username", "password")
# 返回: {"success": True, "user_id": "...", "account": "...", "message": "登录成功"}

# 获取用户信息
user = UserManager.get_user_info("user_id")
# 返回: {"user_id": "...", "account": "..."}
```

#### SubjectManager
```python
from database import SubjectManager

# 创建题目
subject_id = SubjectManager.create_subject(
    subject_title="椭圆的离心率计算",
    subject_desc="这是一道解析几何题",
    image_url="http://example.com/image.jpg",
    solve="详细解答步骤..."
)

# 获取题目
subject = SubjectManager.get_subject(subject_id)

# 获取用户的所有题目
subjects = SubjectManager.get_user_subjects(user_id)

# 获取特定试卷的题目
subjects = SubjectManager.get_user_subjects(user_id, exam_id)
```

#### ExamManager
```python
from database import ExamManager

# 创建试卷
exam_id = ExamManager.create_exam(
    exam_title="高一数学错题本",
    exam_content="收录了学生的数学错题"
)

# 获取用户的所有试卷
exams = ExamManager.get_user_exams(user_id)

# 关联用户-试卷-题目
record_id = ExamManager.link_user_exam_subject(user_id, exam_id, subject_id)
```

---

### 2. `auth_api.py` - 用户认证模块

**核心功能：**

#### JWT令牌生成
```python
from auth_api import create_access_token

token = create_access_token(user_id="123", account="user")
```

#### JWT令牌验证
```python
from auth_api import verify_access_token

payload = verify_access_token(token)
# 返回: {"user_id": "123", "account": "user", "exp": ...}
```

#### 依赖注入（获取当前用户）
```python
from fastapi import Depends
from auth_api import get_current_user

@app.get("/protected")
async def protected_route(user: dict = Depends(get_current_user)):
    # user = {"user_id": "...", "account": "..."}
    return {"message": f"欢迎, {user['account']}!"}
```

**API端点：**

| 端点 | 方法 | 说明 |
|------|------|------|
| `/auth/register` | POST | 用户注册 |
| `/auth/login` | POST | 用户登录 |
| `/auth/verify` | GET | 验证令牌 |
| `/auth/me` | GET | 获取当前用户信息 |

---

## 🔄 数据迁移

### 从JSON迁移到MySQL

**待开发功能**（下一步实现）：
- 自动将 `simple_data/mistakes.json` 迁移到 `subject` 表
- 自动将 `simple_data/generated_questions.json` 迁移到 `subject` 表
- 为每个用户创建默认试卷（错题本、练习题集）

---

## 🔐 安全说明

### 密码加密
- 使用SHA256 + 盐值
- 盐值：`muwu_ai_solver_2024`
- 生产环境应为每个用户使用独立盐值

### JWT令牌
- 密钥：`muwu_ai_solver_secret_key_2024`
- 算法：HS256
- 有效期：7天
- **生产环境必须使用环境变量存储密钥！**

---

## 📊 数据库表结构

### user表（用户表）
```sql
user_id VARCHAR(100) PK     -- 用户ID
account VARCHAR(255)         -- 账号
pwd VARCHAR(255)             -- 密码（加密后）
temp_uuid VARCHAR(255)       -- 临时UUID
```

### subject表（题目表） - 已扩展
```sql
subject_id VARCHAR(100) PK   -- 题目ID
subject_title TEXT           -- 题目标题/题干
subject_desc TEXT            -- 题目描述
image_url VARCHAR(255)       -- 图片URL
solve TEXT                   -- 解答
-- V25.1新增字段：
subject_type VARCHAR(50)     -- 题目类型（mistake/generated/practice）
difficulty VARCHAR(20)       -- 难度（简单/中等/困难）
knowledge_points TEXT        -- 知识点（JSON格式）
subject_name VARCHAR(50)     -- 学科（数学/物理/化学）
grade VARCHAR(20)            -- 年级（高一/高二/高三）
created_at DATETIME          -- 创建时间
updated_at DATETIME          -- 更新时间
answer TEXT                  -- 答案
explanation TEXT             -- 解析
```

### exam表（试卷表） - 已扩展
```sql
exam_id VARCHAR(100) PK      -- 试卷ID
exam_title VARCHAR(255)      -- 试卷标题
exam_content TEXT            -- 试卷内容
-- V25.1新增字段：
created_at DATETIME          -- 创建时间
exam_type VARCHAR(50)        -- 试卷类型（mistake_book/practice_set/test_paper）
```

### user_exam表（用户考试记录表） - 已扩展
```sql
id VARCHAR(100) PK           -- 记录ID
user_info VARCHAR(100) FK    -- 用户ID
subject_id VARCHAR(100) FK   -- 题目ID
exam_id VARCHAR(100) FK      -- 试卷ID
-- V25.1新增字段：
answered_at DATETIME         -- 答题时间
user_answer TEXT             -- 用户答案
status VARCHAR(20)           -- 答题状态（correct/incorrect/unanswered）
```

---

## 🛠️ 集成到现有系统

### 在main_simple.py中集成认证

1. **导入认证模块**
```python
from auth_api import router as auth_router, get_current_user
from database import init_database_pool

# 初始化数据库连接池
init_database_pool()

# 注册认证路由
app.include_router(auth_router)
```

2. **保护API端点**
```python
from fastapi import Depends

@app.get("/mistakes/")
async def get_mistakes(user: dict = Depends(get_current_user)):
    user_id = user["user_id"]
    # 从数据库读取该用户的错题...
```

3. **前端请求示例**
```javascript
// 登录
const response = await axios.post('/auth/login', {
    account: 'username',
    password: 'password'
});

// 保存令牌
localStorage.setItem('token', response.data.token);

// 携带令牌请求
axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
```

---

## 📝 下一步开发计划

1. ✅ 数据库连接模块
2. ✅ 用户认证API
3. ✅ 表结构扩展
4. ⏳ 修改现有API支持数据库
5. ⏳ 前端登录界面
6. ⏳ 数据迁移工具
7. ⏳ 完整测试

---

## 🐛 常见问题

### Q1: 数据库连接失败
**A:** 检查网络是否能访问 14.103.127.20:3306，确认数据库凭据正确。

### Q2: JWT令牌验证失败
**A:** 检查前端是否正确携带 `Authorization: Bearer <token>` 请求头。

### Q3: 表结构升级失败
**A:** 确保使用的MySQL版本支持 `ALTER TABLE ... ADD COLUMN IF NOT EXISTS` 语法（MySQL 5.7+）。

---

## 📞 技术支持

如有问题，请查看：
- 数据库连接日志：`backend/database.py` 测试输出
- API文档：http://127.0.0.1:8000/docs
- 认证测试：`python auth_api.py`

---

**版本：V25.1**  
**更新时间：2025年10月25日**

