# 图片传递问题调试说明

## 🔍 问题现象
AI回答时似乎没有看到题目图片，只回复了"好的"、"我们"等简短内容。

## 🛠️ 已添加的调试日志

### 后端日志（Python控制台）
现在会显示详细的流式处理过程：
- `[流式] event_generator 开始执行`
- `[流式] is_new_session: True/False`
- `[流式] has_image: True/False`
- `[流式] image_base_64 长度: xxxxx`
- `[流式] 开始进行OCR识别...`
- `[流式] 图片解码完成，字节数: xxxxx`
- `[流式] 图片打开完成，尺寸: (width, height)`
- `[流式] OCR识别完成！提取了 xxx 个字符`
- `[流式] OCR文本预览: ...`
- `[流式] 增强Prompt已构建，总长度: xxx`
- `[流式] 消息已添加，包含OCR文本和原始图片`

### 前端日志（浏览器控制台 F12）
现在会显示：
- `[sendMessage] 开始, imageBlob存在: true/false`
- `[sendMessage] isFirstMessage: true/false`
- `[sendMessage] 图片转换为Base64完成`
- `[sendMessage] Base64长度: xxxxx`
- `[sendMessage] 请求体构建完成:`
  - `session_id: xxx`
  - `prompt长度: xxx`
  - `has_image: true/false`

## 📋 测试步骤

### 1. 确保服务已重启
后端和前端都已在后台启动，但需要确认：

**后端**: 应该在 http://127.0.0.1:8000 运行
**前端**: 应该在 http://localhost:5173 运行

### 2. 打开浏览器开发者工具
1. 访问 http://localhost:5173
2. 按 `F12` 打开开发者工具
3. 切换到 **Console（控制台）** 标签页

### 3. 重新测试流程
1. 选择模式（智能解题/批改作业）
2. 上传题目图片
3. 点击"解析整张图片"或其他按钮

### 4. 查看日志输出

#### 前端日志（浏览器）
应该看到类似：
```
[sendMessage] 开始, imageBlob存在: true
[sendMessage] isFirstMessage: true
[sendMessage] 图片转换为Base64完成
[sendMessage] Base64长度: 123456
[sendMessage] 请求体构建完成:
  - session_id: (新会话)
  - prompt长度: 45
  - has_image: true
[sendMessage] 发起流式请求...
```

#### 后端日志（Python终端）
应该看到类似：
```
######################################################################
# /chat_stream 接口被调用
# session_id: None
# prompt: 请逐题解答...
# has_image: True
######################################################################
[流式] event_generator 开始执行
[流式] is_new_session: True
[流式] has_image: True
[流式] image_base_64 长度: 123456
[流式] 创建新会话，图片大小: 123456 字符
[流式] 会话创建完成: abc-123-def
[流式] 开始进行OCR识别...
[流式] 图片解码完成，字节数: 92567
[流式] 图片打开完成，尺寸: (800, 1200)
[流式] OCR识别完成！提取了 450 个字符
[流式] OCR文本预览: 1. 计算 $\\frac{1}{2} + \\frac{1}{3}$ ...
[流式] 增强Prompt已构建，总长度: 550
[流式] 消息已添加，包含OCR文本和原始图片
```

## 🐛 可能的问题点

### 问题1: `has_image: False`
**原因**: 前端没有正确传递图片
**解决**: 检查 `imageBlob` 是否正确传入 `sendMessage()` 函数

### 问题2: OCR识别失败或提取内容为空
**原因**: Pix2Text OCR引擎问题
**解决**: 检查 `ocr_text` 的内容，可能需要重新初始化OCR引擎

### 问题3: OCR识别成功但AI回答不相关
**原因**: 
- OCR提取的文本质量差
- 图片传递给AI时格式有问题
- 通义千问API调用问题

**解决**: 
- 查看 `[流式] OCR文本预览` 的内容是否准确
- 确认 `messages_to_send` 同时包含text和image

### 问题4: 流式接口根本没被调用
**原因**: 前端仍在使用旧的 `/chat` 接口
**解决**: 确认前端代码中使用的是 `/chat_stream`

## 🔄 如果问题依然存在

请截图或复制以下内容：
1. **浏览器控制台的完整日志**
2. **Python终端的完整输出**
3. **出错时的具体操作步骤**

这样我可以精确定位问题所在！

## 💡 快速检查清单

- [ ] 后端服务运行正常（8000端口）
- [ ] 前端服务运行正常（5173端口）
- [ ] 浏览器控制台显示 `has_image: true`
- [ ] 后端控制台显示 `[流式] has_image: True`
- [ ] 后端控制台显示 `[流式] OCR识别完成`
- [ ] OCR文本预览内容正确
- [ ] 通义千问API正常响应

---

**提示**: 如果所有日志都正常，但AI回答仍然奇怪，可能是通义千问API本身的问题，可以尝试：
1. 清空浏览器缓存和localStorage
2. 重新上传图片
3. 尝试不同的图片

