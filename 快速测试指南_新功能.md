# 🚀 快速测试指南 - 历史对话 & 性能优化

## 📋 测试前准备

### 1. 重启服务
双击 `启动服务.bat` 或手动启动：
```cmd
# 后端
cd backend
python -m uvicorn main:app --reload

# 前端（新窗口）
cd frontend\vite-project
npm run dev
```

### 2. 打开浏览器
访问 http://localhost:5173

---

## ✅ 测试场景 1：历史对话持久化

### 步骤：
1. **上传图片** → 获得AI回答
2. **追问2-3次** → 验证连续对话
3. **刷新页面（Ctrl+F5）** 
4. **点击"📚 历史记录"**
5. **查看会话列表** → 应该看到刚才的对话
6. **点击会话卡片** → 消息立即显示
7. **继续追问** → 应该能正常对话

### ✅ 预期结果：
- 刷新后历史记录依然存在
- 点击历史会话秒开
- 可以继续追问
- AI记得题目内容

---

## ✅ 测试场景 2：连续对话性能优化

### 步骤：
1. **上传题目图片**
2. **连续追问5-7次**，例如：
   - "请解答第1题"
   - "请继续解答第2题"  
   - "第3题呢？"
   - "能详细说明第4题的解题思路吗？"
   - "第5题有什么注意事项？"
   - ...

### 📊 观察指标：
- **响应速度**：后面的追问是否保持快速？
- **后端日志**：查看"发送消息数"
  - 应该看到类似：`完整历史: 10 条 → 实际发送: 8 条`
  - 表示滑动窗口生效

### ✅ 预期结果：
- 第1次：约8秒
- 第3次：约9秒（而非15秒）⚡
- 第5次：约10秒（而非25秒）⚡
- 第7次：约11秒（而非35秒）⚡

**对比优化前**：会越来越慢，第7次可能要30秒以上

---

## ✅ 测试场景 3：会话独立性

### 步骤：
1. **创建第1个会话** → 上传图片A，对话3次
2. **点击"➕ 新对话"**
3. **创建第2个会话** → 上传图片B，对话3次
4. **打开历史记录**
5. **切换到第1个会话** → 验证内容正确
6. **切换到第2个会话** → 验证内容正确
7. **在第1个会话继续追问** → 应该基于图片A

### ✅ 预期结果：
- 两个会话完全独立
- 切换会话时内容正确
- 追问时AI记得对应的题目

---

## ✅ 测试场景 4：会话删除

### 步骤：
1. **创建2-3个会话**
2. **打开历史记录**
3. **点击某个会话的🗑️图标**
4. **确认删除**
5. **刷新页面**
6. **再次打开历史记录**

### ✅ 预期结果：
- 删除后会话消失
- 刷新后依然不存在
- 其他会话不受影响

---

## 🔍 后端日志关键信息

### 首次对话
```
[混合输入架构] OCR识别完成！提取了 1742 个字符
[混合输入架构] 混合消息构建完成，同时包含OCR文本和原始图片
[AI调用] 消息数: 1 条
```

### 追问（滑动窗口生效）
```
[追问模式] 📊 完整历史记录数: 10
[追问模式] ⚡ 使用滑动窗口：保留最近 6 条消息
[追问模式] 📊 发送消息数: 8 条（含首条+窗口+新问题）
[追问模式] 💾 完整历史: 10 条 → 🚀 实际发送: 8 条
[追问模式] 📷 图片位置: 第1条消息中（始终保留）
```

### 会话恢复
```
[会话恢复] 开始恢复会话
[会话恢复] session_id: abc-123-def-456
[会话恢复] 历史消息数: 8
[会话恢复] ✅ 会话恢复成功
```

---

## 🐛 常见问题排查

### 问题1：历史记录为空
**可能原因**：localStorage被清空
**解决方案**：重新创建对话，会自动保存

### 问题2：点击历史会话无反应
**可能原因**：后端服务重启，会话状态丢失
**解决方案**：
- 查看浏览器控制台日志
- 应该会自动调用恢复API
- 如果失败，可查看但无法追问，需重新开始

### 问题3：追问速度还是慢
**可能原因**：
- 滑动窗口未生效
- 窗口设置过大
**检查方法**：
- 查看后端日志"发送消息数"
- 应该稳定在8条左右
- 如果持续增长，检查代码

### 问题4：图片记忆丢失
**可能原因**：首条消息未包含图片
**检查方法**：
- 后端日志应显示"📷 图片位置: 第1条消息中"
- 如果没有，检查会话恢复逻辑

---

## 📈 性能对比测试

### 测试工具
打开浏览器开发者工具（F12） → Network标签

### 测试方法
1. 连续追问5次
2. 记录每次请求的响应时间
3. 观察后端日志的"发送消息数"

### 参考数据

| 追问次数 | 历史消息数 | 发送消息数（优化后） | 响应时间（优化前） | 响应时间（优化后） |
|---------|----------|-----------------|----------------|----------------|
| 1 | 2 | 2 | 8秒 | 8秒 |
| 2 | 4 | 4 | 10秒 | 9秒 |
| 3 | 6 | 6 | 15秒 | 9秒 ⚡ |
| 4 | 8 | 8 | 20秒 | 10秒 ⚡ |
| 5 | 10 | 8 | 25秒 | 10秒 ⚡ |
| 6 | 12 | 8 | 30秒 | 11秒 ⚡ |
| 7 | 14 | 8 | 35秒 | 11秒 ⚡ |

**关键指标**：
- ✅ 发送消息数在第4次后稳定在8条
- ✅ 响应时间保持在10秒左右
- ✅ 性能提升：50-70%

---

## 🎯 测试检查清单

### 基础功能 ✓
- [ ] 上传图片并对话
- [ ] 刷新页面后历史保存
- [ ] 点击历史会话恢复对话
- [ ] 恢复后可继续追问

### 性能优化 ✓
- [ ] 连续追问5次以上
- [ ] 响应时间保持稳定
- [ ] 后端日志显示滑动窗口生效

### 会话管理 ✓
- [ ] 创建多个独立会话
- [ ] 切换会话内容正确
- [ ] 删除会话数据清理

### 容错测试 ✓
- [ ] 后端重启后提示会话失效
- [ ] 会话恢复失败时可查看历史
- [ ] 删除当前会话返回上传界面

---

## 🎉 测试完成！

如果所有测试都通过，说明新功能运行完美！

享受**永不丢失**的历史对话和**飞快响应**的连续追问吧！🚀

