# 🔍 图片传递问题 - 详细诊断步骤

## 第一步：正确启动服务

### 方法1: 使用批处理脚本（推荐）
1. 双击运行 `启动服务.bat`
2. 会自动打开两个新的命令窗口：
   - **后端服务窗口**（黑色背景，显示Python日志）
   - **前端服务窗口**（显示npm运行日志）
3. **不要关闭这两个窗口！** 它们会显示重要的调试信息

### 方法2: 手动启动
如果批处理脚本不工作，请手动启动：

**后端（打开第一个命令窗口）：**
```cmd
cd backend
python -m uvicorn main:app --reload
```

**前端（打开第二个命令窗口）：**
```cmd
cd frontend\vite-project
npm run dev
```

---

## 第二步：打开浏览器并准备调试

1. 打开浏览器，访问前端服务显示的地址（通常是 http://localhost:5173）
2. **按F12打开开发者工具**
3. 切换到 **Console（控制台）** 标签
4. 清空控制台（点击🚫图标）

---

## 第三步：测试并收集日志

### 3.1 开始测试
1. 选择模式（智能解题 或 批改作业）
2. 上传一张题目图片
3. 选择"解/改整张图片"
4. 点击"解析整张图片"按钮

### 3.2 立即查看三个地方的日志

#### 📱 地方1: 浏览器控制台（F12）
应该看到类似：
```
[sendMessage] 开始, imageBlob存在: true
[sendMessage] isFirstMessage: true
[sendMessage] 图片转换为Base64完成
[sendMessage] Base64长度: 123456
[sendMessage] 请求体构建完成:
  - session_id: (新会话)
  - prompt长度: 45
  - has_image: true
[sendMessage] 发起流式请求...
```

**❌ 如果看到 `imageBlob存在: false`**:
- 问题：前端没有正确获取图片
- 可能原因：fileRef.current为空
- 请截图发给我

**❌ 如果看到 `has_image: false`**:
- 问题：图片转Base64失败
- 请截图发给我

#### 🖥️ 地方2: 后端服务窗口（Python）
应该看到大量详细日志：

```
######################################################################
# /chat_stream 接口被调用
# session_id: None
# prompt: 请逐题解答，每道题都要写出详细的解题步骤和思路。
# has_image: True
######################################################################

[流式] event_generator 开始执行
[流式] is_new_session: True
[流式] has_image: True
[流式] image_base_64 长度: 123456

[流式] 创建新会话，图片大小: 123456 字符
[流式] 会话创建完成: abc-123-def-456

[流式] 开始进行OCR识别...
[流式] 图片解码完成，字节数: 92567
[流式] 图片打开完成，尺寸: (800, 1200)

[OCR识别成功] 提取了 450 个字符

[流式] OCR识别完成！提取了 450 个字符
[流式] OCR文本预览: 1. 计算 $\frac{1}{2} + \frac{1}{3}$ 的值
2. 解方程 ...

[流式] 增强Prompt已构建，总长度: 550
[流式] 消息已添加，包含OCR文本和原始图片

[流式] 准备调用通义千问API
[流式] messages_to_send 数量: 1
[流式] Message 0: role=user
[流式]   content是列表，包含 2 个元素
[流式]     [0] text: 题目内容如下：

1. 计算 $\frac{1}{2} + \frac{1}{3}$ 的值...
[流式]     [1] image: data:image/png;base64,... (长度: 123456)

--- 正在流式调用通义千问 'qwen-vl-max' API，历史记录有 1 条... ---
```

#### 🔍 关键检查点

**检查点1: OCR识别**
```
[流式] OCR识别完成！提取了 450 个字符
[流式] OCR文本预览: ...
```
- ✅ **如果提取了很多字符（>100）且预览内容正确**：OCR正常
- ❌ **如果提取了0个字符或很少**：OCR识别失败
- ❌ **如果OCR文本是乱码**：图片格式或编码问题

**检查点2: 消息结构**
```
[流式]   content是列表，包含 2 个元素
[流式]     [0] text: 题目内容如下：...
[流式]     [1] image: data:image/png;base64,... (长度: xxxxx)
```
- ✅ **必须包含2个元素**：text和image
- ✅ **text长度应该较长**（包含OCR结果+任务要求）
- ✅ **image应该是data:image格式**且长度>10000

**检查点3: API调用**
```
--- 正在流式调用通义千问 'qwen-vl-max' API，历史记录有 1 条... ---
--- 流式API调用完成, finish_reason: stop, 总长度: 1500 ---
```
- ✅ **如果看到"调用完成"且总长度>100**：API正常响应
- ❌ **如果总长度很短（<50）**：API没有看到题目或理解有误

#### 🌐 地方3: 网络请求（可选）
在浏览器开发者工具中：
1. 切换到 **Network（网络）** 标签
2. 筛选: XHR/Fetch
3. 找到 `chat_stream` 请求
4. 查看 **Headers** → **Request Payload**
5. 确认 `image_base_64` 字段存在且很长

---

## 第四步：根据日志诊断问题

### 问题类型 A: OCR识别失败
**症状**: `[流式] OCR识别完成！提取了 0 个字符`

**原因**:
- Pix2Text OCR引擎未正确初始化
- 图片格式不支持
- 图片质量太差

**解决方案**:
1. 重启后端服务
2. 尝试不同的图片
3. 检查backend/main.py中OCR初始化是否成功

### 问题类型 B: 图片未传递给API
**症状**: messages只包含text，没有image

**原因**:
- request.image_base_64为None
- 前端发送时丢失了图片数据

**解决方案**:
- 检查浏览器控制台的 `has_image: true`
- 检查后端日志的 `has_image: True`
- 两者都必须为true

### 问题类型 C: API收到了但回答不对
**症状**: 
- OCR识别正常
- messages结构正确（包含text和image）
- API调用成功（finish_reason: stop）
- 但AI回答还是"好的"、"我"等简短内容

**原因**:
- 通义千问API本身的问题
- 可能是模型当前状态异常
- 或者Prompt格式问题

**解决方案**:
1. 等待几分钟后重试
2. 尝试不同的图片
3. 检查通义千问API配额是否用完
4. 尝试使用非流式接口（/chat）对比

---

## 第五步：收集信息报告给我

如果问题依然存在，请提供：

### 必需信息：
1. ✅ **后端服务窗口的完整日志**（从启动到AI回答结束）
2. ✅ **浏览器控制台的完整日志**（F12 → Console）
3. ✅ **您使用的图片**（上传的那张）
4. ✅ **AI的实际回答内容**

### 可选信息：
- 网络请求详情（Network标签中的chat_stream请求）
- 错误截图

---

## 快速检查清单

运行测试前，确认：
- [ ] 后端服务窗口已打开并显示日志
- [ ] 前端服务窗口已打开并显示地址
- [ ] 浏览器F12开发者工具已打开
- [ ] 控制台已清空，准备查看新日志

测试时，重点关注：
- [ ] 浏览器: `imageBlob存在: true`
- [ ] 浏览器: `has_image: true`
- [ ] 后端: `has_image: True`
- [ ] 后端: `OCR识别完成！提取了 XXX 个字符` （XXX > 50）
- [ ] 后端: `content是列表，包含 2 个元素`
- [ ] 后端: `image: data:image/png;base64,...`

---

## 临时解决方案

如果流式接口问题一直无法解决，可以暂时使用原来的非流式接口：

**修改前端代码**：
在 `frontend/vite-project/src/App.tsx` 中，找到第230行附近：
```typescript
const response = await fetch(`${backendUrl}/chat_stream`, {
```

临时改为：
```typescript
const response = await fetch(`${backendUrl}/chat`, {
```

这样会使用旧的、已经验证过的非流式接口。虽然没有打字机效果，但可以先确保基本功能正常。

---

## 联系开发者

如果按照以上步骤仍无法解决，请将：
- 后端完整日志
- 浏览器控制台日志  
- 测试图片

一起发送给我，我会帮您精确定位问题！

