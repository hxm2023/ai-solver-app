# 沐梧AI解题系统 V25.2 - 快速开始指南

## 📋 版本信息

- **当前版本**：V25.2
- **发布日期**：2024-10-27
- **主要更新**：连续对话、智能错题本、灵活试卷生成

---

## 🚀 立即开始（30秒快速体验）

### 步骤1：升级数据库（首次使用）

**重要**：如果您是从V25.1或更早版本升级，需要先升级数据库。

```bash
# 方法一：使用批处理文件（推荐）
双击运行：【执行】升级数据库到V25.2.bat

# 方法二：手动执行SQL
mysql -h 14.103.127.20 -P 3306 -u root -p edu < backend/database_schema_v25.2.sql
```

**注意事项**：
- ✅ 升级前建议备份数据库
- ✅ 字段已存在的错误可以忽略
- ✅ 不会删除或修改现有数据

### 步骤2：重启后端服务

**关闭当前运行的后端**（按 Ctrl+C），然后：

```bash
# 双击运行
【启动】数据库版本系统.bat
```

看到以下信息表示启动成功：
```
✅ API密钥已加载: sk-1d2f45c...
✅ 数据库连接池初始化成功 (5个连接)
INFO: Uvicorn running on http://127.0.0.1:8000
```

### 步骤3：测试新功能

#### 方法A：使用Postman/cURL测试

**测试连续对话API**：

```bash
POST http://127.0.0.1:8000/api/v2/chat
Content-Type: application/json
Authorization: Bearer YOUR_JWT_TOKEN

{
  "prompt": "什么是二次函数？",
  "mode": "solve",
  "subject": "数学",
  "grade": "高一"
}
```

**测试错题列表API**：

```bash
GET http://127.0.0.1:8000/api/v2/mistakes?subject_name=数学&limit=10
Authorization: Bearer YOUR_JWT_TOKEN
```

#### 方法B：等待前端更新

前端界面集成正在开发中，敬请期待！

---

## 🎯 三大核心新功能

### 1. 连续对话功能 🤖

**功能描述**：
- AI能够记住之前的对话内容
- 支持多轮问答和深入探讨
- 自动保存对话历史到数据库
- 可以随时查看和恢复历史对话

**应用场景**：
```
用户：什么是二次函数？
AI：二次函数是形如 f(x) = ax² + bx + c 的函数...

用户：它的图像是什么样的？  ← 能理解"它"指的是二次函数
AI：二次函数的图像是抛物线...

用户：如何求顶点？  ← 延续上下文
AI：顶点公式是...
```

**API端点**：
- 创建会话：`POST /api/v2/chat/session/create`
- 发送消息：`POST /api/v2/chat`
- 获取历史：`GET /api/v2/chat/session/{id}/history`
- 会话列表：`GET /api/v2/chat/sessions`
- 删除会话：`DELETE /api/v2/chat/session/{id}`

**数据库表**：
- `chat_session` - 存储会话信息
- `chat_history` - 存储对话记录

---

### 2. 智能错题本 📚

**功能描述**：
- 批改作业时自动识别并保存错题
- 保存完整信息：题目、图片、错误答案、正确解析、知识点
- 支持按学科、年级、知识点筛选
- 记录复习次数和时间
- 提供错题统计分析

**自动保存流程**：
```
1. 用户使用批改模式上传题目图片
2. AI分析后发现错误
3. 系统自动提取知识点
4. 保存到错题本数据库
5. 用户可在错题本中查看和复习
```

**API端点**：
- 手动保存：`POST /api/v2/mistakes/save`
- 获取列表：`GET /api/v2/mistakes?subject_name=数学&grade=高一`
- 错题统计：`GET /api/v2/mistakes/stats`
- 标记复习：`POST /api/v2/mistakes/{id}/review`

**筛选示例**：
```bash
# 获取所有数学错题
GET /api/v2/mistakes?subject_name=数学

# 获取高一的错题
GET /api/v2/mistakes?grade=高一

# 获取包含"二次函数"知识点的错题
GET /api/v2/mistakes?knowledge_point=二次函数

# 组合筛选
GET /api/v2/mistakes?subject_name=数学&grade=高一&knowledge_point=二次函数&limit=50
```

---

### 3. 灵活试卷生成 📝

**功能描述**：
- 自主选择学科（数学、物理、化学、英语等）
- 自主选择年级（高一、高二、高三等）
- 指定知识点范围
- 灵活设置题型、难度、分值、时长
- AI智能生成符合要求的题目

**生成示例**：
```json
{
  "subject": "物理",
  "grade": "高二",
  "paper_title": "电学综合测试",
  "question_types": ["选择题", "计算题", "实验题"],
  "difficulty": "中等",
  "total_score": 100,
  "duration_minutes": 90,
  "knowledge_points": ["欧姆定律", "串并联电路", "电功率"]
}
```

**API端点**：
- 生成试卷：`POST /api/v2/papers/generate`

**预设学科**：
- 数学、物理、化学、生物
- 语文、英语
- 历史、地理、政治
- 可自定义扩展

**预设年级**：
- 高一、高二、高三
- 初一、初二、初三
- 可自定义扩展

---

## 📊 API完整列表

### 认证API（继续可用）

| 接口 | 方法 | 说明 |
|------|------|------|
| `/auth/register` | POST | 用户注册 |
| `/auth/login` | POST | 用户登录 |
| `/auth/verify` | GET | 验证Token |

### V25.2 新增API

#### 对话管理

| 接口 | 方法 | 说明 | 需要认证 |
|------|------|------|----------|
| `/api/v2/chat/session/create` | POST | 创建会话 | ✅ |
| `/api/v2/chat/sessions` | GET | 获取会话列表 | ✅ |
| `/api/v2/chat/session/{id}/history` | GET | 获取对话历史 | ✅ |
| `/api/v2/chat` | POST | 发送消息（连续对话） | ✅ |
| `/api/v2/chat/session/{id}` | DELETE | 删除会话 | ✅ |

#### 错题本管理

| 接口 | 方法 | 说明 | 需要认证 |
|------|------|------|----------|
| `/api/v2/mistakes/save` | POST | 手动保存错题 | ✅ |
| `/api/v2/mistakes` | GET | 获取错题列表 | ✅ |
| `/api/v2/mistakes/stats` | GET | 获取错题统计 | ✅ |
| `/api/v2/mistakes/{id}/review` | POST | 标记已复习 | ✅ |

#### 试卷生成

| 接口 | 方法 | 说明 | 需要认证 |
|------|------|------|----------|
| `/api/v2/papers/generate` | POST | 生成试卷 | ✅ |

### 旧版API（继续可用）

| 接口 | 方法 | 说明 |
|------|------|------|
| `/solve` | POST | AI解题（单次） |
| `/chat` | POST | 对话（不保存历史） |
| `/questions/generate` | POST | 生成题目 |

---

## 🔧 配置要求

### 环境要求

- Python 3.9+
- MySQL 5.7+ 或 MySQL 8.0+
- Node.js 16+ (如需运行前端)

### Python依赖

```txt
fastapi
uvicorn
pymysql
python-jose[cryptography]
passlib[bcrypt]
python-multipart
dashscope
python-dotenv
Pillow
```

确保已安装：
```bash
cd backend
venv\Scripts\activate
pip install -r ../requirements.txt
```

### 数据库配置

在 `backend/.env` 文件中配置：

```env
# API密钥
DASHSCOPE_API_KEY=sk-your-api-key

# 数据库配置（已在database.py中硬编码，可选）
DB_HOST=14.103.127.20
DB_PORT=3306
DB_USER=root
DB_PASSWORD=Jiuzhi#2024
DB_NAME=edu
```

---

## 📝 使用示例

### 1. 连续对话完整流程

```python
import requests

BASE_URL = "http://127.0.0.1:8000"
token = "YOUR_JWT_TOKEN"  # 从登录接口获取

headers = {
    "Authorization": f"Bearer {token}",
    "Content-Type": "application/json"
}

# 步骤1：创建会话
response = requests.post(f"{BASE_URL}/api/v2/chat/session/create", 
    headers=headers,
    json={
        "title": "数学学习",
        "mode": "solve",
        "subject": "数学",
        "grade": "高一"
    }
)
session_id = response.json()["session_id"]
print(f"会话ID: {session_id}")

# 步骤2：第一次提问
response = requests.post(f"{BASE_URL}/api/v2/chat",
    headers=headers,
    json={
        "session_id": session_id,
        "prompt": "什么是二次函数？",
        "mode": "solve",
        "subject": "数学",
        "grade": "高一"
    }
)
answer1 = response.json()["answer"]
print(f"AI回答: {answer1}")

# 步骤3：第二次提问（延续上下文）
response = requests.post(f"{BASE_URL}/api/v2/chat",
    headers=headers,
    json={
        "session_id": session_id,
        "prompt": "它的图像是什么样的？",  # AI能理解"它"指二次函数
        "mode": "solve",
        "subject": "数学",
        "grade": "高一"
    }
)
answer2 = response.json()["answer"]
print(f"AI回答: {answer2}")

# 步骤4：查看历史记录
response = requests.get(f"{BASE_URL}/api/v2/chat/session/{session_id}/history",
    headers=headers
)
history = response.json()["history"]
print(f"对话记录数: {len(history)}")
```

### 2. 错题本使用流程

```python
# 获取所有数学错题
response = requests.get(f"{BASE_URL}/api/v2/mistakes",
    headers=headers,
    params={"subject_name": "数学", "limit": 50}
)
mistakes = response.json()["mistakes"]
print(f"数学错题数量: {len(mistakes)}")

# 查看第一道错题
if mistakes:
    first_mistake = mistakes[0]
    print(f"题目: {first_mistake['subject_title']}")
    print(f"知识点: {first_mistake['knowledge_points']}")
    print(f"复习次数: {first_mistake['review_count']}")
    
    # 标记为已复习
    mistake_id = first_mistake['subject_id']
    requests.post(f"{BASE_URL}/api/v2/mistakes/{mistake_id}/review",
        headers=headers
    )
    print("已标记为复习")

# 获取错题统计
response = requests.get(f"{BASE_URL}/api/v2/mistakes/stats",
    headers=headers
)
stats = response.json()["stats"]
print(f"总错题数: {stats['overall']['total_mistakes']}")
print(f"按学科统计: {stats['by_subject']}")
```

### 3. 生成试卷流程

```python
# 生成高二物理试卷
response = requests.post(f"{BASE_URL}/api/v2/papers/generate",
    headers=headers,
    json={
        "subject": "物理",
        "grade": "高二",
        "paper_title": "电学综合测试",
        "question_types": ["选择题", "计算题"],
        "difficulty": "中等",
        "total_score": 100,
        "duration_minutes": 90,
        "knowledge_points": ["欧姆定律", "串并联电路"]
    }
)

result = response.json()
print(f"试卷ID: {result['exam_id']}")
print(f"题目预览:\n{result['questions_preview']}")
```

---

## 🐛 故障排查

### 问题1：数据库连接超时

**现象**：
```
pymysql.err.OperationalError: (2013, 'Lost connection to MySQL server')
```

**解决方案**：
✅ 已在V25.2中修复，增加了连接健康检查机制

如果仍然出现：
1. 重启后端服务
2. 检查数据库服务是否运行
3. 检查网络连接

### 问题2：升级脚本执行错误

**常见错误**：
- `Error 1060: Duplicate column name` - 字段已存在（可忽略）
- `Error 1061: Duplicate key name` - 索引已存在（可忽略）
- `Error 1050: Table already exists` - 表已存在（可忽略）

**验证升级成功**：
```sql
-- 检查新表
SHOW TABLES LIKE 'chat%';
-- 应该看到 chat_session 和 chat_history

-- 检查字段
DESC subject;
-- 应该看到 mistake_analysis、user_mistake_text 等新字段
```

### 问题3：API返回401未授权

**原因**：
- Token过期
- Token格式错误
- 未登录

**解决方案**：
```python
# 重新登录获取新Token
response = requests.post(f"{BASE_URL}/auth/login",
    json={
        "account": "your_account",
        "password": "your_password"
    }
)
token = response.json()["access_token"]
```

### 问题4：API返回500服务器错误

**排查步骤**：
1. 查看后端控制台错误信息
2. 检查数据库连接是否正常
3. 检查请求参数是否正确
4. 查看 `backend/database.py` 日志输出

---

## 📚 相关文档

- **完整开发报告**：`【完成】V25.2新功能开发报告.md`
- **数据库升级脚本**：`backend/database_schema_v25.2.sql`
- **数据库连接修复**：`【修复完成】数据库连接超时问题解决方案.md`
- **API文档**：访问 `http://127.0.0.1:8000/docs`

---

## 🎉 开始使用

1. **升级数据库**
   ```bash
   【执行】升级数据库到V25.2.bat
   ```

2. **启动后端**
   ```bash
   【启动】数据库版本系统.bat
   ```

3. **测试API**
   - 使用Postman
   - 或访问 http://127.0.0.1:8000/docs

4. **等待前端更新**
   - 前端集成开发中
   - 敬请期待！

---

## 📞 技术支持

如有问题，请查看：
1. 后端控制台日志
2. 错误信息详情
3. 相关文档

或联系开发团队！

---

**版本**：V25.2  
**日期**：2024-10-27  
**状态**：✅ 后端完成，前端开发中

