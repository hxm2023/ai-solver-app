# Feature 3: 智能出题系统 - 快速测试指南

## 🚀 5分钟快速测试

### 前置条件
✅ 后端服务已启动  
✅ 已有测试账号（Feature 1）  
✅ 已有测试错题（Feature 2）

---

## 测试步骤

### 1️⃣ 启动后端
```bash
cd backend
uvicorn main:app --reload
```

**预期输出**：
```
✅ 用户认证路由已加载
✅ 错题本路由已加载
✅ 智能出题路由已加载: /ai-learning/generate_knowledge_points, /ai-learning/generate_questions
```

---

### 2️⃣ 运行自动化测试
```bash
# 在backend目录下
python test_feature3_question_gen.py
```

**预期结果**：
```
█████████████████████████████████████████████████████████████████████
█            Feature 3: 智能出题系统测试                          █
█                     沐梧AI V23.0-F3                              █
█████████████████████████████████████████████████████████████████████

测试0：用户登录（前置条件）
✅ 登录成功！

测试1：创建测试错题（准备数据）
✅ 错题创建成功！ID: 1
✅ 错题创建成功！ID: 2
✅ 错题创建成功！ID: 3
总计创建: 3 条测试错题

测试2：从错题提炼知识点
提炼知识点...
✅ 知识点提炼成功！
提炼出的知识点:
  1. 一元二次方程
  2. 导数基础
  3. 完全平方公式

测试3：基于知识点生成题目
生成题目...
✅ 题目生成成功！
总计生成: 3 道题目
耗时: 18.45秒

生成的题目:
  题目1 (选择题):
  题干: 方程 x² - 3x + 2 = 0 的解是...
  答案: B

测试4：获取我生成的题目列表
✅ 获取成功！
   总计: 3 道题目

✅ Feature 3 智能出题系统测试完成！
```

---

### 3️⃣ 手动测试工作流程

#### Step 1: 登录
```bash
curl -X POST http://127.0.0.1:8000/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username": "test_student", "password": "password123"}'
```

保存返回的`access_token`

---

#### Step 2: 提炼知识点
```bash
export TOKEN="your_token_here"

curl -X POST http://127.0.0.1:8000/ai-learning/generate_knowledge_points \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "mistake_ids": [1, 2, 3],
    "subject": "数学"
  }'
```

**观察后端日志**：
```
======================================================================
【AI知识点提炼】
======================================================================
[AI调用] 准备调用通义千问...
[AI调用] 错题分析数量: 3
[AI调用] ✅ API调用成功
[AI调用] 提炼知识点数量: 3
[AI调用] 知识点列表: ['一元二次方程', '因式分解', '完全平方公式']
```

**响应示例**：
```json
{
  "knowledge_points": [
    "一元二次方程",
    "因式分解",
    "完全平方公式"
  ],
  "source_mistakes": [1, 2, 3],
  "subject": "数学",
  "ai_analysis": "这些错题主要考察了代数基础..."
}
```

---

#### Step 3: 生成题目
```bash
curl -X POST http://127.0.0.1:8000/ai-learning/generate_questions \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "knowledge_points": ["一元二次方程", "因式分解"],
    "difficulty": "中等",
    "question_types": {
      "选择题": 2,
      "填空题": 1
    },
    "subject": "数学"
  }'
```

**观察后端日志**：
```
======================================================================
【AI题目生成】
======================================================================
[AI生题] 题型: 选择题
[AI生题] 数量: 2
[AI生题] 难度: 中等
[AI生题] ✅ API调用成功，响应长度: 567 字符
[AI生题] 生成题目数量: 2

[题目生成] ========== 生成完成 ==========
[题目生成] 总计生成: 3 道题目
[题目生成] 耗时: 18.45 秒
[题目生成] ✅ 全部完成！
```

---

#### Step 4: 查看生成的题目
```bash
curl -X GET http://127.0.0.1:8000/ai-learning/my_questions \
  -H "Authorization: Bearer $TOKEN"
```

---

#### Step 5: 筛选题目
```bash
# 筛选中等难度的选择题
curl -X GET "http://127.0.0.1:8000/ai-learning/my_questions?question_type=选择题&difficulty=中等" \
  -H "Authorization: Bearer $TOKEN"
```

---

## 📊 验证清单

### 后端启动
- [ ] 看到智能出题路由加载成功
- [ ] 访问 http://127.0.0.1:8000/ 看到Version: V23.0-F3

### 知识点提炼
- [ ] API返回3-5个知识点
- [ ] 后端日志显示AI调用成功
- [ ] 知识点与错题内容相关

### 题目生成
- [ ] API返回指定数量的题目
- [ ] 题目格式正确（JSON可解析）
- [ ] 包含题干、答案、解析
- [ ] 后端日志显示完整生成过程

### 题目管理
- [ ] 能获取题目列表
- [ ] 分页功能正常
- [ ] 筛选功能正常
- [ ] 能删除题目

---

## 🐛 常见问题

### 问题1：知识点提炼失败
**症状**：API返回500错误

**排查**：
1. 检查后端日志：`[AI调用] ❌ API调用失败`
2. 确认通义千问API Key配置正确
3. 检查网络连接

**解决**：
```bash
# 检查环境变量
echo $DASHSCOPE_API_KEY
```

---

### 问题2：生成题目数量不对
**症状**：请求生成5道，只返回3道

**排查**：
1. 查看后端日志：`[AI生题] 生成题目数量: 3`
2. AI可能未生成足够数量

**解决**：
- 减少单次生成数量（如改为3道）
- 或调整Prompt

---

### 问题3：JSON解析失败
**症状**：后端日志显示`JSON解析失败`

**排查**：
1. 查看原始响应（日志中有截取）
2. AI返回格式不标准

**解决**：
- 已有备用方案自动处理
- 如果频繁失败，考虑调整Prompt

---

### 问题4：题目质量不理想
**症状**：生成的题目过于简单或不相关

**解决**：
1. 调整难度参数
2. 优化知识点描述（更具体）
3. 在Prompt中增加质量要求

---

## 🎯 成功标志

### 后端启动
```
✅ 智能出题路由已加载: /ai-learning/generate_knowledge_points, /ai-learning/generate_questions
```

### 知识点提炼日志
```
[AI调用] ✅ API调用成功
[AI调用] 提炼知识点数量: 3
[AI调用] 知识点列表: ['一元二次方程', '因式分解', '完全平方公式']
```

### 题目生成日志
```
[AI生题] ✅ JSON解析成功
[AI生题] 生成题目数量: 2
[题目生成] ✅ 全部完成！
```

### 测试通过
```
✅ Feature 3 智能出题系统测试完成！
功能验证：
  ✅ 从错题提炼知识点（AI分析）
  ✅ 基于知识点生成题目（多题型）
  ✅ 题目自动保存到数据库
  ✅ 题目列表获取（分页+筛选）
```

---

## 🔍 深入测试

### 测试不同题型
```bash
# 只生成选择题
curl -X POST http://127.0.0.1:8000/ai-learning/generate_questions \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "knowledge_points": ["函数"],
    "difficulty": "简单",
    "question_types": {"选择题": 5},
    "subject": "数学"
  }'
```

### 测试不同难度
```bash
# 生成困难题目
curl -X POST http://127.0.0.1:8000/ai-learning/generate_questions \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "knowledge_points": ["微积分", "极限"],
    "difficulty": "困难",
    "question_types": {"解答题": 2},
    "subject": "数学"
  }'
```

### 测试大量题目生成
```bash
# 生成10道题（耗时较长）
curl -X POST http://127.0.0.1:8000/ai-learning/generate_questions \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "knowledge_points": ["代数"],
    "difficulty": "中等",
    "question_types": {
      "选择题": 5,
      "填空题": 3,
      "解答题": 2
    },
    "subject": "数学"
  }'
```

---

## 📚 更多信息

- **完整文档**：`V23.0_Feature3_智能出题系统文档.md`
- **API文档**：http://127.0.0.1:8000/docs
- **代码位置**：
  - API路由：`backend/question_generation_routes.py`
  - 数据模型：`backend/models.py` (GeneratedQuestion)
  - 主程序：`backend/main.py`

---

## 🚀 下一步

Feature 3 测试通过后，准备开始：
**Feature 4: 试卷生成与下载** 🎯

功能预告：
- 从生成的题目中组卷
- 生成学生版（无答案）
- 生成教师版（含答案解析）
- PDF下载

---

**测试时间**: 约10-15分钟（包含AI生成时间）  
**难度**: ⭐⭐⭐☆☆  
**状态**: ✅ 就绪

