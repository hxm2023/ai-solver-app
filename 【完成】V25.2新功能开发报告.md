# 沐梧AI解题系统 V25.2 - 新功能开发报告

## 📅 开发信息

- **版本号**：V25.2
- **开发日期**：2024-10-27
- **开发内容**：连续对话、错题本增强、试卷生成优化
- **状态**：✅ 后端开发完成，前端开发待进行

---

## 🎯 需求概述

### 1. 与大模型的连续对话功能
- **需求**：支持多轮对话，AI能够记住上下文
- **数据库支持**：存储对话历史信息

### 2. 错题自动保存到错题本
- **需求**：批改作业时自动识别并保存错题
- **存储内容**：错题图片、解析、知识点标签

### 3. 生成试卷时选择学科和年级
- **需求**：自主选择学科和年级信息
- **扩展性**：支持基于学科和年级的题目筛选

---

## ✅ 已完成内容

### 一、数据库表结构设计

#### 1. 对话会话表 (`chat_session`)

| 字段 | 类型 | 说明 |
|------|------|------|
| session_id | VARCHAR(64) | 会话ID（主键） |
| user_id | VARCHAR(64) | 用户ID |
| title | VARCHAR(200) | 会话标题 |
| mode | VARCHAR(20) | 对话模式（solve/review/ask） |
| subject | VARCHAR(50) | 学科 |
| grade | VARCHAR(20) | 年级 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |
| is_deleted | TINYINT(1) | 是否删除 |

#### 2. 对话历史表 (`chat_history`)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 记录ID（主键，自增） |
| session_id | VARCHAR(64) | 会话ID |
| role | VARCHAR(20) | 角色（user/assistant） |
| content | TEXT | 消息内容 |
| image_url | TEXT | 图片URL |
| image_base64 | MEDIUMTEXT | 图片Base64数据 |
| message_type | VARCHAR(20) | 消息类型（text/image/mixed） |
| created_at | DATETIME | 创建时间 |

#### 3. 错题本增强字段（`subject`表扩展）

新增字段：
- `mistake_analysis` - 错题分析（AI生成）
- `user_mistake_text` - 用户的错误答案
- `correct_rate` - 正确率
- `review_count` - 复习次数
- `last_review_at` - 最后复习时间

#### 4. 知识点标签表 (`knowledge_tag`)

| 字段 | 类型 | 说明 |
|------|------|------|
| tag_id | INT | 标签ID（主键，自增） |
| tag_name | VARCHAR(100) | 知识点名称 |
| subject | VARCHAR(50) | 所属学科 |
| parent_tag_id | INT | 父标签ID（层级结构） |
| description | TEXT | 标签描述 |

#### 5. 试卷表扩展（`exam`表）

新增字段：
- `subject` - 学科
- `grade` - 年级
- `total_score` - 总分
- `duration_minutes` - 考试时长
- `template_id` - 使用的模板ID

---

### 二、后端API开发

#### 1. 对话历史管理API

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/v2/chat/session/create` | POST | 创建新会话 |
| `/api/v2/chat/sessions` | GET | 获取用户所有会话 |
| `/api/v2/chat/session/{id}/history` | GET | 获取会话历史记录 |
| `/api/v2/chat` | POST | 连续对话（核心接口） |
| `/api/v2/chat/session/{id}` | DELETE | 删除会话 |

**核心功能：`/api/v2/chat`**

```python
# 请求示例
{
  "session_id": "uuid-xxxx",  # 可选，不提供则创建新会话
  "prompt": "请解释一下二次函数的顶点公式",
  "image_base64": "base64_string",  # 可选
  "mode": "solve",  # solve/review/ask
  "subject": "数学",
  "grade": "高一"
}

# 响应示例
{
  "success": true,
  "session_id": "uuid-xxxx",
  "answer": "AI的详细回答...",
  "mistake_saved": false,
  "mistake_id": null,
  "message_count": 5
}
```

**特性**：
- ✅ 自动保存对话历史到数据库
- ✅ 支持多轮对话，AI记住上下文
- ✅ 支持图文混合输入
- ✅ 批改模式下自动识别并保存错题
- ✅ 自动更新会话标题

#### 2. 错题本增强API

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/v2/mistakes/save` | POST | 手动保存错题 |
| `/api/v2/mistakes` | GET | 获取错题列表（支持筛选） |
| `/api/v2/mistakes/stats` | GET | 获取错题统计 |
| `/api/v2/mistakes/{id}/review` | POST | 标记为已复习 |

**获取错题列表示例**：

```python
# GET /api/v2/mistakes?subject_name=数学&grade=高一&limit=50

{
  "success": true,
  "mistakes": [
    {
      "subject_id": "uuid-xxxx",
      "subject_title": "错题_20241027120000",
      "subject_desc": "题目内容...",
      "image_url": "...",
      "answer": "正确答案",
      "explanation": "详细解析",
      "knowledge_points": "[\"二次函数\", \"顶点公式\"]",
      "subject_name": "数学",
      "grade": "高一",
      "review_count": 2,
      "last_review_at": "2024-10-27 12:00:00"
    }
  ],
  "total": 15
}
```

**特性**：
- ✅ 自动保存错题（批改模式）
- ✅ 手动保存错题
- ✅ 支持按学科、年级、知识点筛选
- ✅ 记录复习次数和时间
- ✅ 统计分析功能

#### 3. 试卷生成增强API

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/v2/papers/generate` | POST | 生成试卷（支持学科年级选择） |

**请求示例**：

```python
{
  "subject": "数学",
  "grade": "高二",
  "paper_title": "二次函数综合练习",
  "question_types": ["选择题", "填空题", "解答题"],
  "difficulty": "中等",
  "total_score": 100,
  "duration_minutes": 90,
  "knowledge_points": ["二次函数", "函数图像", "最值问题"]
}

# 响应
{
  "success": true,
  "exam_id": "uuid-xxxx",
  "subject": "数学",
  "grade": "高二",
  "question_ids": ["q1", "q2", ...],
  "questions_preview": "AI生成的题目内容...",
  "message": "试卷生成成功"
}
```

**特性**：
- ✅ 自主选择学科和年级
- ✅ 指定知识点范围
- ✅ 灵活设置题型、难度、分值、时长
- ✅ AI智能生成题目

---

### 三、数据库管理类

#### 1. ChatManager（对话管理）

```python
from database import ChatManager

# 创建会话
session_id = ChatManager.create_session(
    user_id="user_123",
    title="数学学习",
    mode="solve",
    subject="数学",
    grade="高一"
)

# 添加消息
ChatManager.add_message(
    session_id=session_id,
    role="user",
    content="什么是二次函数？"
)

# 获取历史
history = ChatManager.get_session_history(session_id, limit=10)

# 获取用户所有会话
sessions = ChatManager.get_user_sessions(user_id="user_123")

# 删除会话
ChatManager.delete_session(session_id, soft_delete=True)
```

#### 2. MistakeManager（错题本管理）

```python
from database import MistakeManager

# 保存错题
subject_id = MistakeManager.save_mistake(
    user_id="user_123",
    subject_title="二次函数错题",
    subject_desc="题目描述",
    image_url="...",
    user_mistake_text="学生的错误答案",
    correct_answer="正确答案",
    explanation="详细解析",
    knowledge_points=["二次函数", "顶点公式"],
    subject_name="数学",
    grade="高一",
    difficulty="中等"
)

# 获取错题列表
mistakes = MistakeManager.get_user_mistakes(
    user_id="user_123",
    subject_name="数学",
    grade="高一",
    limit=50
)

# 标记已复习
MistakeManager.update_review_status(subject_id)

# 获取统计
stats = MistakeManager.get_mistake_stats(user_id="user_123")
```

---

## 📦 数据库升级脚本

### 执行步骤

1. **备份现有数据库**（重要！）
   ```sql
   mysqldump -u root -p edu > edu_backup_20241027.sql
   ```

2. **执行升级脚本**
   ```bash
   # 方法一：在MySQL客户端中执行
   mysql -u root -p edu < backend/database_schema_v25.2.sql
   
   # 方法二：在Navicat中执行
   # 打开 database_schema_v25.2.sql，选择所有内容，按F9执行
   ```

3. **验证表结构**
   ```sql
   -- 检查新表是否创建
   SHOW TABLES LIKE 'chat%';
   SHOW TABLES LIKE 'knowledge%';
   
   -- 检查字段是否添加
   DESC subject;
   DESC exam;
   DESC chat_session;
   DESC chat_history;
   ```

4. **查看默认数据**
   ```sql
   -- 查看预置的知识点标签
   SELECT * FROM knowledge_tag;
   ```

### 注意事项

- ✅ 脚本使用 `CREATE TABLE IF NOT EXISTS`，可重复执行
- ✅ 使用 `ALTER TABLE ADD COLUMN`，已存在的字段会报错但不影响
- ✅ 所有表使用 `utf8mb4` 编码，支持emoji等特殊字符
- ✅ 外键关联确保数据一致性（删除用户时级联删除相关数据）

---

## 🔄 与旧版本的兼容性

### 完全兼容

V25.2 **完全向下兼容** V25.1 和之前的版本：

1. **旧API继续可用**
   - 所有 `/auth/*`、`/solve`、`/chat`、`/questions/*` 等旧接口保持不变
   - 新API使用 `/api/v2/*` 路径，不影响现有功能

2. **数据库表结构扩展**
   - 只增加新表和新字段
   - 不修改或删除现有表和字段
   - 现有数据不受影响

3. **前端可选升级**
   - 前端可以继续使用旧API
   - 或逐步迁移到新API（推荐）

---

## 📝 前端集成指南（待开发）

### 1. 连续对话功能集成

**推荐方案**：在AI解题页面添加会话管理

```typescript
// 示例代码（待实现）
import { useState, useEffect } from 'react';

function AISolver() {
  const [sessionId, setSessionId] = useState<string | null>(null);
  const [history, setHistory] = useState([]);
  
  // 创建新会话
  const createSession = async () => {
    const response = await fetch('/api/v2/chat/session/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
      body: JSON.stringify({
        title: '新对话',
        mode: 'solve',
        subject: '数学',
        grade: '高一'
      })
    });
    const data = await response.json();
    setSessionId(data.session_id);
  };
  
  // 发送消息
  const sendMessage = async (prompt: string, imageBase64?: string) => {
    const response = await fetch('/api/v2/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
      body: JSON.stringify({
        session_id: sessionId,
        prompt,
        image_base64: imageBase64,
        mode: 'solve',
        subject: '数学',
        grade: '高一'
      })
    });
    const data = await response.json();
    // 更新历史记录
    setHistory([...history, 
      { role: 'user', content: prompt },
      { role: 'assistant', content: data.answer }
    ]);
  };
  
  // 加载历史记录
  const loadHistory = async (sid: string) => {
    const response = await fetch(`/api/v2/chat/session/${sid}/history`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await response.json();
    setHistory(data.history);
  };
  
  return (
    <div>
      <button onClick={createSession}>新对话</button>
      {/* 对话界面 */}
    </div>
  );
}
```

### 2. 错题本筛选功能

```typescript
function MistakeBook() {
  const [subject, setSubject] = useState('全部');
  const [grade, setGrade] = useState('全部');
  const [mistakes, setMistakes] = useState([]);
  
  const loadMistakes = async () => {
    const params = new URLSearchParams();
    if (subject !== '全部') params.append('subject_name', subject);
    if (grade !== '全部') params.append('grade', grade);
    
    const response = await fetch(`/api/v2/mistakes?${params}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await response.json();
    setMistakes(data.mistakes);
  };
  
  return (
    <div>
      <select value={subject} onChange={e => setSubject(e.target.value)}>
        <option>全部</option>
        <option>数学</option>
        <option>物理</option>
        <option>化学</option>
      </select>
      <select value={grade} onChange={e => setGrade(e.target.value)}>
        <option>全部</option>
        <option>高一</option>
        <option>高二</option>
        <option>高三</option>
      </select>
      <button onClick={loadMistakes}>筛选</button>
      {/* 错题列表 */}
    </div>
  );
}
```

### 3. 试卷生成学科年级选择

```typescript
function PaperGenerator() {
  const [subject, setSubject] = useState('数学');
  const [grade, setGrade] = useState('高一');
  
  const generatePaper = async () => {
    const response = await fetch('/api/v2/papers/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
      body: JSON.stringify({
        subject,
        grade,
        paper_title: `${subject}${grade}测试卷`,
        question_types: ['选择题', '填空题', '解答题'],
        difficulty: '中等',
        total_score: 100,
        duration_minutes: 90,
        knowledge_points: ['综合知识']
      })
    });
    const data = await response.json();
    console.log('试卷生成成功', data);
  };
  
  return (
    <div>
      <select value={subject} onChange={e => setSubject(e.target.value)}>
        <option>数学</option>
        <option>物理</option>
        <option>化学</option>
        <option>英语</option>
      </select>
      <select value={grade} onChange={e => setGrade(e.target.value)}>
        <option>高一</option>
        <option>高二</option>
        <option>高三</option>
      </select>
      <button onClick={generatePaper}>生成试卷</button>
    </div>
  );
}
```

---

## 🧪 测试清单

### 数据库测试

- [ ] 执行升级脚本无错误
- [ ] 新表创建成功
- [ ] 新字段添加成功
- [ ] 外键关联正常
- [ ] 触发器工作正常

### API测试

#### 对话历史API
- [ ] 创建会话成功
- [ ] 发送消息并保存历史
- [ ] 获取历史记录正确
- [ ] 多轮对话上下文保持
- [ ] 删除会话成功

#### 错题本API
- [ ] 手动保存错题成功
- [ ] 批改模式自动保存错题
- [ ] 按学科筛选正确
- [ ] 按年级筛选正确
- [ ] 统计数据准确

#### 试卷生成API
- [ ] 指定学科和年级生成成功
- [ ] AI生成题目质量合格
- [ ] 试卷信息保存正确

---

## 📊 性能考虑

### 1. 数据库索引

已创建的索引：
- `chat_session`: user_id, created_at, is_deleted
- `chat_history`: session_id, created_at, role
- `subject`: subject_type, subject_name, grade
- `exam`: exam_type, subject, grade

### 2. 查询优化

- 对话历史查询限制返回数量（默认100条）
- 错题列表支持分页（默认100条）
- 使用软删除避免频繁物理删除

### 3. 存储优化

- 图片Base64可选存储（可改为文件系统）
- 长文本字段使用TEXT类型
- 时间字段自动维护

---

## 🚀 下一步工作

### 待完成任务

1. ✅ 数据库表结构设计
2. ✅ 后端API开发
3. ⏳ 前端界面开发
   - [ ] AI解题页面集成连续对话
   - [ ] 错题本页面添加筛选功能
   - [ ] 试卷生成页面添加学科年级选择
4. ⏳ 功能测试
5. ⏳ 用户文档编写

### 可选优化

- [ ] 图片上传到文件系统（云存储）
- [ ] 知识点自动提取优化
- [ ] 错题智能分析报告
- [ ] 学习统计可视化
- [ ] 试卷模板管理

---

## 📞 技术支持

### 常见问题

**Q: 升级脚本执行报错怎么办？**

A: 
1. 检查是否是"字段已存在"或"索引已存在"错误，这是正常的可忽略
2. 检查MySQL版本是否 ≥ 5.7
3. 检查用户权限是否足够
4. 查看详细错误信息，联系技术支持

**Q: 旧数据会丢失吗？**

A: 不会。脚本只增加新表和字段，不删除或修改现有数据。但建议升级前备份数据库。

**Q: 前端需要修改吗？**

A: 不强制。旧版前端可以继续使用，新功能需要更新前端才能体验。

---

## ✨ 总结

V25.2 版本新增了三大核心功能：

1. **连续对话** - 让AI助手真正成为学习伙伴
2. **智能错题本** - 自动收集、科学管理、精准复习
3. **灵活试卷生成** - 按需定制、智能出题

这些功能将显著提升用户的学习体验和系统的实用性！

---

**开发完成时间**：2024-10-27  
**后端开发**：✅ 100% 完成  
**前端开发**：⏳ 待进行  
**版本状态**：Ready for Frontend Integration

