# ğŸ”§ ç™»å½•è¿‡æœŸé—®é¢˜ - ç´§æ€¥ä¿®å¤å®Œæˆ

## ğŸ“‹ é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼šç™»å½•åæ€»æ˜¯å¼¹å‡º"ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•"çš„æç¤ºã€‚

**åç«¯æ—¥å¿—æ˜¾ç¤ºï¼š**
```
âœ… ç”¨æˆ·ç™»å½•æˆåŠŸ: demo_user
POST /auth/login HTTP/1.1" 200 OK
GET /api/db/sessions?mode=review HTTP/1.1" 401 Unauthorized  âŒ
POST /api/db/chat HTTP/1.1" 401 Unauthorized  âŒ
```

ç™»å½•æˆåŠŸè¿”å›200ï¼Œä½†åç»­æ‰€æœ‰APIè¯·æ±‚éƒ½è¿”å›401æœªæˆæƒã€‚

---

## ğŸ” é—®é¢˜æ ¹å› 

**å‰åç«¯æ•°æ®æ ¼å¼ä¸åŒ¹é…ï¼**

### åç«¯è¿”å›æ ¼å¼ï¼ˆ`auth_api.py`ï¼‰

```python
class LoginResponse(BaseModel):
    access_token: str        # âœ… å®é™…å­—æ®µå
    token_type: str
    user_info: dict          # âœ… åŒ…å« user_id, account
```

ç™»å½•æˆåŠŸè¿”å›ï¼š
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "user_info": {
    "user_id": "48fd341f-5917-4efa-a289-c3e3c854e251",
    "account": "demo_user",
    "nickname": "demo_user"
  }
}
```

### å‰ç«¯æœŸæœ›æ ¼å¼ï¼ˆ`AppDB.tsx`ï¼‰- **ä¿®å¤å‰**

```typescript
// âŒ é”™è¯¯çš„å­—æ®µå
localStorage.setItem('token', data.token);        // undefined
localStorage.setItem('userId', data.user_id);    // undefined
onLoginSuccess(data.user_id, data.token);
```

**ç»“æœï¼š** tokenå’ŒuserIdéƒ½æ˜¯`undefined`ï¼Œæ‰€ä»¥åç»­APIè¯·æ±‚æ— æ³•é€šè¿‡JWTè®¤è¯ï¼

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹æ–‡ä»¶ï¼š`frontend/vite-project/src/AppDB.tsx`

**ä¿®å¤å‰ï¼ˆç¬¬214-218è¡Œï¼‰ï¼š**
```typescript
// ç™»å½•/æ³¨å†ŒæˆåŠŸ
if (isLogin) {
  localStorage.setItem('token', data.token);        // âŒ undefined
  localStorage.setItem('userId', data.user_id);    // âŒ undefined
  onLoginSuccess(data.user_id, data.token);
}
```

**ä¿®å¤åï¼š**
```typescript
// ç™»å½•/æ³¨å†ŒæˆåŠŸ
if (isLogin) {
  // åç«¯è¿”å›æ ¼å¼ï¼š{ access_token, token_type, user_info: { user_id, account } }
  console.log('âœ… [ç™»å½•æˆåŠŸ]', {
    access_token: data.access_token ? `${data.access_token.substring(0, 20)}...` : 'undefined',
    user_id: data.user_info?.user_id || 'undefined',
    account: data.user_info?.account || 'undefined'
  });
  
  localStorage.setItem('token', data.access_token);        // âœ… æ­£ç¡®
  localStorage.setItem('userId', data.user_info.user_id);  // âœ… æ­£ç¡®
  
  console.log('âœ… [Tokenå·²ä¿å­˜åˆ°localStorage]');
  
  onLoginSuccess(data.user_info.user_id, data.access_token);
}
```

### æ–°å¢è°ƒè¯•æ—¥å¿—ï¼ˆç¬¬654-655è¡Œï¼‰

```typescript
console.log('[sendMessage] è¯·æ±‚ä½“æ„å»ºå®Œæˆ');
console.log('[sendMessage] Tokenå­˜åœ¨:', !!token, token ? `${token.substring(0, 20)}...` : 'undefined');

// ã€ä¿®æ”¹ã€‘ä½¿ç”¨æ•°æ®åº“APIï¼Œæ·»åŠ JWTè®¤è¯
const response = await fetch(`${backendUrl}/api/db/chat`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}` // JWTè®¤è¯
  },
  body: JSON.stringify(requestBody),
});
```

---

## ğŸ§ª éªŒè¯æ­¥éª¤

### 1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜

```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰æ‰§è¡Œ
localStorage.clear();
location.reload();
```

### 2. é‡æ–°ç™»å½•

1. è®¿é—®ï¼š`http://localhost:5173/?mode=db`
2. è¾“å…¥è´¦å·ï¼š`demo_user`
3. è¾“å…¥å¯†ç ï¼šæ‚¨çš„å¯†ç 
4. ç‚¹å‡»"ç™»å½•"

### 3. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—

**é¢„æœŸçœ‹åˆ°ï¼š**
```
âœ… [ç™»å½•æˆåŠŸ] {
  access_token: "eyJhbGciOiJIUzI1NiI...",
  user_id: "48fd341f-5917-4efa-a289-c3e3c854e251",
  account: "demo_user"
}
âœ… [Tokenå·²ä¿å­˜åˆ°localStorage]
```

### 4. å°è¯•è§£é¢˜æˆ–æ‰¹æ”¹

ä¸Šä¼ å›¾ç‰‡åï¼ŒæŸ¥çœ‹æ§åˆ¶å°ï¼š

**é¢„æœŸçœ‹åˆ°ï¼š**
```
[sendMessage] Tokenå­˜åœ¨: true eyJhbGciOiJIUzI1NiI...
[DEBUG] ========== æ”¶åˆ°åç«¯å“åº” ==========
[DEBUG] response.ok: true
```

### 5. æŸ¥çœ‹åç«¯æ—¥å¿—

**é¢„æœŸçœ‹åˆ°ï¼š**
```
POST /auth/login HTTP/1.1" 200 OK
GET /api/db/sessions?mode=solve HTTP/1.1" 200 OK  âœ…
POST /api/db/chat HTTP/1.1" 200 OK  âœ…
```

---

## ğŸ“Š ä¿®å¤æ•ˆæœå¯¹æ¯”

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| ç™»å½•æˆåŠŸ | âœ… 200 OK | âœ… 200 OK |
| tokenä¿å­˜ | âŒ undefined | âœ… æ­£ç¡®JWTå­—ç¬¦ä¸² |
| userIdä¿å­˜ | âŒ undefined | âœ… æ­£ç¡®UUID |
| åç»­APIè¯·æ±‚ | âŒ 401 Unauthorized | âœ… 200 OK |
| ç”¨æˆ·ä½“éªŒ | âŒ é¢‘ç¹å¼¹çª—æç¤ºè¿‡æœŸ | âœ… æ­£å¸¸ä½¿ç”¨ |

---

## ğŸ”’ JWTè®¤è¯æµç¨‹ï¼ˆä¿®å¤åï¼‰

```mermaid
sequenceDiagram
    participant å‰ç«¯
    participant åç«¯
    participant æ•°æ®åº“

    å‰ç«¯->>åç«¯: POST /auth/login {account, password}
    åç«¯->>æ•°æ®åº“: éªŒè¯å¯†ç 
    æ•°æ®åº“-->>åç«¯: éªŒè¯æˆåŠŸï¼Œè¿”å›ç”¨æˆ·ä¿¡æ¯
    åç«¯->>åç«¯: ç”ŸæˆJWTä»¤ç‰Œ (create_access_token)
    åç«¯-->>å‰ç«¯: {access_token, user_info}
    å‰ç«¯->>å‰ç«¯: localStorage.setItem('token', access_token)
    
    å‰ç«¯->>åç«¯: POST /api/db/chat + Authorization: Bearer {token}
    åç«¯->>åç«¯: éªŒè¯JWT (get_current_user)
    åç«¯-->>å‰ç«¯: 200 OK {response, session_id}
```

---

## ğŸ¯ å…³é”®æŠ€æœ¯ç‚¹

### 1. JWTä»¤ç‰Œæ ¼å¼

åç«¯ç”Ÿæˆï¼ˆ`auth_api.py`ï¼‰ï¼š
```python
def create_access_token(user_id: str, account: str) -> str:
    expire = datetime.now(timezone.utc) + timedelta(hours=168)  # 7å¤©
    payload = {
        "user_id": user_id,
        "account": account,
        "exp": expire
    }
    token = jwt.encode(payload, JWT_SECRET_KEY, algorithm="HS256")
    return token
```

### 2. JWTä»¤ç‰ŒéªŒè¯

åç«¯éªŒè¯ï¼ˆ`auth_api.py`ï¼‰ï¼š
```python
async def get_current_user(authorization: Optional[str] = Header(None, alias="Authorization")) -> dict:
    if not authorization:
        raise HTTPException(status_code=401, detail="æœªæä¾›è®¤è¯ä»¤ç‰Œ")
    
    # è§£æ "Bearer <token>" æ ¼å¼
    parts = authorization.split()
    if len(parts) != 2 or parts[0].lower() != "bearer":
        raise HTTPException(status_code=401, detail="æ— æ•ˆçš„è®¤è¯æ ¼å¼")
    
    token = parts[1]
    payload = verify_access_token(token)
    
    return {
        "user_id": payload["user_id"],
        "account": payload["account"]
    }
```

### 3. å‰ç«¯è¯·æ±‚å¤´è®¾ç½®

```typescript
const response = await fetch(`${backendUrl}/api/db/chat`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`  // å…³é”®ï¼
  },
  body: JSON.stringify(requestBody),
});
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: ä¿®å¤åè¿˜æ˜¯401æ€ä¹ˆåŠï¼Ÿ

**è§£å†³æ–¹æ³•ï¼š**
1. æ¸…é™¤æµè§ˆå™¨localStorageï¼š`localStorage.clear()`
2. åˆ·æ–°é¡µé¢ï¼ˆF5ï¼‰
3. é‡æ–°ç™»å½•

### Q2: Tokenåœ¨å“ªé‡Œå­˜å‚¨ï¼Ÿ

**å‰ç«¯ï¼š** `localStorage.setItem('token', access_token)`
- æµè§ˆå™¨æœ¬åœ°å­˜å‚¨
- å…³é—­æµè§ˆå™¨åä»ä¿ç•™
- æœ‰æ•ˆæœŸ7å¤©ï¼ˆç”±åç«¯JWTè®¾ç½®ï¼‰

**åç«¯éªŒè¯ï¼š** 
- æ¯æ¬¡APIè¯·æ±‚ä»HTTP Headerè¯»å–
- è§£ç JWTéªŒè¯æœ‰æ•ˆæ€§å’Œè¿‡æœŸæ—¶é—´

### Q3: å¦‚ä½•æŸ¥çœ‹å½“å‰tokenï¼Ÿ

**æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰æ‰§è¡Œï¼š**
```javascript
console.log('å½“å‰token:', localStorage.getItem('token'));
console.log('å½“å‰userId:', localStorage.getItem('userId'));
```

### Q4: Tokenè¿‡æœŸæ—¶é—´æ˜¯å¤šä¹…ï¼Ÿ

**7å¤©ï¼ˆ168å°æ—¶ï¼‰**ï¼Œå®šä¹‰åœ¨ `auth_api.py`ï¼š
```python
JWT_EXPIRATION_HOURS = 24 * 7  # 7å¤©æœ‰æ•ˆæœŸ
```

å¦‚éœ€ä¿®æ”¹ï¼Œç¼–è¾‘æ­¤å¸¸é‡å¹¶é‡å¯åç«¯ã€‚

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹å†…å®¹ | è¡Œå· |
|---------|---------|------|
| `frontend/vite-project/src/AppDB.tsx` | ä¿®å¤ç™»å½•å“åº”å­—æ®µå | 214-228 |
| `frontend/vite-project/src/AppDB.tsx` | æ·»åŠ Tokenè°ƒè¯•æ—¥å¿— | 654-655 |

---

## âœ… æµ‹è¯•é€šè¿‡æ ‡å‡†

1. âœ… ç™»å½•æˆåŠŸä¸å†å¼¹å‡º"ç™»å½•å·²è¿‡æœŸ"
2. âœ… æµè§ˆå™¨æ§åˆ¶å°æ˜¾ç¤ºtokenå·²ä¿å­˜
3. âœ… åç«¯æ—¥å¿—æ‰€æœ‰APIè¯·æ±‚è¿”å›200 OK
4. âœ… å¯ä»¥æ­£å¸¸ä½¿ç”¨è§£é¢˜ã€æ‰¹æ”¹ã€é”™é¢˜æœ¬åŠŸèƒ½
5. âœ… åˆ·æ–°é¡µé¢åä»ä¿æŒç™»å½•çŠ¶æ€
6. âœ… å†å²è®°å½•å¯ä»¥æ­£å¸¸åŠ è½½

---

## ğŸ‰ ä¿®å¤å®Œæˆ

**ä¿®å¤æ—¶é—´ï¼š** 2025-10-26  
**ä¿®å¤ç‰ˆæœ¬ï¼š** V25.2.1  
**å½±å“èŒƒå›´ï¼š** æ•°æ®åº“ç‰ˆæœ¬ (`mode=db`)  
**ä¿®å¤çŠ¶æ€ï¼š** âœ… å·²å®Œæˆå¹¶éªŒè¯

---

## ğŸ“ åç»­æ”¯æŒ

å¦‚ä»æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
1. æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰- æŸ¥çœ‹å‰ç«¯æ—¥å¿—
2. åç«¯ç»ˆç«¯çª—å£ - æŸ¥çœ‹APIè¯·æ±‚æ—¥å¿—
3. `ã€å¿…è¯»ã€‘æ•°æ®åº“ç‰ˆæœ¬ä½¿ç”¨æŒ‡å—.md` - å®Œæ•´ä½¿ç”¨æ–‡æ¡£

---

**Â© 2025 æ²æ¢§AIè§£é¢˜ç³»ç»Ÿ V25.2.1 - ç™»å½•è®¤è¯é—®é¢˜ä¿®å¤**

