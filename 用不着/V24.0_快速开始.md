# V24.0 快速开始指南 🚀

## 一、环境检查

### 后端依赖（已包含在requirements.txt）
```bash
cd backend
pip install -r requirements.txt
```

**新增依赖**:
- `opencv-python-headless` - 图像处理（已在V23.0添加）
- `numpy` - 数值计算（已在V23.0添加）

### 前端依赖
```bash
cd frontend/vite-project
npm install
```

无需新增依赖！

---

## 二、启动服务

### 1. 启动后端
```bash
cd backend
python -m uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

**验证**: 访问 http://127.0.0.1:8000  
应该看到: `{"message": "AI解题后端服务正在运行 (V24.0 整页多题并行处理版)"}`

### 2. 启动前端
```bash
cd frontend/vite-project
npm run dev
```

**访问**: http://localhost:5173

---

## 三、测试V24.0新功能

### 测试场景1: 单题模式（验证向后兼容）
1. 选择"AI 智能解题"
2. 保持默认"解/改单个题目"
3. 上传单题图片
4. 点击"解析整张图片"
5. ✅ **预期**: 正常处理，无QuestionSelector显示

### 测试场景2: 整页多题模式（核心功能）
1. 选择"AI 智能解题"
2. 切换到"解/改整张图片"
3. 上传包含多题的试卷图片（建议3-5题）
4. 点击"解析整张图片"
5. ✅ **预期**: 
   - 短暂显示"🔍 正在智能识别和分割题目..."
   - 自动跳转到聊天界面
   - 顶部显示圆形数字按钮（1、2、3...）
   - 所有题目并行处理（可看到多个"正在输入"动画）
   - 点击数字切换题目

### 测试场景3: 裁剪功能（验证兼容性）
1. 上传图片后，拖动选择裁剪区域
2. 点击"仅处理裁剪区域"
3. ✅ **预期**: 正常裁剪和处理

---

## 四、核心API端点

### 1. `/process_sheet` (新增)
**用途**: 分割整页图片

**请求**:
```json
{
  "prompt": "请逐题解答，每道题都要写出详细的解题步骤和思路。",
  "image_base_64": "iVBORw0KGgoAAAANS..."
}
```

**响应**:
```json
{
  "job_id": "job_a1b2c3d4",
  "total_count": 3,
  "questions": [
    {
      "id": "q_uuid1",
      "image_base_64": "iVBORw0KG...",
      "index": 0
    },
    ...
  ]
}
```

### 2. `/chat` (保持不变)
**用途**: 处理单个题目的聊天

**请求**:
```json
{
  "session_id": "session_xyz",
  "prompt": "请认真审题并详细解答...",
  "image_base_64": "iVBORw0KG..."
}
```

---

## 五、调试技巧

### 查看后端日志
```bash
# 启动后端时会看到详细日志
[题目分割器] 🔍 开始智能检测题目区域...
[题目分割器] ✓ 检测到 5 个题目区域
[/process_sheet] ✅ 成功将图片分割为 5 个独立题目单元
```

### 查看前端日志（浏览器Console）
```javascript
[startMultiQuestionProcessing] 后端返回 5 个题目单元
[sendMessage] 会话 0 开始处理...
[sendMessage] 会话 1 开始处理...
...
[startMultiQuestionProcessing] ✅ 所有题目处理完成！
```

### 生成调试图片
在 `backend/question_splitter.py` 中添加：
```python
# 在 @app.post("/process_sheet") 中
from question_splitter import visualize_detected_boxes
visualize_detected_boxes(full_image, question_boxes, "debug/detected_boxes.png")
```

会生成带红色框标注的图片，方便查看分割效果。

---

## 六、常见问题

### Q1: 题目分割不准确？
**A**: 
- 检查图片质量（建议分辨率 > 1000px）
- 确保题目之间有明显间距
- 调整 `question_splitter.py` 中的过滤参数：
  ```python
  if (img_width * 0.2 < w < img_width * 0.95):  # 调整这些阈值
  ```

### Q2: 某些题目处理失败？
**A**: 
- 查看该题目的错误信息（会显示在题目下方）
- 检查后端日志中的错误堆栈
- 使用`Promise.allSettled`确保其他题目不受影响

### Q3: 前端显示空白？
**A**: 
1. 打开浏览器Console查看错误
2. 确认后端服务正在运行
3. 检查 `backendUrl` 是否正确（默认 `http://127.0.0.1:8000`）

### Q4: QuestionSelector不显示？
**A**: 
- 只有检测到2个及以上题目才显示
- 检查 `sessions.length` 是否 > 1

---

## 七、性能优化建议

### 图片压缩
```bash
# 使用ImageMagick压缩图片
convert input.jpg -quality 85 -resize 2000x output.jpg
```

### 并发控制
如果题目过多（> 10题），建议分批处理：
```typescript
// 在 startMultiQuestionProcessing 中
const batchSize = 5;
for (let i = 0; i < initialSessions.length; i += batchSize) {
  const batch = initialSessions.slice(i, i + batchSize);
  await Promise.allSettled(batch.map((s, idx) => sendMessage(...)));
}
```

---

## 八、下一步

### 探索高级功能
- 尝试"指定题目"模式
- 切换到"AI 批改作业"模式测试
- 针对特定题目进行追问

### 自定义调整
- 修改 `QuestionSelector.css` 更改按钮颜色
- 调整题目分割算法参数
- 优化prompt提示词

---

## 🎉 恭喜！

您已成功升级到V24.0！现在您的AI解题应用可以处理完整的试卷页面了！

**遇到问题？** 
- 查看完整文档：`V24.0_整页多题并行处理说明.md`
- 检查代码注释：每个关键函数都有详细说明
- 对比旧版本：`App_back.tsx` 和 `main_back.py` 保留了V23.0代码

**Happy Coding!** 🚀

