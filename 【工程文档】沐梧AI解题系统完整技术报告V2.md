# æ²æ¢§AIè§£é¢˜ç³»ç»Ÿ - å®Œæ•´æŠ€æœ¯æŠ¥å‘Š V2.0

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
3. [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
4. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
5. [åç«¯æ¶æ„](#åç«¯æ¶æ„)
6. [å‰ç«¯æ¶æ„](#å‰ç«¯æ¶æ„)
7. [æ ¸å¿ƒåŠŸèƒ½æ¨¡å—](#æ ¸å¿ƒåŠŸèƒ½æ¨¡å—)
8. [APIæ¥å£æ–‡æ¡£](#apiæ¥å£æ–‡æ¡£)
9. [éƒ¨ç½²æŒ‡å—](#éƒ¨ç½²æŒ‡å—)
10. [å¼€å‘æŒ‡å—](#å¼€å‘æŒ‡å—)
11. [ç‰ˆæœ¬å†å²](#ç‰ˆæœ¬å†å²)

---

## é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®ç®€ä»‹

**æ²æ¢§AIè§£é¢˜ç³»ç»Ÿ**æ˜¯ä¸€ä¸ªåŸºäºå¤§è¯­è¨€æ¨¡å‹çš„æ™ºèƒ½æ•™è‚²è¾…åŠ©å¹³å°ï¼Œé›†æˆäº†AIè§£é¢˜ã€ä½œä¸šæ‰¹æ”¹ã€é”™é¢˜ç®¡ç†ã€æ™ºèƒ½å‡ºé¢˜ç­‰åŠŸèƒ½ã€‚ç³»ç»Ÿé‡‡ç”¨å‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œæ”¯æŒå›¾æ–‡æ··åˆå¯¹è¯ã€LaTeXå…¬å¼æ¸²æŸ“ã€é”™é¢˜æœ¬ç®¡ç†ç­‰ç‰¹æ€§ã€‚

### 1.2 æ ¸å¿ƒç‰¹æ€§

âœ… **AIè§£é¢˜**ï¼šä¸Šä¼ é¢˜ç›®å›¾ç‰‡ï¼ŒAIè‡ªåŠ¨è¯†åˆ«å¹¶è§£ç­”
âœ… **AIæ‰¹æ”¹**ï¼šæ™ºèƒ½æ‰¹æ”¹ä½œä¸šï¼ŒæŒ‡å‡ºé”™è¯¯å¹¶ç»™å‡ºè¯¦ç»†è§£æ
âœ… **é”™é¢˜æœ¬**ï¼šè‡ªåŠ¨ä¿å­˜é”™é¢˜ï¼Œæ”¯æŒå­¦ç§‘ã€å¹´çº§ç­›é€‰
âœ… **æ™ºèƒ½å‡ºé¢˜**ï¼šåŸºäºé”™é¢˜ç”Ÿæˆé’ˆå¯¹æ€§ç»ƒä¹ é¢˜
âœ… **è¿ç»­å¯¹è¯**ï¼šæ”¯æŒå¤šè½®å¯¹è¯ï¼ŒAIè®°å¿†ä¸Šä¸‹æ–‡
âœ… **è¯•å·ç”Ÿæˆ**ï¼šæ ¹æ®çŸ¥è¯†ç‚¹å’Œéš¾åº¦ç”Ÿæˆå®Œæ•´è¯•å·
âœ… **å…¬å¼æ¸²æŸ“**ï¼šå®Œç¾æ”¯æŒLaTeXæ•°å­¦å…¬å¼æ˜¾ç¤º
âœ… **PDFå¯¼å‡º**ï¼šè¯•å·å’Œé”™é¢˜æ”¯æŒPDFæ ¼å¼å¯¼å‡º

### 1.3 æŠ€æœ¯äº®ç‚¹

- ğŸš€ **é«˜æ€§èƒ½**ï¼šæ•°æ®åº“è¿æ¥æ± ã€å¼‚æ­¥APIã€æµå¼å“åº”
- ğŸ” **å®‰å…¨è®¤è¯**ï¼šJWT tokenã€å¯†ç åŠ å¯†ã€ä¼šè¯ç®¡ç†
- ğŸ¨ **ç°ä»£UI**ï¼šReact + TypeScript + Vite
- ğŸ§  **æ™ºèƒ½AI**ï¼šé€šä¹‰åƒé—®å¤šæ¨¡æ€å¤§æ¨¡å‹
- ğŸ“Š **å®Œæ•´åŠŸèƒ½**ï¼šä»è§£é¢˜åˆ°å‡ºé¢˜çš„é—­ç¯å­¦ä¹ ç³»ç»Ÿ

---

## æŠ€æœ¯æ ˆ

### 2.1 åç«¯æŠ€æœ¯

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| **Python** | 3.13 | ä¸»å¼€å‘è¯­è¨€ |
| **FastAPI** | 0.109.0 | Webæ¡†æ¶ |
| **Uvicorn** | 0.27.0 | ASGIæœåŠ¡å™¨ |
| **PyMySQL** | 2.1.1 | MySQLæ•°æ®åº“é©±åŠ¨ |
| **Dashscope** | 1.14.1 | é˜¿é‡Œäº‘å¤§æ¨¡å‹SDK |
| **Pix2Text** | 1.1.1 | OCRæ–‡å­—è¯†åˆ« |
| **Pillow** | 10.2.0 | å›¾åƒå¤„ç† |
| **OpenCV** | 4.9.0.80 | å›¾åƒå¢å¼º |
| **python-jose** | 3.3.0 | JWTè®¤è¯ |
| **passlib** | 1.7.4 | å¯†ç åŠ å¯† |
| **ReportLab** | 4.0.7 | PDFç”Ÿæˆ |
| **Pyppeteer** | 2.0.0 | æ— å¤´æµè§ˆå™¨ï¼ˆPDFå¯¼å‡ºï¼‰ |

### 2.2 å‰ç«¯æŠ€æœ¯

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| **React** | 18.2.0 | UIæ¡†æ¶ |
| **TypeScript** | 5.2.2 | ç±»å‹å®‰å…¨ |
| **Vite** | 7.1.6 | æ„å»ºå·¥å…· |
| **Axios** | 1.7.2 | HTTPå®¢æˆ·ç«¯ |
| **Marked** | 13.0.0 | Markdownæ¸²æŸ“ |
| **MathJax** | 3.2.2 | LaTeXå…¬å¼æ¸²æŸ“ |
| **react-image-crop** | 11.0.5 | å›¾ç‰‡è£å‰ª |

### 2.3 æ•°æ®åº“

| æŠ€æœ¯ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|------|------|
| **MySQL** | 8.0 | ä¸»æ•°æ®åº“ |
| **InnoDB** | - | å­˜å‚¨å¼•æ“ |
| **utf8mb4** | - | å­—ç¬¦é›†ï¼ˆæ”¯æŒemojiå’Œç‰¹æ®Šç¬¦å·ï¼‰ |

### 2.4 AIæœåŠ¡

| æœåŠ¡ | æ¨¡å‹ | ç”¨é€” |
|------|------|------|
| **é€šä¹‰åƒé—®VL** | qwen-vl-max | å¤šæ¨¡æ€è§£é¢˜ï¼ˆå›¾æ–‡ç†è§£ï¼‰ |
| **é€šä¹‰åƒé—®** | qwen-turbo | çŸ¥è¯†ç‚¹æå–ã€ç»­ç­”ç”Ÿæˆ |

---

## ç³»ç»Ÿæ¶æ„

### 3.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·å±‚                                â”‚
â”‚                      (æµè§ˆå™¨å®¢æˆ·ç«¯)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ HTTP/HTTPS
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å‰ç«¯å±‚ (React)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ è§£é¢˜ç•Œé¢ â”‚  â”‚ é”™é¢˜æœ¬   â”‚  â”‚ å‡ºé¢˜ç³»ç»Ÿ â”‚  â”‚ ç”¨æˆ·è®¤è¯ â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚          â”‚           â”‚              â”‚             â”‚          â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                         RESTful API                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åç«¯å±‚ (FastAPI)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ è®¤è¯æ¨¡å— â”‚  â”‚ è§£é¢˜æ¨¡å— â”‚  â”‚ é”™é¢˜æ¨¡å— â”‚  â”‚ å‡ºé¢˜æ¨¡å— â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â”‚
â”‚       â”‚             â”‚               â”‚             â”‚          â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                    æ•°æ®åº“è¿æ¥æ±                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ•°æ®æŒä¹…å±‚ (MySQL)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ userè¡¨   â”‚  â”‚ subjectè¡¨â”‚  â”‚ examè¡¨   â”‚  â”‚ sessionè¡¨â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AIæœåŠ¡å±‚ (é˜¿é‡Œäº‘)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ Qwen-VL-Max  â”‚         â”‚  Qwen-turbo  â”‚                 â”‚
â”‚  â”‚(å¤šæ¨¡æ€ç†è§£)   â”‚         â”‚ (æ–‡æœ¬ç”Ÿæˆ)    â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 è¯·æ±‚æµç¨‹

#### 3.2.1 ç”¨æˆ·ç™»å½•æµç¨‹
```
ç”¨æˆ· â†’ å‰ç«¯Login â†’ POST /auth/login â†’ UserManager.login()
  â†’ éªŒè¯è´¦å·å¯†ç  â†’ ç”ŸæˆJWT Token â†’ è¿”å›Token â†’ å‰ç«¯å­˜å‚¨
```

#### 3.2.2 AIè§£é¢˜æµç¨‹
```
ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡ â†’ å‰ç«¯ â†’ POST /api/db/chat
  â†’ å›¾åƒå¢å¼º(image_enhancer) â†’ OCRè¯†åˆ«(Pix2Text)
  â†’ AIæ¨ç†(Qwen-VL-Max) â†’ æµå¼è¿”å›
  â†’ è‡ªåŠ¨ä¿å­˜é”™é¢˜(å¦‚æœæ˜¯æ‰¹æ”¹æ¨¡å¼) â†’ å‰ç«¯æ¸²æŸ“
```

#### 3.2.3 é”™é¢˜æŸ¥è¯¢æµç¨‹
```
ç”¨æˆ·æ‰“å¼€é”™é¢˜æœ¬ â†’ GET /api/v2/mistakes?subject=æ•°å­¦
  â†’ MistakeManager.get_user_mistakes()
  â†’ æŸ¥è¯¢subjectè¡¨ + user_examè¡¨
  â†’ æ ¼å¼åŒ–æ•°æ®(åŒ…å«å›¾ç‰‡ã€è§£æã€çŸ¥è¯†ç‚¹)
  â†’ è¿”å›JSON â†’ å‰ç«¯æ¸²æŸ“ â†’ MathJaxå…¬å¼æ¸²æŸ“
```

### 3.3 æ•°æ®æµå‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   ä¸Šä¼ å›¾ç‰‡    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   è¯†åˆ«æ–‡å­—    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚  å‰ç«¯   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚  åç«¯   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                                                        â”‚
                                                        â†“
                                                   å›¾åƒå¢å¼º
                                                        â”‚
                                                        â†“
                                                   OCRè¯†åˆ«
                                                        â”‚
                                                        â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   AIå¤§æ¨¡å‹æ¨ç†        â”‚
        â”‚  (Qwen-VL-Max)       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”œâ”€â†’ è¿”å›è§£ç­” â”€â”€â”€â†’ å‰ç«¯æ˜¾ç¤º
                   â”‚
                   â””â”€â†’ æ£€æµ‹é”™é¢˜ â”€â”€â”€â†’ ä¿å­˜æ•°æ®åº“
                                      â”‚
                                      â†“
                              æå–çŸ¥è¯†ç‚¹(Qwen-turbo)
                                      â”‚
                                      â†“
                              ä¿å­˜åˆ°subjectè¡¨ + user_examè¡¨
```

---

## æ•°æ®åº“è®¾è®¡

### 4.1 æ•°æ®åº“æ¶æ„

æ•°æ®åº“åç§°ï¼š`edu`  
å­—ç¬¦é›†ï¼š`utf8mb4_unicode_ci`  
å­˜å‚¨å¼•æ“ï¼š`InnoDB`

### 4.2 æ ¸å¿ƒæ•°æ®è¡¨

#### 4.2.1 userï¼ˆç”¨æˆ·è¡¨ï¼‰

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | çº¦æŸ |
|--------|------|------|------|
| user_id | VARCHAR(36) | ç”¨æˆ·ID | PRIMARY KEY |
| account | VARCHAR(100) | è´¦å· | UNIQUE, NOT NULL |
| pwd | VARCHAR(255) | å¯†ç ï¼ˆMD5åŠ å¯†ï¼‰ | NOT NULL |
| real_name | VARCHAR(100) | çœŸå®å§“å | - |
| student_id | VARCHAR(50) | å­¦å· | - |
| grade | VARCHAR(20) | å¹´çº§ | - |
| major | VARCHAR(100) | ä¸“ä¸š | - |
| created_at | DATETIME | æ³¨å†Œæ—¶é—´ | DEFAULT CURRENT_TIMESTAMP |

**ç´¢å¼•ï¼š**
- PRIMARY KEY (user_id)
- UNIQUE KEY (account)
- INDEX idx_created (created_at)

#### 4.2.2 subjectï¼ˆé¢˜ç›®è¡¨ï¼‰

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | çº¦æŸ |
|--------|------|------|------|
| subject_id | VARCHAR(64) | é¢˜ç›®ID | PRIMARY KEY |
| subject_title | LONGTEXT | é¢˜ç›®æ ‡é¢˜/é¢˜å¹² | - |
| subject_desc | LONGTEXT | é¢˜ç›®æè¿° | - |
| image_url | TEXT | é¢˜ç›®å›¾ç‰‡ï¼ˆBase64 Data URIï¼‰ | - |
| solve | LONGTEXT | è§£ç­”è¿‡ç¨‹ | - |
| answer | LONGTEXT | æ ‡å‡†ç­”æ¡ˆ | - |
| explanation | LONGTEXT | è¯¦ç»†è§£æ | - |
| knowledge_points | TEXT | çŸ¥è¯†ç‚¹ï¼ˆJSONæ•°ç»„ï¼‰ | - |
| subject_type | VARCHAR(50) | é¢˜ç›®ç±»å‹ | DEFAULT 'practice' |
| subject_name | VARCHAR(50) | å­¦ç§‘åç§° | DEFAULT 'æœªåˆ†ç±»' |
| grade | VARCHAR(20) | å¹´çº§ | DEFAULT 'æœªåˆ†ç±»' |
| difficulty | VARCHAR(20) | éš¾åº¦ | DEFAULT 'ä¸­ç­‰' |
| user_mistake_text | TEXT | ç”¨æˆ·é”™è¯¯ç­”æ¡ˆ | - |
| mistake_analysis | TEXT | é”™é¢˜åˆ†æ | - |
| review_count | INT | å¤ä¹ æ¬¡æ•° | DEFAULT 0 |
| last_review_at | DATETIME | æœ€åå¤ä¹ æ—¶é—´ | - |
| created_at | DATETIME | åˆ›å»ºæ—¶é—´ | DEFAULT CURRENT_TIMESTAMP |
| updated_at | DATETIME | æ›´æ–°æ—¶é—´ | ON UPDATE CURRENT_TIMESTAMP |

**é¢˜ç›®ç±»å‹ï¼ˆsubject_typeï¼‰ï¼š**
- `mistake`: é”™é¢˜
- `generated`: AIç”Ÿæˆçš„ç»ƒä¹ é¢˜
- `practice`: æ™®é€šç»ƒä¹ é¢˜

**ç´¢å¼•ï¼š**
- PRIMARY KEY (subject_id)
- INDEX idx_type (subject_type)
- INDEX idx_subject (subject_name)
- INDEX idx_grade (grade)
- INDEX idx_created (created_at)

#### 4.2.3 examï¼ˆè¯•å·è¡¨ï¼‰

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | çº¦æŸ |
|--------|------|------|------|
| exam_id | VARCHAR(64) | è¯•å·ID | PRIMARY KEY |
| exam_title | VARCHAR(200) | è¯•å·æ ‡é¢˜ | NOT NULL |
| exam_desc | TEXT | è¯•å·æè¿° | - |
| subject | VARCHAR(50) | å­¦ç§‘ | DEFAULT 'ç»¼åˆ' |
| grade | VARCHAR(20) | å¹´çº§ | DEFAULT 'æœªåˆ†ç±»' |
| exam_type | VARCHAR(50) | è¯•å·ç±»å‹ | DEFAULT 'custom' |
| total_score | DECIMAL(5,2) | æ€»åˆ† | DEFAULT 100.00 |
| duration_minutes | INT | è€ƒè¯•æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰ | DEFAULT 90 |
| created_at | DATETIME | åˆ›å»ºæ—¶é—´ | DEFAULT CURRENT_TIMESTAMP |

**è¯•å·ç±»å‹ï¼ˆexam_typeï¼‰ï¼š**
- `mistake`: é”™é¢˜æœ¬
- `practice_set`: ç»ƒä¹ é¢˜é›†
- `test_paper`: æµ‹è¯•å·
- `custom`: è‡ªå®šä¹‰è¯•å·

**ç´¢å¼•ï¼š**
- PRIMARY KEY (exam_id)
- INDEX idx_type (exam_type)
- INDEX idx_created (created_at)

#### 4.2.4 user_examï¼ˆç”¨æˆ·ç­”é¢˜è®°å½•è¡¨ï¼‰

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | çº¦æŸ |
|--------|------|------|------|
| id | INT | è‡ªå¢ID | PRIMARY KEY AUTO_INCREMENT |
| user_info | VARCHAR(36) | ç”¨æˆ·ID | NOT NULL |
| exam_id | VARCHAR(64) | è¯•å·ID | NOT NULL |
| subject_id | VARCHAR(64) | é¢˜ç›®ID | NOT NULL |
| user_answer | TEXT | ç”¨æˆ·ç­”æ¡ˆ | - |
| status | VARCHAR(20) | ç­”é¢˜çŠ¶æ€ | DEFAULT 'unanswered' |
| answered_at | DATETIME | ç­”é¢˜æ—¶é—´ | DEFAULT CURRENT_TIMESTAMP |

**ç­”é¢˜çŠ¶æ€ï¼ˆstatusï¼‰ï¼š**
- `correct`: æ­£ç¡®
- `incorrect`: é”™è¯¯
- `unanswered`: æœªç­”

**ç´¢å¼•ï¼š**
- PRIMARY KEY (id)
- INDEX idx_user (user_info)
- INDEX idx_exam (exam_id)
- INDEX idx_subject (subject_id)
- FOREIGN KEY (user_info) REFERENCES user(user_id)

#### 4.2.5 chat_sessionï¼ˆå¯¹è¯ä¼šè¯è¡¨ï¼‰

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | çº¦æŸ |
|--------|------|------|------|
| session_id | VARCHAR(36) | ä¼šè¯ID | PRIMARY KEY |
| user_id | VARCHAR(36) | ç”¨æˆ·ID | NOT NULL |
| title | VARCHAR(255) | ä¼šè¯æ ‡é¢˜ | DEFAULT 'æ–°å¯¹è¯' |
| mode | VARCHAR(50) | å¯¹è¯æ¨¡å¼ | DEFAULT 'solve' |
| subject | VARCHAR(50) | å­¦ç§‘ | DEFAULT 'æœªåˆ†ç±»' |
| grade | VARCHAR(20) | å¹´çº§ | DEFAULT 'æœªåˆ†ç±»' |
| created_at | DATETIME | åˆ›å»ºæ—¶é—´ | DEFAULT CURRENT_TIMESTAMP |
| updated_at | DATETIME | æ›´æ–°æ—¶é—´ | ON UPDATE CURRENT_TIMESTAMP |
| is_deleted | TINYINT(1) | æ˜¯å¦åˆ é™¤ | DEFAULT 0 |

**å¯¹è¯æ¨¡å¼ï¼ˆmodeï¼‰ï¼š**
- `solve`: è§£é¢˜æ¨¡å¼
- `review`: æ‰¹æ”¹æ¨¡å¼
- `ask`: æé—®æ¨¡å¼

**ç´¢å¼•ï¼š**
- PRIMARY KEY (session_id)
- INDEX idx_user (user_id)
- INDEX idx_created (created_at)
- FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE CASCADE

#### 4.2.6 chat_historyï¼ˆå¯¹è¯å†å²è¡¨ï¼‰

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | çº¦æŸ |
|--------|------|------|------|
| id | BIGINT | è‡ªå¢ID | PRIMARY KEY AUTO_INCREMENT |
| session_id | VARCHAR(36) | ä¼šè¯ID | NOT NULL |
| role | VARCHAR(20) | è§’è‰² | NOT NULL |
| content | TEXT | æ¶ˆæ¯å†…å®¹ | NOT NULL |
| image_url | TEXT | å›¾ç‰‡URL | - |
| image_base64 | MEDIUMTEXT | å›¾ç‰‡Base64 | - |
| message_type | VARCHAR(20) | æ¶ˆæ¯ç±»å‹ | DEFAULT 'text' |
| created_at | DATETIME | åˆ›å»ºæ—¶é—´ | DEFAULT CURRENT_TIMESTAMP |

**è§’è‰²ï¼ˆroleï¼‰ï¼š**
- `user`: ç”¨æˆ·
- `assistant`: AIåŠ©æ‰‹

**æ¶ˆæ¯ç±»å‹ï¼ˆmessage_typeï¼‰ï¼š**
- `text`: çº¯æ–‡æœ¬
- `image`: çº¯å›¾ç‰‡
- `mixed`: å›¾æ–‡æ··åˆ

**ç´¢å¼•ï¼š**
- PRIMARY KEY (id)
- INDEX idx_session (session_id)
- INDEX idx_role (role)
- INDEX idx_created (created_at)
- FOREIGN KEY (session_id) REFERENCES chat_session(session_id) ON DELETE CASCADE

### 4.3 ERå…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   user   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚ 1
     â”‚
     â”‚ N
â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  chat_session â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 1
     â”‚
     â”‚ N
â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ chat_history  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       N       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       N       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   user   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚user_exam â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚  subject â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  åšé¢˜è®°å½•      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   åŒ…å«é¢˜ç›®      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚ N
                                â”‚
                                â”‚ 1
                           â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
                           â”‚   exam   â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.4 æ•°æ®åº“å‡çº§å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å‡çº§å†…å®¹ |
|------|------|----------|
| V25.0 | 2025-10 | åˆå§‹MySQLæ•°æ®åº“æ¶æ„ |
| V25.1 | 2025-10 | æ·»åŠ çŸ¥è¯†ç‚¹ã€éš¾åº¦ã€å­¦ç§‘å­—æ®µ |
| V25.2 | 2025-10 | æ·»åŠ å¯¹è¯ä¼šè¯è¡¨ã€é”™é¢˜å¢å¼ºå­—æ®µ |

å‡çº§è„šæœ¬ä½ç½®ï¼š
- `backend/database_schema_upgrade.sql`ï¼ˆV25.1å‡çº§ï¼‰
- `backend/database_schema_v25.2.sql`ï¼ˆV25.2å‡çº§ï¼‰

---

## åç«¯æ¶æ„

### 5.1 é¡¹ç›®ç»“æ„

```
backend/
â”œâ”€â”€ main_db.py                    # ä¸»å…¥å£æ–‡ä»¶
â”œâ”€â”€ database.py                   # æ•°æ®åº“è¿æ¥å’Œç®¡ç†
â”œâ”€â”€ auth_api.py                   # è®¤è¯API
â”œâ”€â”€ image_enhancer.py             # å›¾åƒå¢å¼ºæ¨¡å—
â”œâ”€â”€ models.py                     # æ•°æ®æ¨¡å‹ï¼ˆSQLAlchemyï¼‰
â”œâ”€â”€ database_schema_v25.2.sql     # æ•°æ®åº“ç»“æ„
â”œâ”€â”€ requirements.txt              # Pythonä¾èµ–
â”œâ”€â”€ venv/                         # è™šæ‹Ÿç¯å¢ƒ
â””â”€â”€ generated_papers/             # ç”Ÿæˆçš„è¯•å·æ–‡ä»¶
```

### 5.2 æ ¸å¿ƒæ¨¡å—è¯¦è§£

#### 5.2.1 æ•°æ®åº“è¿æ¥æ± ï¼ˆdatabase.pyï¼‰

**DatabasePoolç±»**
```python
class DatabasePool:
    """
    æ•°æ®åº“è¿æ¥æ± ç®¡ç†
    - é¢„åˆ›å»º5ä¸ªè¿æ¥
    - è‡ªåŠ¨å¥åº·æ£€æŸ¥ï¼ˆconn.pingï¼‰
    - è¿æ¥å¤±æ•ˆè‡ªåŠ¨é‡å»º
    """
    
    def get_connection(self):
        # ä»æ± ä¸­è·å–å¥åº·è¿æ¥
        # å¦‚æœè¿æ¥å¤±æ•ˆï¼Œè‡ªåŠ¨åˆ›å»ºæ–°è¿æ¥
        
    def return_connection(self, conn):
        # å½’è¿˜è¿æ¥å‰æ£€æŸ¥å¥åº·çŠ¶æ€
```

**ç®¡ç†ç±»**
- `UserManager`: ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€ä¿¡æ¯æŸ¥è¯¢
- `SubjectManager`: é¢˜ç›®å¢åˆ æ”¹æŸ¥
- `ExamManager`: è¯•å·ç®¡ç†
- `ChatManager`: å¯¹è¯ä¼šè¯ç®¡ç†ï¼ˆV25.2æ–°å¢ï¼‰
- `MistakeManager`: é”™é¢˜æœ¬ç®¡ç†ï¼ˆV25.2å¢å¼ºï¼‰

#### 5.2.2 å›¾åƒå¢å¼ºï¼ˆimage_enhancer.pyï¼‰

**ImageEnhancerç±»**
```python
def enhance_for_ocr(image_path: str) -> str:
    """
    AIè§£é¢˜å‰çš„å›¾åƒé¢„å¤„ç†
    1. ç°åº¦åŒ–
    2. é”åŒ–ï¼ˆå¢å¼ºæ–‡å­—è¾¹ç¼˜ï¼‰
    3. CLAHEå¯¹æ¯”åº¦å¢å¼º
    4. é™å™ª
    5. äºŒå€¼åŒ–
    è¿”å›ï¼šå¢å¼ºåçš„Base64å›¾åƒ
    """
```

**æŠ€æœ¯ç»†èŠ‚ï¼š**
- ä½¿ç”¨OpenCVå’ŒPillow
- è‡ªé€‚åº”é˜ˆå€¼äºŒå€¼åŒ–
- å½¢æ€å­¦æ“ä½œå»é™¤å™ªç‚¹
- æå‡OCRè¯†åˆ«å‡†ç¡®ç‡30%+

#### 5.2.3 è®¤è¯æ¨¡å—ï¼ˆauth_api.pyï¼‰

**JWT Tokenç”Ÿæˆ**
```python
def create_access_token(data: dict, expires_delta: timedelta = None):
    """
    ç”ŸæˆJWT Token
    - é»˜è®¤7å¤©è¿‡æœŸ
    - HS256ç®—æ³•
    - åŒ…å«user_idã€accountç­‰ä¿¡æ¯
    """
```

**è®¤è¯è£…é¥°å™¨**
```python
@app.post("/protected-api")
async def protected_route(user: dict = Depends(get_current_user)):
    # userå‚æ•°è‡ªåŠ¨æ³¨å…¥å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
    # å¦‚æœTokenæ— æ•ˆï¼Œè‡ªåŠ¨è¿”å›401
```

#### 5.2.4 AIé›†æˆ

**å¤šæ¨¡æ€è§£é¢˜ï¼ˆQwen-VL-Maxï¼‰**
```python
response = dashscope.MultiModalConversation.call(
    model='qwen-vl-max',
    messages=[
        {
            "role": "user",
            "content": [
                {"image": f"data:image/jpeg;base64,{image_base64}"},
                {"text": prompt}
            ]
        }
    ],
    stream=True  # æµå¼è¿”å›
)
```

**çŸ¥è¯†ç‚¹æå–ï¼ˆQwen-turboï¼‰**
```python
extract_response = dashscope.Generation.call(
    model='qwen-turbo',
    prompt=f"è¯·ä»ä»¥ä¸‹æ‰¹æ”¹ç»“æœä¸­æå–æ¶‰åŠçš„çŸ¥è¯†ç‚¹ï¼š\n\n{ai_response}"
)
```

### 5.3 APIè·¯ç”±è®¾è®¡

#### 5.3.1 è®¤è¯ç›¸å…³
```
POST   /auth/register          # ç”¨æˆ·æ³¨å†Œ
POST   /auth/login             # ç”¨æˆ·ç™»å½•
GET    /auth/user/info         # è·å–ç”¨æˆ·ä¿¡æ¯
PUT    /auth/user/update       # æ›´æ–°ç”¨æˆ·ä¿¡æ¯
```

#### 5.3.2 AIè§£é¢˜
```
POST   /api/db/chat            # AIå¯¹è¯ï¼ˆè§£é¢˜/æ‰¹æ”¹ï¼‰
GET    /api/db/sessions        # è·å–å¯¹è¯ä¼šè¯åˆ—è¡¨
DELETE /api/db/sessions/:id    # åˆ é™¤å¯¹è¯ä¼šè¯
```

#### 5.3.3 é”™é¢˜æœ¬ï¼ˆV25.2ï¼‰
```
GET    /api/v2/mistakes                    # è·å–é”™é¢˜åˆ—è¡¨ï¼ˆæ”¯æŒç­›é€‰ï¼‰
POST   /api/v2/mistakes/save               # æ‰‹åŠ¨ä¿å­˜é”™é¢˜
GET    /api/v2/mistakes/stats              # é”™é¢˜ç»Ÿè®¡
POST   /api/v2/mistakes/:id/review         # æ ‡è®°ä¸ºå·²å¤ä¹ 
DELETE /mistakes/:id                       # åˆ é™¤é”™é¢˜
```

#### 5.3.4 è¯•å·ç”Ÿæˆï¼ˆV25.2ï¼‰
```
POST   /api/v2/papers/generate    # ç”Ÿæˆè¯•å·ï¼ˆæ”¯æŒå­¦ç§‘å’Œå¹´çº§é€‰æ‹©ï¼‰
GET    /questions/                # è·å–ç”Ÿæˆçš„é¢˜ç›®åˆ—è¡¨
POST   /api/papers/export         # å¯¼å‡ºè¯•å·ä¸ºPDF
```

### 5.4 æ€§èƒ½ä¼˜åŒ–

**1. æ•°æ®åº“è¿æ¥æ± **
- é¢„åˆ›å»º5ä¸ªè¿æ¥
- é¿å…é¢‘ç¹åˆ›å»º/é”€æ¯è¿æ¥
- è‡ªåŠ¨å¥åº·æ£€æŸ¥å’Œé‡è¿

**2. å¼‚æ­¥API**
```python
@app.post("/api/db/chat")
async def db_chat(request: ChatRequest):
    # FastAPIçš„asyncè‡ªåŠ¨æ”¯æŒå¼‚æ­¥I/O
    # ä¸ä¼šé˜»å¡å…¶ä»–è¯·æ±‚
```

**3. æµå¼å“åº”**
```python
async def generate():
    for chunk in ai_response:
        yield f"data: {json.dumps(chunk)}\n\n"

return StreamingResponse(generate(), media_type="text/event-stream")
```

**4. å›¾åƒå‹ç¼©**
- ä¸Šä¼ å‰å‰ç«¯è‡ªåŠ¨å‹ç¼©å›¾ç‰‡
- é™åˆ¶æœ€å¤§å°ºå¯¸1920x1920
- Base64ä¼ è¾“å‰JPEGå‹ç¼©

---

## å‰ç«¯æ¶æ„

### 6.1 é¡¹ç›®ç»“æ„

```
frontend/vite-project/src/
â”œâ”€â”€ main.tsx                      # å…¥å£æ–‡ä»¶
â”œâ”€â”€ AppDB.tsx                     # ä¸»åº”ç”¨ï¼ˆæ•°æ®åº“ç‰ˆï¼‰
â”œâ”€â”€ SimpleMistakeBookDB.tsx       # é”™é¢˜æœ¬ç»„ä»¶
â”œâ”€â”€ LoginPage.tsx                 # ç™»å½•é¡µé¢
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ AuthModal.tsx             # è®¤è¯å¼¹çª—
â”‚   â”œâ”€â”€ TextItem.tsx              # æ–‡æœ¬æ¸²æŸ“ç»„ä»¶
â”‚   â””â”€â”€ QuestionItem.tsx          # é¢˜ç›®å¡ç‰‡ç»„ä»¶
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ api.ts                    # APIå°è£…
â”‚   â””â”€â”€ mathjaxHelper.ts          # MathJaxå·¥å…·
â”œâ”€â”€ assets/                       # é™æ€èµ„æº
â””â”€â”€ *.css                         # æ ·å¼æ–‡ä»¶
```

### 6.2 æ ¸å¿ƒç»„ä»¶

#### 6.2.1 AppDB.tsxï¼ˆä¸»åº”ç”¨ï¼‰

**åŠŸèƒ½ï¼š**
- AIè§£é¢˜å’Œæ‰¹æ”¹ç•Œé¢
- æ¨¡å¼åˆ‡æ¢ï¼ˆè§£é¢˜/æ‰¹æ”¹ï¼‰
- å›¾ç‰‡ä¸Šä¼ å’Œè£å‰ª
- æµå¼å¯¹è¯æ˜¾ç¤º
- å¿«æ·æé—®æŒ‰é’®
- ä¼šè¯å†å²ç®¡ç†

**å…³é”®ä»£ç ï¼š**
```tsx
const sendMessage = async () => {
  const formData = new FormData();
  formData.append('mode', mode);
  formData.append('prompt', inputText);
  if (imageFile) {
    formData.append('image', imageFile);
  }
  
  const response = await fetch('/api/db/chat', {
    method: 'POST',
    body: formData,
    headers: { 'Authorization': `Bearer ${token}` }
  });
  
  // æµå¼è¯»å–AIå“åº”
  const reader = response.body.getReader();
  const decoder = new TextDecoder();
  
  while (true) {
    const {done, value} = await reader.read();
    if (done) break;
    const chunk = decoder.decode(value);
    // æ›´æ–°æ¶ˆæ¯æ˜¾ç¤º
  }
};
```

#### 6.2.2 SimpleMistakeBookDB.tsxï¼ˆé”™é¢˜æœ¬ï¼‰

**åŠŸèƒ½ï¼š**
- é”™é¢˜åˆ—è¡¨å±•ç¤º
- å­¦ç§‘å’Œå¹´çº§ç­›é€‰
- çŸ¥è¯†ç‚¹æ ‡ç­¾æ˜¾ç¤º
- å›¾ç‰‡ã€é¢˜ç›®ã€è§£ææ¸²æŸ“
- MathJaxå…¬å¼æ¸²æŸ“
- ç”Ÿæˆçš„é¢˜ç›®ç®¡ç†
- è¯•å·ç”Ÿæˆé…ç½®

**å…³é”®ç‰¹æ€§ï¼š**
```tsx
// V25.2 æ–°å¢ï¼šå­¦ç§‘å’Œå¹´çº§ç­›é€‰
const [filterSubject, setFilterSubject] = useState('');
const [filterGrade, setFilterGrade] = useState('');

// åŠ è½½æ•°æ®æ—¶ä¼ é€’ç­›é€‰å‚æ•°
const loadData = async () => {
  const params = new URLSearchParams();
  if (filterSubject) params.append('subject_name', filterSubject);
  if (filterGrade) params.append('grade', filterGrade);
  
  const response = await authenticatedFetch(
    `/api/v2/mistakes?${params.toString()}`
  );
  const data = await response.json();
  setMistakes(data.mistakes || []);
};

// MathJaxå…¬å¼æ¸²æŸ“
useEffect(() => {
  setTimeout(() => {
    const elements = document.querySelectorAll('.math-content');
    if (window.MathJax?.typesetPromise) {
      window.MathJax.typesetPromise(Array.from(elements));
    }
  }, 200);
}, [mistakes]);
```

#### 6.2.3 api.tsï¼ˆAPIå·¥å…·ï¼‰

**ç»Ÿä¸€APIå°è£…ï¼š**
```typescript
export const authenticatedFetch = async (url: string, options?: RequestInit) => {
  const token = localStorage.getItem('auth_token');
  
  const response = await fetch(`http://localhost:8000${url}`, {
    ...options,
    headers: {
      ...options?.headers,
      'Authorization': token ? `Bearer ${token}` : ''
    }
  });
  
  // 401è‡ªåŠ¨è·³è½¬ç™»å½•
  if (response.status === 401) {
    localStorage.removeItem('auth_token');
    window.location.href = '/';
  }
  
  return response;
};

// V25.2 API
export const mistakesApiV2 = {
  getAll: (filters) => authenticatedFetch(`/api/v2/mistakes?${buildQuery(filters)}`),
  save: (data) => authenticatedFetch('/api/v2/mistakes/save', {
    method: 'POST',
    body: JSON.stringify(data)
  }),
  getStats: () => authenticatedFetch('/api/v2/mistakes/stats'),
  markReviewed: (id) => authenticatedFetch(`/api/v2/mistakes/${id}/review`, {
    method: 'POST'
  })
};
```

### 6.3 çŠ¶æ€ç®¡ç†

ä½¿ç”¨React Hooksè¿›è¡ŒçŠ¶æ€ç®¡ç†ï¼š

```tsx
// AppDB.tsx ä¸»è¦çŠ¶æ€
const [mode, setMode] = useState('solve');           // è§£é¢˜/æ‰¹æ”¹æ¨¡å¼
const [messages, setMessages] = useState([]);        // å¯¹è¯æ¶ˆæ¯åˆ—è¡¨
const [inputText, setInputText] = useState('');      // ç”¨æˆ·è¾“å…¥
const [imageFile, setImageFile] = useState(null);    // ä¸Šä¼ çš„å›¾ç‰‡
const [loading, setLoading] = useState(false);       // åŠ è½½çŠ¶æ€
const [sessions, setSessions] = useState([]);        // ä¼šè¯åˆ—è¡¨

// SimpleMistakeBookDB.tsx ä¸»è¦çŠ¶æ€
const [mistakes, setMistakes] = useState([]);        // é”™é¢˜åˆ—è¡¨
const [questions, setQuestions] = useState([]);      // ç”Ÿæˆçš„é¢˜ç›®
const [filterSubject, setFilterSubject] = useState(''); // å­¦ç§‘ç­›é€‰
const [filterGrade, setFilterGrade] = useState('');  // å¹´çº§ç­›é€‰
const [selectedMistakes, setSelectedMistakes] = useState(new Set()); // é€‰ä¸­çš„é”™é¢˜
```

### 6.4 æ ·å¼è®¾è®¡

**è®¾è®¡é£æ ¼ï¼š**
- ç°ä»£ç®€æ´çš„å¡ç‰‡å¼å¸ƒå±€
- æ¸å˜è‰²èƒŒæ™¯
- åœ†è§’é˜´å½±æ•ˆæœ
- å“åº”å¼è®¾è®¡
- æ‚¬åœåŠ¨ç”»æ•ˆæœ

**å…³é”®CSSæŠ€æœ¯ï¼š**
```css
/* æ¸å˜èƒŒæ™¯ */
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

/* æ¯›ç»ç’ƒæ•ˆæœ */
background: rgba(255, 255, 255, 0.95);
backdrop-filter: blur(10px);

/* å¹³æ»‘è¿‡æ¸¡ */
transition: all 0.3s ease;

/* é˜´å½±æ•ˆæœ */
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);

/* å“åº”å¼å¸ƒå±€ */
@media (max-width: 768px) {
  flex-direction: column;
}
```

### 6.5 å…¬å¼æ¸²æŸ“

**MathJaxé…ç½®ï¼š**
```html
<!-- index.html -->
<script>
window.MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],
    displayMath: [['$$', '$$'], ['\\[', '\\]']]
  },
  options: {
    skipHtmlTags: ['script', 'noscript', 'style', 'textarea'],
    processHtmlClass: 'math-content'
  }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
```

**æ¸²æŸ“è§¦å‘ï¼š**
```tsx
useEffect(() => {
  if (messages.length > 0) {
    setTimeout(() => {
      const elements = document.querySelectorAll('.message-content');
      if (window.MathJax?.typesetPromise) {
        window.MathJax.typesetPromise(Array.from(elements))
          .then(() => console.log('âœ… å…¬å¼æ¸²æŸ“å®Œæˆ'))
          .catch(err => console.error('âŒ æ¸²æŸ“é”™è¯¯:', err));
      }
    }, 100);
  }
}, [messages]);
```

---

## æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

### 7.1 AIè§£é¢˜æ¨¡å—

**æµç¨‹å›¾ï¼š**
```
ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡ 
  â†“
å‰ç«¯å‹ç¼©å›¾ç‰‡ï¼ˆæœ€å¤§1920x1920ï¼‰
  â†“
å‘é€åˆ°åç«¯ POST /api/db/chat
  â†“
[åç«¯] å›¾åƒå¢å¼ºï¼ˆImageEnhancerï¼‰
  â†“
[åç«¯] OCRè¯†åˆ«ï¼ˆPix2Textï¼‰
  â†“
[åç«¯] æ„å»ºPrompt + å›¾ç‰‡
  â†“
[AI] Qwen-VL-Maxæ¨ç†
  â†“
[åç«¯] æµå¼è¿”å›ç»“æœ
  â†“
å‰ç«¯é€å­—æ˜¾ç¤º + MathJaxæ¸²æŸ“
```

**æŠ€æœ¯è¦ç‚¹ï¼š**
1. **å›¾åƒå¢å¼º**ï¼šæå‡OCRå‡†ç¡®ç‡
2. **æµå¼å“åº”**ï¼šè¾¹ç”Ÿæˆè¾¹æ˜¾ç¤ºï¼Œç”¨æˆ·ä½“éªŒå¥½
3. **å…¬å¼æ¸²æŸ“**ï¼šè‡ªåŠ¨è¯†åˆ«LaTeXå¹¶æ¸²æŸ“
4. **è¿ç»­å¯¹è¯**ï¼šæ”¯æŒå¤šè½®è¿½é—®ï¼ŒAIè®°å¿†ä¸Šä¸‹æ–‡

### 7.2 AIæ‰¹æ”¹æ¨¡å—

**æ‰¹æ”¹æµç¨‹ï¼š**
```
ç”¨æˆ·ä¸Šä¼ ä½œä¸šå›¾ç‰‡
  â†“
AIè¯†åˆ«é¢˜ç›®å’Œç­”æ¡ˆ
  â†“
å¯¹æ¯”æ ‡å‡†ç­”æ¡ˆ
  â†“
ç”Ÿæˆæ‰¹æ”¹æ„è§ï¼ˆæŒ‡å‡ºé”™è¯¯ã€ç»™å‡ºæ­£ç¡®è§£æ³•ï¼‰
  â†“
è‡ªåŠ¨æ£€æµ‹æ˜¯å¦æœ‰é”™è¯¯
  â†“
å¦‚æœæœ‰é”™è¯¯ â†’ æå–çŸ¥è¯†ç‚¹ â†’ ä¿å­˜åˆ°é”™é¢˜æœ¬
```

**é”™é¢˜è‡ªåŠ¨ä¿å­˜é€»è¾‘ï¼š**
```python
# æ£€æµ‹AIå“åº”ä¸­æ˜¯å¦åŒ…å«é”™è¯¯å…³é”®è¯
is_mistake = any(keyword in ai_response for keyword in [
    'é”™è¯¯', 'ä¸æ­£ç¡®', 'ä¸å¯¹', 'æœ‰è¯¯', 'ç­”æ¡ˆé”™äº†', 
    'åšé”™äº†', 'æœ‰é—®é¢˜', 'é”™äº†'
])

if is_mistake and current_image:
    # 1. æå–çŸ¥è¯†ç‚¹
    knowledge_points = extract_knowledge_points(ai_response)
    
    # 2. ä¿å­˜åˆ°subjectè¡¨
    subject_id = save_to_subject_table(
        title=f"æ‰¹æ”¹äº {datetime.now()}",
        desc=user_prompt,
        image_url=f"data:image/jpeg;base64,{current_image}",
        solve=ai_response,
        explanation=ai_response,
        knowledge_points=knowledge_points
    )
    
    # 3. å…³è”åˆ°user_examè¡¨ï¼ˆé”™é¢˜æœ¬ï¼‰
    link_to_mistake_book(user_id, subject_id)
    
    print("âœ… é”™é¢˜å·²è‡ªåŠ¨ä¿å­˜åˆ°é”™é¢˜æœ¬")
```

### 7.3 é”™é¢˜æœ¬æ¨¡å—

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- âœ… é”™é¢˜åˆ—è¡¨å±•ç¤ºï¼ˆå›¾ç‰‡+é¢˜ç›®+è§£æï¼‰
- âœ… å­¦ç§‘ç­›é€‰ï¼ˆæ•°å­¦ã€ç‰©ç†ã€åŒ–å­¦ç­‰ï¼‰
- âœ… å¹´çº§ç­›é€‰ï¼ˆåˆä¸€åˆ°é«˜ä¸‰ï¼‰
- âœ… çŸ¥è¯†ç‚¹æ ‡ç­¾
- âœ… å¤ä¹ æ¬¡æ•°ç»Ÿè®¡
- âœ… æ‰¹é‡åˆ é™¤
- âœ… MathJaxå…¬å¼æ¸²æŸ“

**æ•°æ®ç»“æ„ï¼š**
```typescript
interface Mistake {
  id: string;
  image_base64: string;           // é¢˜ç›®å›¾ç‰‡
  question_text: string;          // é¢˜ç›®æè¿°
  wrong_answer: string;           // ç”¨æˆ·é”™è¯¯ç­”æ¡ˆ
  ai_analysis: string;            // AIæ‰¹æ”¹åˆ†æ
  subject: string;                // å­¦ç§‘
  grade: string;                  // å¹´çº§
  knowledge_points: string[];     // çŸ¥è¯†ç‚¹æ ‡ç­¾
  created_at: string;             // åˆ›å»ºæ—¶é—´
  reviewed_count: number;         // å¤ä¹ æ¬¡æ•°
}
```

**ç­›é€‰å®ç°ï¼š**
```tsx
// å­¦ç§‘ç­›é€‰ä¸‹æ‹‰æ¡†
<select onChange={(e) => setFilterSubject(e.target.value)}>
  <option value="">å…¨éƒ¨å­¦ç§‘</option>
  <option value="æ•°å­¦">æ•°å­¦</option>
  <option value="ç‰©ç†">ç‰©ç†</option>
  <option value="åŒ–å­¦">åŒ–å­¦</option>
  {/* ... */}
</select>

// åç«¯æŸ¥è¯¢
SELECT s.*, ue.user_answer
FROM subject s
JOIN user_exam ue ON s.subject_id = ue.subject_id
WHERE ue.user_info = %s 
  AND s.subject_type = 'mistake'
  AND s.subject_name = %s  -- å­¦ç§‘ç­›é€‰
  AND s.grade = %s         -- å¹´çº§ç­›é€‰
ORDER BY s.created_at DESC
```

### 7.4 æ™ºèƒ½å‡ºé¢˜æ¨¡å—

**å‡ºé¢˜ç­–ç•¥ï¼š**
1. **åŸºäºé”™é¢˜**ï¼šåˆ†æç”¨æˆ·çš„è–„å¼±çŸ¥è¯†ç‚¹
2. **ç½‘ç»œè¾…åŠ©**ï¼šçˆ¬å–èä¼˜ç½‘ã€ç»„å·ç½‘çš„çœŸé¢˜
3. **AIç”Ÿæˆ**ï¼šQwen-turboç”Ÿæˆé’ˆå¯¹æ€§ç»ƒä¹ é¢˜

**å‡ºé¢˜æµç¨‹ï¼š**
```
ç”¨æˆ·é€‰æ‹©é”™é¢˜ + é…ç½®ï¼ˆé¢˜å‹ã€éš¾åº¦ã€æ•°é‡ï¼‰
  â†“
åç«¯åˆ†æé”™é¢˜çš„çŸ¥è¯†ç‚¹å’Œéš¾åº¦
  â†“
ç½‘ç»œçˆ¬å–ç›¸å…³çœŸé¢˜ï¼ˆå¯é€‰ï¼‰
  â†“
æ„å»ºPromptï¼ˆåŒ…å«é”™é¢˜ç‰¹å¾ + ç½‘ç»œçœŸé¢˜ï¼‰
  â†“
AIç”Ÿæˆç»ƒä¹ é¢˜
  â†“
è§£æMarkdownæ ¼å¼é¢˜ç›®
  â†“
ä¿å­˜åˆ°æ•°æ®åº“
  â†“
è¿”å›å‰ç«¯å±•ç¤º
```

**Promptå·¥ç¨‹ï¼š**
```python
prompt = f"""
ä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œçš„æ•°å­¦è€å¸ˆã€‚

ã€å­¦ç”Ÿé”™é¢˜åˆ†æã€‘
å­¦ç”Ÿåœ¨ä»¥ä¸‹çŸ¥è¯†ç‚¹å‡ºç°é”™è¯¯ï¼š
{knowledge_points_str}

é”™é¢˜ç¤ºä¾‹ï¼š
{mistake_examples}

ã€ç½‘ç»œæœé›†çš„çœŸå®é¢˜ç›®å‚è€ƒã€‘
{web_reference_text}

ã€é¢˜ç›®è¦æ±‚ã€‘
1. é’ˆå¯¹å­¦ç”Ÿçš„è–„å¼±ç¯èŠ‚ï¼Œè®¾è®¡æœ‰é’ˆå¯¹æ€§çš„ç»ƒä¹ é¢˜
2. éš¾åº¦ï¼š{difficulty}
3. é¢˜å‹ï¼š{question_types}
4. é¢˜ç›®æ•°é‡ï¼š{count}é“
5. æ¯é“é¢˜åŒ…å«ï¼šé¢˜å¹²ã€ç­”æ¡ˆã€è¯¦ç»†è§£æ

è¯·æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

## é¢˜ç›®1
[é¢˜å¹²]

**ç­”æ¡ˆï¼š**
[æ ‡å‡†ç­”æ¡ˆ]

**è§£æï¼š**
[è¯¦ç»†æ­¥éª¤]

---
"""
```

### 7.5 è¯•å·ç”Ÿæˆæ¨¡å—ï¼ˆV25.2ï¼‰

**æ–°å¢åŠŸèƒ½ï¼š**
- âœ… è‡ªä¸»é€‰æ‹©å­¦ç§‘ï¼ˆæ•°å­¦ã€ç‰©ç†ã€åŒ–å­¦ç­‰ï¼‰
- âœ… è‡ªä¸»é€‰æ‹©å¹´çº§ï¼ˆåˆä¸€åˆ°é«˜ä¸‰ï¼‰
- âœ… é…ç½®é¢˜å‹ã€éš¾åº¦ã€åˆ†å€¼
- âœ… è‡ªåŠ¨æ’ç‰ˆç”ŸæˆPDF

**è¯•å·é…ç½®ï¼š**
```tsx
interface PaperConfig {
  subject: string;          // å­¦ç§‘
  grade: string;            // å¹´çº§
  paper_title: string;      // è¯•å·æ ‡é¢˜
  question_types: string[]; // é¢˜å‹åˆ—è¡¨
  difficulty: string;       // éš¾åº¦
  total_score: number;      // æ€»åˆ†
  duration_minutes: number; // æ—¶é•¿
}
```

**ç”ŸæˆAPIï¼š**
```
POST /api/v2/papers/generate
Content-Type: application/json

{
  "subject": "æ•°å­¦",
  "grade": "é«˜äºŒ",
  "paper_title": "é«˜äºŒæ•°å­¦ç»¼åˆæµ‹è¯•å·",
  "question_types": ["é€‰æ‹©é¢˜", "å¡«ç©ºé¢˜", "è§£ç­”é¢˜"],
  "difficulty": "ä¸­ç­‰",
  "total_score": 100,
  "duration_minutes": 90
}
```

### 7.6 è¿ç»­å¯¹è¯æ¨¡å—ï¼ˆV25.2ï¼‰

**ä¼šè¯ç®¡ç†ï¼š**
```python
# åç«¯ç»´æŠ¤ä¼šè¯çŠ¶æ€
chat_sessions = {
    "session_123": {
        "user_id": "user_456",
        "messages": [
            {"role": "user", "content": "è¿™é“é¢˜æ€ä¹ˆåšï¼Ÿ"},
            {"role": "assistant", "content": "æˆ‘æ¥å¸®ä½ åˆ†æ..."}
        ],
        "image_base64": "...",  # åˆå§‹ä¸Šä¼ çš„å›¾ç‰‡
        "created_at": "2025-10-30 14:00:00"
    }
}

# è¿ç»­å¯¹è¯æ—¶ï¼ŒAIèƒ½çœ‹åˆ°å®Œæ•´ä¸Šä¸‹æ–‡
messages_for_ai = session["messages"] + [
    {
        "role": "user",
        "content": [
            {"image": f"data:image/jpeg;base64,{session['image_base64']}"},
            {"text": new_user_input}
        ]
    }
]
```

**å¿«æ·æŒ‰é’®ï¼š**
```tsx
// å‰ç«¯å¿«æ·æé—®æŒ‰é’®
const quickButtons = [
  "ğŸ“ è¯·ç»§ç»­å›ç­”",
  "ğŸ” è¯¦ç»†è§£é‡Šä¸€ä¸‹",
  "ğŸ’¡ æ¢ä¸€ç§æ–¹æ³•",
  "ğŸ“Š æ€»ç»“ä¸€ä¸‹è¦ç‚¹"
];

{showQuickButtons && (
  <div className="quick-buttons">
    {quickButtons.map(btn => (
      <button onClick={() => sendQuickMessage(btn)}>
        {btn}
      </button>
    ))}
  </div>
)}
```

---

## APIæ¥å£æ–‡æ¡£

### 8.1 è®¤è¯æ¥å£

#### 8.1.1 ç”¨æˆ·æ³¨å†Œ
```
POST /auth/register
Content-Type: application/json

Request:
{
  "account": "student001",
  "password": "123456",
  "real_name": "å¼ ä¸‰",
  "student_id": "2024001",
  "grade": "é«˜äºŒ",
  "major": "ç†ç§‘"
}

Response (200):
{
  "success": true,
  "user_id": "uuid-xxxxx",
  "message": "æ³¨å†ŒæˆåŠŸï¼"
}

Error (400):
{
  "detail": "è´¦å·å·²å­˜åœ¨"
}
```

#### 8.1.2 ç”¨æˆ·ç™»å½•
```
POST /auth/login
Content-Type: application/json

Request:
{
  "account": "student001",
  "password": "123456"
}

Response (200):
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "user_info": {
    "user_id": "uuid-xxxxx",
    "account": "student001",
    "real_name": "å¼ ä¸‰",
    "grade": "é«˜äºŒ"
  }
}

Error (401):
{
  "detail": "è´¦å·æˆ–å¯†ç é”™è¯¯"
}
```

### 8.2 AIå¯¹è¯æ¥å£

#### 8.2.1 AIè§£é¢˜/æ‰¹æ”¹
```
POST /api/db/chat
Content-Type: multipart/form-data
Authorization: Bearer <token>

Request:
- mode: "solve" | "review"
- prompt: "è¯·è§£ç­”è¿™é“é¢˜"
- image: File (optional)
- image_base64: string (optional)
- session_id: string (optional, è¿ç»­å¯¹è¯)

Response (Streaming):
data: {"type": "start"}

data: {"type": "content", "content": "è®©æˆ‘æ¥å¸®ä½ åˆ†æè¿™é“é¢˜..."}

data: {"type": "content", "content": "è¿™é“é¢˜è€ƒæŸ¥çš„æ˜¯..."}

data: {"type": "done"}

Error (401):
{
  "detail": "æœªæˆæƒï¼Œè¯·å…ˆç™»å½•"
}
```

#### 8.2.2 è·å–ä¼šè¯åˆ—è¡¨
```
GET /api/db/sessions?mode=solve
Authorization: Bearer <token>

Response (200):
{
  "sessions": [
    {
      "session_id": "uuid-xxxxx",
      "title": "æ•°å­¦è§£é¢˜ä¼šè¯",
      "mode": "solve",
      "created_at": "2025-10-30T14:00:00",
      "message_count": 5
    }
  ]
}
```

### 8.3 é”™é¢˜æœ¬æ¥å£ï¼ˆV25.2ï¼‰

#### 8.3.1 è·å–é”™é¢˜åˆ—è¡¨
```
GET /api/v2/mistakes?subject_name=æ•°å­¦&grade=é«˜äºŒ&limit=100
Authorization: Bearer <token>

Response (200):
{
  "success": true,
  "mistakes": [
    {
      "subject_id": "uuid-xxxxx",
      "question_text": "è¯·æ‰¹æ”¹è¿™é“å…³äºä¸€å…ƒäºŒæ¬¡æ–¹ç¨‹çš„é¢˜ç›®",
      "image_base64": "/9j/4AAQSkZJRg...",
      "ai_analysis": "è¿™é“é¢˜çš„é”™è¯¯åœ¨äºå¯¹é…æ–¹æ³•çš„ç†è§£ä¸å¤Ÿæ·±å…¥...",
      "knowledge_points": ["ä¸€å…ƒäºŒæ¬¡æ–¹ç¨‹", "é…æ–¹æ³•"],
      "subject_name": "æ•°å­¦",
      "grade": "é«˜äºŒ",
      "difficulty": "ä¸­ç­‰",
      "review_count": 2,
      "created_at": "2025-10-30T14:00:00"
    }
  ],
  "total": 1
}
```

#### 8.3.2 é”™é¢˜ç»Ÿè®¡
```
GET /api/v2/mistakes/stats
Authorization: Bearer <token>

Response (200):
{
  "success": true,
  "stats": {
    "total_mistakes": 15,
    "by_subject": {
      "æ•°å­¦": 8,
      "ç‰©ç†": 5,
      "åŒ–å­¦": 2
    },
    "top_knowledge_points": [
      {"name": "ä¸€å…ƒäºŒæ¬¡æ–¹ç¨‹", "count": 3},
      {"name": "åŠ›å­¦åˆ†æ", "count": 2}
    ]
  }
}
```

### 8.4 è¯•å·ç”Ÿæˆæ¥å£ï¼ˆV25.2ï¼‰

#### 8.4.1 ç”Ÿæˆè¯•å·
```
POST /api/v2/papers/generate
Content-Type: application/json
Authorization: Bearer <token>

Request:
{
  "subject": "æ•°å­¦",
  "grade": "é«˜äºŒ",
  "paper_title": "é«˜äºŒæ•°å­¦ç»¼åˆæµ‹è¯•å·",
  "question_types": ["é€‰æ‹©é¢˜", "å¡«ç©ºé¢˜", "è§£ç­”é¢˜"],
  "difficulty": "ä¸­ç­‰",
  "total_score": 100.0,
  "duration_minutes": 90,
  "knowledge_points": ["å‡½æ•°", "å¯¼æ•°", "ä¸‰è§’å‡½æ•°"]
}

Response (200):
{
  "success": true,
  "exam_id": "uuid-xxxxx",
  "questions": [
    {
      "id": "uuid-yyyyy",
      "content": "é¢˜ç›®1çš„å†…å®¹...",
      "answer": "ç­”æ¡ˆå†…å®¹...",
      "explanation": "è§£æå†…å®¹...",
      "knowledge_points": ["å‡½æ•°"],
      "difficulty": "ä¸­ç­‰"
    }
  ],
  "total_questions": 10
}
```

---

## éƒ¨ç½²æŒ‡å—

### 9.1 ç¯å¢ƒè¦æ±‚

**ç¡¬ä»¶è¦æ±‚ï¼š**
- CPU: 2æ ¸å¿ƒ+
- å†…å­˜: 4GB+
- ç¡¬ç›˜: 10GB+

**è½¯ä»¶è¦æ±‚ï¼š**
- Python 3.13
- Node.js 18+
- MySQL 8.0
- Chrome/Edgeæµè§ˆå™¨ï¼ˆç”¨äºPDFå¯¼å‡ºï¼‰

### 9.2 åç«¯éƒ¨ç½²

#### Step 1: å®‰è£…Pythonç¯å¢ƒ
```bash
# Windows
# ä¸‹è½½Python 3.13å®‰è£…åŒ…å¹¶å®‰è£…

# Linux/Mac
sudo apt-get install python3.13 python3-pip
```

#### Step 2: åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
```bash
cd backend
python -m venv venv

# Windowsæ¿€æ´»
venv\Scripts\activate

# Linux/Macæ¿€æ´»
source venv/bin/activate
```

#### Step 3: å®‰è£…ä¾èµ–
```bash
pip install -r requirements.txt
```

#### Step 4: é…ç½®ç¯å¢ƒå˜é‡
åˆ›å»º `backend/.env` æ–‡ä»¶ï¼š
```env
# é˜¿é‡Œäº‘é€šä¹‰åƒé—®APIå¯†é’¥
DASHSCOPE_API_KEY=sk-your-api-key-here

# MySQLæ•°æ®åº“é…ç½®
DB_HOST=14.103.127.20
DB_PORT=3306
DB_USER=root
DB_PASSWORD=Jiuzhi#2024
DB_NAME=edu

# JWTå¯†é’¥ï¼ˆè‡ªå·±ç”Ÿæˆä¸€ä¸ªéšæœºå­—ç¬¦ä¸²ï¼‰
SECRET_KEY=your-secret-key-here
```

#### Step 5: åˆå§‹åŒ–æ•°æ®åº“
```bash
# æ–¹æ³•1ï¼šä½¿ç”¨Navicatæˆ–MySQL Workbench
# 1. è¿æ¥åˆ°MySQLæœåŠ¡å™¨
# 2. åˆ›å»ºeduæ•°æ®åº“
# 3. æ‰§è¡Œ backend/database_schema_upgrade.sql
# 4. æ‰§è¡Œ backend/database_schema_v25.2.sql

# æ–¹æ³•2ï¼šä½¿ç”¨å‘½ä»¤è¡Œ
mysql -h 14.103.127.20 -u root -p < database_schema_upgrade.sql
mysql -h 14.103.127.20 -u root -p < database_schema_v25.2.sql
```

#### Step 6: å¯åŠ¨åç«¯æœåŠ¡
```bash
# Windows
ã€å¯åŠ¨ã€‘æ•°æ®åº“ç‰ˆæœ¬ç³»ç»Ÿ.bat

# æˆ–æ‰‹åŠ¨å¯åŠ¨
cd backend
venv\Scripts\activate
python main_db.py

# Linux/Mac
uvicorn main_db:app --host 0.0.0.0 --port 8000 --reload
```

**é¢„æœŸè¾“å‡ºï¼š**
```
âœ… APIå¯†é’¥å·²åŠ è½½: sk-1d2f45c...
âœ… æ•°æ®åº“è¿æ¥æ± åˆå§‹åŒ–æˆåŠŸ (5ä¸ªè¿æ¥)
INFO: Uvicorn running on http://127.0.0.1:8000
```

### 9.3 å‰ç«¯éƒ¨ç½²

#### Step 1: å®‰è£…Node.js
```bash
# ä¸‹è½½å¹¶å®‰è£…Node.js 18+
# https://nodejs.org/
```

#### Step 2: å®‰è£…ä¾èµ–
```bash
cd frontend/vite-project
npm install
```

#### Step 3: é…ç½®APIåœ°å€
ç¼–è¾‘ `frontend/vite-project/src/utils/api.ts`ï¼š
```typescript
const API_BASE_URL = 'http://localhost:8000';  // å¼€å‘ç¯å¢ƒ
// const API_BASE_URL = 'https://your-domain.com';  // ç”Ÿäº§ç¯å¢ƒ
```

#### Step 4: å¯åŠ¨å¼€å‘æœåŠ¡å™¨
```bash
npm run dev
```

**é¢„æœŸè¾“å‡ºï¼š**
```
  VITE v7.1.6  ready in 500 ms

  âœ  Local:   http://localhost:5173/
  âœ  Network: http://192.168.1.100:5173/
```

#### Step 5: æ„å»ºç”Ÿäº§ç‰ˆæœ¬
```bash
npm run build

# æ„å»ºäº§ç‰©åœ¨ dist/ ç›®å½•
# å¯éƒ¨ç½²åˆ°Nginxã€Vercelã€Netlifyç­‰
```

### 9.4 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

#### ä½¿ç”¨Nginxéƒ¨ç½²å‰ç«¯
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    root /var/www/ai-solver/dist;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    location /api {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

#### ä½¿ç”¨systemdç®¡ç†åç«¯æœåŠ¡
```ini
# /etc/systemd/system/ai-solver.service
[Unit]
Description=AI Solver Backend
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/var/www/ai-solver/backend
Environment="PATH=/var/www/ai-solver/backend/venv/bin"
ExecStart=/var/www/ai-solver/backend/venv/bin/uvicorn main_db:app --host 0.0.0.0 --port 8000
Restart=always

[Install]
WantedBy=multi-user.target
```

å¯åŠ¨æœåŠ¡ï¼š
```bash
sudo systemctl daemon-reload
sudo systemctl enable ai-solver
sudo systemctl start ai-solver
sudo systemctl status ai-solver
```

### 9.5 Dockeréƒ¨ç½²ï¼ˆå¯é€‰ï¼‰

#### Dockerfileï¼ˆåç«¯ï¼‰
```dockerfile
FROM python:3.13-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

EXPOSE 8000

CMD ["uvicorn", "main_db:app", "--host", "0.0.0.0", "--port", "8000"]
```

#### docker-compose.yml
```yaml
version: '3.8'

services:
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}
    depends_on:
      - mysql
    
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: Jiuzhi#2024
      MYSQL_DATABASE: edu
    volumes:
      - mysql_data:/var/lib/mysql
    ports:
      - "3306:3306"
    
  frontend:
    image: nginx:alpine
    volumes:
      - ./frontend/vite-project/dist:/usr/share/nginx/html
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
    ports:
      - "80:80"
    depends_on:
      - backend

volumes:
  mysql_data:
```

å¯åŠ¨ï¼š
```bash
docker-compose up -d
```

---

## å¼€å‘æŒ‡å—

### 10.1 å¼€å‘ç¯å¢ƒæ­å»º

1. **å…‹éš†é¡¹ç›®**ï¼ˆå¦‚æœæœ‰Gitä»“åº“ï¼‰
```bash
git clone <repository-url>
cd ai-solver-mvp
```

2. **åç«¯å¼€å‘**
```bash
cd backend
python -m venv venv
venv\Scripts\activate  # Windows
pip install -r requirements.txt

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼ˆè‡ªåŠ¨é‡è½½ï¼‰
python main_db.py
```

3. **å‰ç«¯å¼€å‘**
```bash
cd frontend/vite-project
npm install
npm run dev  # å¯åŠ¨Viteå¼€å‘æœåŠ¡å™¨
```

### 10.2 æ·»åŠ æ–°API

#### Step 1: å®šä¹‰è¯·æ±‚/å“åº”æ¨¡å‹
```python
# main_db.py
from pydantic import BaseModel

class NewFeatureRequest(BaseModel):
    param1: str
    param2: int
    
class NewFeatureResponse(BaseModel):
    success: bool
    data: dict
```

#### Step 2: å®ç°APIè·¯ç”±
```python
@app.post("/api/v2/new-feature", response_model=NewFeatureResponse)
async def new_feature(
    request: NewFeatureRequest,
    user: dict = Depends(get_current_user)
):
    """æ–°åŠŸèƒ½API"""
    user_id = user["user_id"]
    
    try:
        # ä¸šåŠ¡é€»è¾‘
        result = process_new_feature(request.param1, request.param2)
        
        return NewFeatureResponse(
            success=True,
            data=result
        )
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

#### Step 3: å‰ç«¯è°ƒç”¨
```typescript
// utils/api.ts
export const newFeatureApi = {
  execute: async (param1: string, param2: number) => {
    return authenticatedFetch('/api/v2/new-feature', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ param1, param2 })
    });
  }
};

// ç»„ä»¶ä¸­ä½¿ç”¨
const handleNewFeature = async () => {
  const response = await newFeatureApi.execute('test', 123);
  const data = await response.json();
  console.log(data);
};
```

### 10.3 æ•°æ®åº“è¿ç§»

#### æ·»åŠ æ–°å­—æ®µ
```sql
-- æ–°å»ºè¿ç§»è„šæœ¬ database_migration_vX.X.sql
USE edu;

ALTER TABLE subject 
ADD COLUMN new_field VARCHAR(100) DEFAULT NULL 
COMMENT 'æ–°å­—æ®µè¯´æ˜';

-- æ·»åŠ ç´¢å¼•ï¼ˆå¦‚æœéœ€è¦ï¼‰
CREATE INDEX idx_new_field ON subject(new_field);
```

#### åœ¨ä»£ç ä¸­ä½¿ç”¨
```python
# database.py
def get_subjects_with_new_field(user_id: str):
    with get_db_connection() as conn:
        cursor = conn.cursor()
        cursor.execute("""
            SELECT subject_id, subject_title, new_field
            FROM subject
            WHERE user_id = %s
        """, (user_id,))
        return cursor.fetchall()
```

### 10.4 è°ƒè¯•æŠ€å·§

#### åç«¯è°ƒè¯•
```python
# æ·»åŠ è¯¦ç»†æ—¥å¿—
import logging
logging.basicConfig(level=logging.DEBUG)

# åœ¨å…³é”®ä½ç½®æ·»åŠ print
print(f"[è°ƒè¯•] å˜é‡å€¼: {variable}")
print(f"[è°ƒè¯•] è¯·æ±‚å‚æ•°: {request.dict()}")

# ä½¿ç”¨VSCodeè°ƒè¯•å™¨
# 1. è®¾ç½®æ–­ç‚¹
# 2. F5å¯åŠ¨è°ƒè¯•
# 3. åœ¨æµè§ˆå™¨è§¦å‘APIè°ƒç”¨
```

#### å‰ç«¯è°ƒè¯•
```tsx
// ä½¿ç”¨console.log
console.log('[è°ƒè¯•] ç»„ä»¶çŠ¶æ€:', { mistakes, questions });

// ä½¿ç”¨React DevTools
// 1. å®‰è£…Chromeæ‰©å±•
// 2. F12æ‰“å¼€å¼€å‘è€…å·¥å…·
# 3. åˆ‡æ¢åˆ°Reactæ ‡ç­¾é¡µ

// ç½‘ç»œè¯·æ±‚è°ƒè¯•
// F12 -> Network -> æŸ¥çœ‹APIè¯·æ±‚å’Œå“åº”
```

### 10.5 å¸¸è§é—®é¢˜

#### é—®é¢˜1ï¼šæ•°æ®åº“è¿æ¥è¶…æ—¶
```
Error: (2013, 'Lost connection to MySQL server during query')
```

**è§£å†³ï¼š**
- æ£€æŸ¥MySQLæœåŠ¡æ˜¯å¦è¿è¡Œ
- æ£€æŸ¥é˜²ç«å¢™æ˜¯å¦å…è®¸3306ç«¯å£
- å¢åŠ è¶…æ—¶æ—¶é—´ï¼š`DB_CONFIG['connect_timeout'] = 30`

#### é—®é¢˜2ï¼šJWT Tokenè¿‡æœŸ
```
Error: 401 Unauthorized
```

**è§£å†³ï¼š**
- å‰ç«¯é‡æ–°ç™»å½•è·å–æ–°Token
- å¢åŠ Tokenæœ‰æ•ˆæœŸï¼š`expires_delta=timedelta(days=30)`

#### é—®é¢˜3ï¼šMathJaxå…¬å¼ä¸æ¸²æŸ“
```
å…¬å¼æ˜¾ç¤ºä¸ºLaTeXæºä»£ç 
```

**è§£å†³ï¼š**
```tsx
// 1. ç¡®ä¿MathJaxè„šæœ¬å·²åŠ è½½
console.log('MathJax:', window.MathJax);

// 2. æ‰‹åŠ¨è§¦å‘æ¸²æŸ“
window.MathJax?.typesetPromise();

// 3. å¢åŠ æ¸²æŸ“å»¶è¿Ÿ
setTimeout(() => {
  window.MathJax?.typesetPromise();
}, 500);
```

#### é—®é¢˜4ï¼šå›¾ç‰‡ä¸Šä¼ å¤±è´¥
```
Error: 413 Request Entity Too Large
```

**è§£å†³ï¼š**
```tsx
// å‰ç«¯å‹ç¼©å›¾ç‰‡
const compressImage = (file: File, maxWidth = 1920) => {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        let width = img.width;
        let height = img.height;
        
        if (width > maxWidth) {
          height = (height * maxWidth) / width;
          width = maxWidth;
        }
        
        canvas.width = width;
        canvas.height = height;
        ctx.drawImage(img, 0, 0, width, height);
        
        canvas.toBlob((blob) => resolve(blob), 'image/jpeg', 0.8);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
};
```

---

## ç‰ˆæœ¬å†å²

### V25.2ï¼ˆ2025-10-30ï¼‰- åŠŸèƒ½å¢å¼ºç‰ˆ

**æ–°å¢åŠŸèƒ½ï¼š**
- âœ… è¿ç»­å¯¹è¯æ”¯æŒï¼ˆAIè®°å¿†ä¸Šä¸‹æ–‡ï¼‰
- âœ… é”™é¢˜è‡ªåŠ¨ä¿å­˜åˆ°é”™é¢˜æœ¬
- âœ… é”™é¢˜æœ¬å­¦ç§‘ã€å¹´çº§ç­›é€‰
- âœ… è¯•å·ç”Ÿæˆæ”¯æŒå­¦ç§‘å’Œå¹´çº§é€‰æ‹©
- âœ… çŸ¥è¯†ç‚¹æ™ºèƒ½æå–å’Œæ ‡ç­¾åŒ–
- âœ… å®Œæ•´çš„å…¬å¼æ¸²æŸ“ä¿®å¤

**æ•°æ®åº“å˜æ›´ï¼š**
- æ–°å¢ `chat_session` è¡¨
- æ–°å¢ `chat_history` è¡¨
- `subject` è¡¨æ–°å¢å­—æ®µï¼š`user_mistake_text`, `mistake_analysis`, `review_count`, `last_review_at`
- `exam` è¡¨æ–°å¢å­—æ®µï¼š`subject`, `grade`

**APIæ›´æ–°ï¼š**
- æ–°å¢ `/api/v2/mistakes`ï¼ˆé”™é¢˜æŸ¥è¯¢APIï¼‰
- æ–°å¢ `/api/v2/mistakes/stats`ï¼ˆé”™é¢˜ç»Ÿè®¡APIï¼‰
- æ–°å¢ `/api/v2/papers/generate`ï¼ˆè¯•å·ç”ŸæˆAPIï¼‰
- å¢å¼º `/api/db/chat`ï¼ˆæ”¯æŒè¿ç»­å¯¹è¯å’Œé”™é¢˜è‡ªåŠ¨ä¿å­˜ï¼‰

### V25.1ï¼ˆ2025-10ï¼‰- MySQLæ•°æ®åº“é›†æˆ

**æ ¸å¿ƒå˜æ›´ï¼š**
- âœ… ä»SQLiteè¿ç§»åˆ°MySQL
- âœ… å®ç°æ•°æ®åº“è¿æ¥æ± 
- âœ… JWTè®¤è¯ç³»ç»Ÿ
- âœ… é”™é¢˜æœ¬å’Œå‡ºé¢˜åŠŸèƒ½

**æ•°æ®åº“æ¶æ„ï¼š**
- `user`ï¼ˆç”¨æˆ·è¡¨ï¼‰
- `subject`ï¼ˆé¢˜ç›®è¡¨ï¼‰
- `exam`ï¼ˆè¯•å·è¡¨ï¼‰
- `user_exam`ï¼ˆç­”é¢˜è®°å½•è¡¨ï¼‰

### V25.0ï¼ˆ2025-10ï¼‰- å®Œæ•´ç³»ç»Ÿå‡çº§

**åŠŸèƒ½ï¼š**
- âœ… AIè§£é¢˜
- âœ… AIæ‰¹æ”¹ä½œä¸š
- âœ… é”™é¢˜æœ¬åŸºç¡€åŠŸèƒ½
- âœ… æ™ºèƒ½å‡ºé¢˜
- âœ… å¾®ä¿¡å°ç¨‹åºAPI

### V24.xï¼ˆ2025-10ä¹‹å‰ï¼‰- æœ¬åœ°ç‰ˆæœ¬

**ç‰¹æ€§ï¼š**
- åŸºäºSQLiteçš„æœ¬åœ°å­˜å‚¨
- ç®€åŒ–çš„é”™é¢˜æœ¬ç³»ç»Ÿ
- åŸºç¡€çš„AIè§£é¢˜åŠŸèƒ½

---

## é™„å½•

### A. æŠ€æœ¯æœ¯è¯­è¡¨

| æœ¯è¯­ | è¯´æ˜ |
|------|------|
| **FastAPI** | ç°ä»£Python Webæ¡†æ¶ï¼Œæ”¯æŒå¼‚æ­¥å’Œè‡ªåŠ¨æ–‡æ¡£ç”Ÿæˆ |
| **JWT** | JSON Web Tokenï¼Œç”¨äºæ— çŠ¶æ€è®¤è¯ |
| **OCR** | å…‰å­¦å­—ç¬¦è¯†åˆ«ï¼Œå°†å›¾ç‰‡ä¸­çš„æ–‡å­—è½¬æ¢ä¸ºå¯ç¼–è¾‘æ–‡æœ¬ |
| **MathJax** | æµè§ˆå™¨ç«¯LaTeXæ•°å­¦å…¬å¼æ¸²æŸ“å¼•æ“ |
| **é€šä¹‰åƒé—®** | é˜¿é‡Œäº‘å¤§è¯­è¨€æ¨¡å‹ï¼Œæ”¯æŒå¤šæ¨¡æ€ç†è§£ |
| **Vite** | ä¸‹ä¸€ä»£å‰ç«¯æ„å»ºå·¥å…·ï¼Œæé€Ÿå¼€å‘ä½“éªŒ |
| **InnoDB** | MySQLäº‹åŠ¡å‹å­˜å‚¨å¼•æ“ï¼Œæ”¯æŒå¤–é”®å’Œè¡Œçº§é” |

### B. é¡¹ç›®æŒ‡æ ‡

**ä»£ç ç»Ÿè®¡ï¼š**
- åç«¯ä»£ç ï¼šçº¦8000è¡Œ
- å‰ç«¯ä»£ç ï¼šçº¦5000è¡Œ
- æ•°æ®åº“è¡¨ï¼š6ä¸ªæ ¸å¿ƒè¡¨
- APIæ¥å£ï¼š30+ endpoints

**æ€§èƒ½æŒ‡æ ‡ï¼š**
- APIå“åº”æ—¶é—´ï¼š< 100ms
- AIæ¨ç†æ—¶é—´ï¼š2-5ç§’
- å…¬å¼æ¸²æŸ“æ—¶é—´ï¼š< 200ms
- å›¾ç‰‡ä¸Šä¼ é™åˆ¶ï¼š10MB

**æ”¯æŒè§„æ¨¡ï¼š**
- å¹¶å‘ç”¨æˆ·ï¼š100+
- æ•°æ®åº“è¿æ¥æ± ï¼š5ä¸ªè¿æ¥
- é”™é¢˜å­˜å‚¨ï¼šæ— é™åˆ¶
- ä¼šè¯ä¿ç•™ï¼šæ°¸ä¹…

### C. å‚è€ƒèµ„æ–™

**å®˜æ–¹æ–‡æ¡£ï¼š**
- [FastAPIæ–‡æ¡£](https://fastapi.tiangolo.com/)
- [Reactæ–‡æ¡£](https://react.dev/)
- [MySQLæ–‡æ¡£](https://dev.mysql.com/doc/)
- [é€šä¹‰åƒé—®APIæ–‡æ¡£](https://help.aliyun.com/zh/dashscope/)

**ç›¸å…³æŠ€æœ¯ï¼š**
- [MathJaxä½¿ç”¨æŒ‡å—](https://www.mathjax.org/)
- [Pix2Textæ–‡æ¡£](https://github.com/breezedeus/Pix2Text)
- [PyMySQLæ–‡æ¡£](https://pymysql.readthedocs.io/)

---

## è”ç³»æ–¹å¼

**é¡¹ç›®ç»´æŠ¤ï¼š** æ²æ¢§AIè§£é¢˜ç³»ç»Ÿå¼€å‘å›¢é˜Ÿ  
**æŠ€æœ¯æ”¯æŒï¼š** è¯·æäº¤Issueæˆ–Pull Request  
**æœ€åæ›´æ–°ï¼š** 2025-10-30

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** V2.0  
**å¯¹åº”ç³»ç»Ÿç‰ˆæœ¬ï¼š** V25.2

Â© 2025 æ²æ¢§AIè§£é¢˜ç³»ç»Ÿ. All Rights Reserved.

