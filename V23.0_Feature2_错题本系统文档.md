# V23.0 Feature 2: 个性化错题本系统 - 完整文档

## 📚 功能概述

**Feature 2** 实现了一个完整的**个性化错题本系统**，能够：
- ✅ **自动检测错题**：AI批改时自动识别错误答案
- ✅ **手动管理错题**：创建、查看、更新、删除错题
- ✅ **智能分类**：按学科、知识点、难度分类
- ✅ **复习跟踪**：记录复习状态和复习次数
- ✅ **统计分析**：错题数量、学科分布、复习进度

---

## 🏗️ 技术架构

### 1. 数据库模型 (`models.py`)

```python
class Mistake(Base):
    """错题模型"""
    __tablename__ = "mistakes"
    
    # 基础信息
    id = Column(Integer, primary_key=True, index=True)
    owner_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    
    # 题目内容
    question_text = Column(Text, nullable=False)  # 题目文字
    wrong_answer = Column(Text, nullable=True)    # 错误答案
    original_image_base64 = Column(Text, nullable=True)  # 题目图片
    
    # AI分析
    ai_analysis = Column(Text, nullable=False)  # AI批改分析
    
    # 分类标签
    subject = Column(String(50), nullable=True)  # 学科
    knowledge_points = Column(Text, nullable=True)  # 知识点（JSON）
    difficulty = Column(Integer, nullable=True)  # 难度1-5
    
    # 复习状态
    reviewed = Column(Boolean, default=False)  # 是否已复习
    review_count = Column(Integer, default=0)  # 复习次数
    
    # 时间戳
    created_at = Column(DateTime, default=datetime.utcnow)
    last_reviewed_at = Column(DateTime, nullable=True)
```

**字段说明**：
- `question_text`: 题目内容（OCR识别或用户输入）
- `wrong_answer`: 学生的错误答案
- `original_image_base64`: 原始题目截图（Base64编码）
- `ai_analysis`: AI的详细批改分析
- `knowledge_points`: JSON数组，如 `["函数", "导数"]`
- `difficulty`: 1-5的难度等级
- `reviewed`: 是否已复习（用于筛选）
- `review_count`: 累计复习次数

---

### 2. API路由 (`mistake_routes.py`)

#### 🔹 创建错题
```http
POST /mistakes/
Authorization: Bearer {token}
Content-Type: application/json

{
  "question_text": "计算 1 + 1 的值",
  "wrong_answer": "3",
  "ai_analysis": "这道题答错了。正确答案是2。",
  "subject": "数学",
  "knowledge_points": ["加法", "基础运算"],
  "difficulty": 1
}
```

**响应（201 Created）**:
```json
{
  "id": 1,
  "owner_id": 1,
  "question_text": "计算 1 + 1 的值",
  "wrong_answer": "3",
  "ai_analysis": "这道题答错了。正确答案是2。",
  "subject": "数学",
  "knowledge_points": "[\"加法\", \"基础运算\"]",
  "difficulty": 1,
  "reviewed": false,
  "review_count": 0,
  "created_at": "2025-10-18T10:30:00",
  "last_reviewed_at": null,
  "has_image": false
}
```

---

#### 🔹 获取错题列表（分页+筛选）
```http
GET /mistakes/?page=1&page_size=20&subject=数学&reviewed=false
Authorization: Bearer {token}
```

**查询参数**:
- `page`: 页码（默认1）
- `page_size`: 每页数量（默认20，最大100）
- `subject`: 筛选学科（可选）
- `reviewed`: 筛选复习状态（可选，true/false）

**响应（200 OK）**:
```json
{
  "total": 15,
  "page": 1,
  "page_size": 20,
  "mistakes": [
    {
      "id": 1,
      "question_text": "...",
      "subject": "数学",
      "reviewed": false,
      "review_count": 0,
      "created_at": "2025-10-18T10:30:00",
      "has_image": true
    }
  ]
}
```

---

#### 🔹 获取错题详情（含图片）
```http
GET /mistakes/1
Authorization: Bearer {token}
```

**响应（200 OK）**:
```json
{
  "id": 1,
  "question_text": "计算 1 + 1 的值",
  "wrong_answer": "3",
  "ai_analysis": "这道题答错了。正确答案是2。",
  "original_image_base64": "data:image/png;base64,iVBORw0KGgo...",
  "subject": "数学",
  "knowledge_points": "[\"加法\", \"基础运算\"]",
  "difficulty": 1,
  "reviewed": false,
  "review_count": 0,
  "created_at": "2025-10-18T10:30:00",
  "last_reviewed_at": null,
  "has_image": true
}
```

---

#### 🔹 标记为已复习
```http
PUT /mistakes/1
Authorization: Bearer {token}
Content-Type: application/json

{
  "reviewed": true
}
```

**响应（200 OK）**:
```json
{
  "id": 1,
  "reviewed": true,
  "review_count": 1,
  "last_reviewed_at": "2025-10-18T11:00:00",
  ...
}
```

---

#### 🔹 删除错题
```http
DELETE /mistakes/1
Authorization: Bearer {token}
```

**响应（200 OK）**:
```json
{
  "message": "错题已删除",
  "mistake_id": 1
}
```

---

#### 🔹 获取统计信息
```http
GET /mistakes/stats/summary
Authorization: Bearer {token}
```

**响应（200 OK）**:
```json
{
  "total": 15,
  "reviewed": 5,
  "not_reviewed": 10,
  "review_progress": 33.3,
  "by_subject": {
    "数学": 10,
    "物理": 3,
    "化学": 2
  }
}
```

---

### 3. 自动错题检测机制

#### 🔥 核心创新：AI批改时自动识别错题

**实现原理**：
1. **检测批改模式**：系统检查用户prompt中是否包含`["批改", "改", "检查", "对错"]`关键词
2. **特殊Prompt**：在批改模式下，指示AI在回答开头添加标记：
   - `[MISTAKE_DETECTED]` - 发现错误
   - `[CORRECT]` - 完全正确
3. **后端解析**：检测AI回答中的标记，记录日志

**代码位置**：`backend/main.py` (lines 336-371)

```python
# 检测批改模式
is_review_mode = any(keyword in request.prompt for keyword in ["批改", "改", "检查", "对错"])

if is_review_mode:
    # 批改模式特殊Prompt
    enhanced_prompt = f"""...
    【特别要求】（批改模式）
    如果学生的答案有错误，请在回答的开头加上特殊标记：[MISTAKE_DETECTED]
    如果学生的答案完全正确，请在回答的开头加上：[CORRECT]
    然后再给出详细的批改意见。
    """
```

**检测逻辑**：`backend/main.py` (lines 460-498)

```python
# 检测错误标记
has_mistake = "[MISTAKE_DETECTED]" in full_response
is_correct = "[CORRECT]" in full_response

if has_mistake:
    print(f"[错题检测] ✅ 检测到错误！")
    # 可以自动保存错题（需要用户认证）
```

---

## 📊 日志输出示例

Feature 2 添加了大量调试日志，便于快速定位问题：

```
[错题创建] 收到创建请求
[错题创建] 用户: test_student (id=1)
[错题创建] 学科: 数学
[错题创建] 题目长度: 15 字符
[错题创建] 知识点: ['加法', '基础运算']
[错题创建] 正在保存到数据库...
[错题创建] ✅ 错题保存成功! id=1

[错题列表] 收到请求
[错题列表] 用户: test_student (id=1)
[错题列表] 页码: 1, 每页: 20
[错题列表] 筛选条件 - 学科: 数学, 已复习: False
[错题列表] 筛选学科: 数学
[错题列表] 总计: 10 条错题
[错题列表] 返回: 10 条错题 (第1页)
[错题列表] ✅ 数据准备完成

============================================================
【Feature 2: 错题检测】
============================================================
[错题检测] 是否批改模式: True
[错题检测] 发现错误标记: True
[错题检测] 完全正确标记: False
[错题检测] ✅ 检测到错误！准备保存错题...
[错题检测] ⚠️ 注意：当前/chat接口未集成用户认证
[错题检测] 💡 提示：可以手动调用 POST /mistakes 接口保存错题
============================================================
```

---

## 🧪 测试指南

### 1. 运行自动化测试
```bash
cd backend
python test_feature2_mistakes.py
```

### 2. 手动测试流程

#### Step 1: 登录获取Token
```bash
curl -X POST http://127.0.0.1:8000/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username": "test_student", "password": "password123"}'
```

保存返回的`access_token`

#### Step 2: 创建错题
```bash
curl -X POST http://127.0.0.1:8000/mistakes/ \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "question_text": "解方程 x + 5 = 10",
    "wrong_answer": "x = 3",
    "ai_analysis": "错误！正确答案是 x = 5",
    "subject": "数学",
    "knowledge_points": ["方程", "一元一次方程"],
    "difficulty": 2
  }'
```

#### Step 3: 查看错题列表
```bash
curl -X GET "http://127.0.0.1:8000/mistakes/?page=1&page_size=10" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### Step 4: 标记为已复习
```bash
curl -X PUT http://127.0.0.1:8000/mistakes/1 \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"reviewed": true}'
```

#### Step 5: 查看统计
```bash
curl -X GET http://127.0.0.1:8000/mistakes/stats/summary \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

## 🔐 认证与权限

**必需**：所有错题本API都需要JWT认证

**权限规则**：
- 用户只能访问自己的错题
- 后端自动过滤：`Mistake.owner_id == current_user.id`
- 尝试访问他人错题会返回404

**错误响应**：
```json
{
  "detail": "Not authenticated"
}
```

---

## 📝 知识点JSON格式

知识点以JSON数组形式存储：

**输入**（API请求）:
```json
{
  "knowledge_points": ["函数", "导数", "极值"]
}
```

**存储**（数据库）:
```
"[\"函数\", \"导数\", \"极值\"]"
```

**解析**（前端）:
```javascript
const points = JSON.parse(mistake.knowledge_points);
// ["函数", "导数", "极值"]
```

---

## 🚀 使用场景

### 场景1：学生批改作业
1. 学生上传作业照片
2. 在prompt中包含"批改"关键词
3. AI回答开头包含 `[MISTAKE_DETECTED]`
4. 后端自动检测并记录日志
5. 学生手动调用API保存错题

### 场景2：查看未复习错题
```http
GET /mistakes/?reviewed=false&subject=数学
```

### 场景3：复习错题
1. 获取未复习错题列表
2. 逐个查看错题详情（含图片）
3. 复习后标记为已复习
4. 系统自动增加`review_count`

### 场景4：分析薄弱知识点
```http
GET /mistakes/stats/summary
```
查看各学科错题分布，识别薄弱环节

---

## 🔧 技术细节

### 1. 图片存储策略
- **存储位置**：数据库（Text类型字段）
- **格式**：Base64编码字符串
- **优点**：简单，无需额外文件管理
- **缺点**：数据库体积较大
- **优化建议**：生产环境可改为对象存储（如OSS）

### 2. 分页性能优化
- 使用SQLAlchemy的`offset().limit()`
- 在`owner_id`、`subject`、`created_at`字段创建索引
- 按创建时间倒序排列（`order_by(created_at.desc())`）

### 3. 错误处理
所有API都包含完整的错误处理：
- `404`: 错题不存在或无权访问
- `401`: 未认证
- `422`: 参数验证失败

### 4. 日志系统
每个关键步骤都有日志输出：
- `[错题创建]`：创建过程
- `[错题列表]`：查询过程
- `[错题详情]`：详情获取
- `[错题更新]`：更新过程
- `[错题删除]`：删除过程
- `[错题统计]`：统计计算
- `[错题检测]`：自动检测过程

---

## 📦 依赖包

无需新增依赖，Feature 2完全基于已有技术栈：
- FastAPI：路由和依赖注入
- SQLAlchemy：ORM和数据库操作
- Pydantic：数据验证
- JWT：用户认证

---

## 🐛 调试技巧

### 1. 检查错题是否保存
```bash
# 直接查看数据库
sqlite3 backend/app.db
SELECT * FROM mistakes;
```

### 2. 查看后端日志
运行后端时观察控制台输出，搜索关键词：
- `[错题创建]`
- `[Feature 2: 错题检测]`

### 3. 测试批改模式
在前端prompt中明确写"批改"，观察后端日志是否显示：
```
[混合输入架构] 是否批改模式: True
[混合输入架构] 使用批改模式Prompt（包含错题检测标记）
```

---

## 🎯 下一步：Feature 3

Feature 2 已完成！准备进入 **Feature 3: 知识点生成与智能出题**

**Feature 3 核心功能**：
1. 从错题中提炼知识点
2. 基于知识点生成新题
3. 支持题型和难度定制

---

## 📞 常见问题

### Q1: 为什么错题检测不自动保存？
A: 当前`/chat`接口未集成用户认证，无法自动保存。需要用户登录后，手动调用`POST /mistakes`接口。未来版本会增强自动保存功能。

### Q2: 知识点列表为什么是字符串？
A: 数据库存储为JSON字符串，前后端需要手动`JSON.parse()`和`JSON.stringify()`。

### Q3: 如何删除多个错题？
A: 目前只支持单个删除，批量删除可以通过循环调用实现。

### Q4: 复习次数如何增加？
A: 每次调用`PUT /mistakes/{id}`并设置`reviewed: true`时，`review_count`自动+1。

---

## ✅ Feature 2 交付清单

- [x] 数据库模型（Mistake）
- [x] API路由（CRUD + 统计）
- [x] 用户认证集成
- [x] 批改模式检测
- [x] 错题自动识别机制
- [x] 分页和筛选功能
- [x] 复习状态跟踪
- [x] 统计分析功能
- [x] 完整日志输出
- [x] 自动化测试脚本
- [x] 完整技术文档

**状态**：✅ **Feature 2 开发完成！**

---

**开发团队**：Claude 3.5 Sonnet（首席全栈架构师）  
**项目名称**：沐梧AI V23.0-F2  
**最后更新**：2025-10-18

